<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­—éˆçµäººï¼šå²è©©äº¤éŸ¿ç‰ˆ (V40)</title>
    <script src="moe_data.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');

        :root {
            --bg-dark: #0f0f10;
            --panel-bg: rgba(25, 25, 30, 0.98);
            --primary: #c23616;
            --accent: #fbc531;
            --luck: #00d2d3;
            --text: #f5f6fa;
            --font-main: 'Noto Serif TC', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text);
            margin: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
            background: radial-gradient(circle at 50% 30%, #1e0505 0%, #000 100%);
        }

        .embers {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: -1;
            background-image: radial-gradient(rgba(194, 54, 22, 0.3) 1px, transparent 1px);
            background-size: 50px 50px; animation: rise 25s linear infinite; opacity: 0.5;
        }
        @keyframes rise { from {transform: translateY(0);} to {transform: translateY(-600px);} }

        .app-container {
            width: 100%; max-width: 550px; height: 100%; max-height: 950px;
            background: var(--panel-bg); border: 2px solid #571a1a;
            box-shadow: 0 0 80px rgba(194, 54, 22, 0.3); position: relative;
            display: flex; flex-direction: column; overflow: hidden;
        }
        @media (min-width: 550px) { .app-container { border-radius: 12px; height: 95vh; } }

        /* UI Components */
        .top-bar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
        .gems { color: var(--accent); font-size: 1.2rem; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        
        .content { flex: 1; overflow-y: auto; padding: 15px; position: relative; scroll-behavior: smooth; }
        .tab-page { display: none; animation: fadeIn 0.4s; }
        .tab-page.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        .start-btn {
            background: linear-gradient(135deg, #c23616, #8e44ad);
            color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 12px 25px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            letter-spacing: 1px; width: 100%;
            box-shadow: 0 0 15px rgba(194, 54, 22, 0.5); border-radius: 4px;
        }
        .start-btn:active { transform: scale(0.96); filter: brightness(0.8); }
        .btn-secondary { background: #34495e; box-shadow: none; border-color: #57606f; }
        .btn-dict { background: #27ae60; margin-bottom: 8px; border-color: #2ecc71; }

        /* Character Creation */
        .char-select-container { display: flex; flex-direction: column; gap: 10px; height: 350px; overflow-y: auto; margin: 15px 0; padding-right: 5px; }
        .char-card {
            display: flex; align-items: center; background: rgba(255,255,255,0.05); 
            border: 1px solid #444; border-radius: 8px; padding: 10px; cursor: pointer; transition: 0.2s;
        }
        .char-card.selected { border-color: var(--accent); background: rgba(251, 197, 49, 0.15); box-shadow: 0 0 10px rgba(251,197,49,0.3); }
        .char-card-icon { font-size: 2.5rem; margin-right: 15px; }
        .char-card-info { flex: 1; text-align: left; }
        .char-card-name { font-weight: bold; font-size: 1.1rem; color: #fff; }
        .char-card-job { font-size: 0.8rem; color: var(--accent); margin-bottom: 2px; }
        .char-card-desc { font-size: 0.7rem; color: #aaa; }

        /* Stats & Equipment */
        .hero-summary { display:flex; align-items:center; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #333; }
        .hero-avatar { font-size: 3.5rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        .hero-info { flex:1; }
        .xp-container { width: 100%; background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top:5px; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #8e44ad, #9b59b6); width: 0%; transition: width 0.5s; }

        .stat-box { background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #333; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        
        .equip-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; 
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333;
        }
        .equip-slot {
            aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.2s;
            opacity: 0.5; filter: grayscale(1);
        }
        .slot-equipped { 
            border-color: var(--accent); background: rgba(251, 197, 49, 0.15); 
            opacity: 1; filter: none; box-shadow: inset 0 0 10px rgba(251, 197, 49, 0.2);
        }
        .slot-icon { font-size: 1.6rem; }
        .slot-name { font-size: 0.6rem; color: #7f8fa6; margin-top: 2px; }
        .slot-equipped .slot-name { color: #fff; font-weight: bold; }

        /* Inventory Items */
        .inv-item { display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 5px; border-left: 3px solid #555; border-radius: 4px; }
        .inv-actions { margin-left: auto; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .btn-action { padding: 6px 10px; border: 1px solid #555; color: white; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 0.75rem; min-width: 60px; }
        .btn-equip { background: #353b48; }
        .btn-sell { background: #2c3e50; border-color: #c0392b; color: #e74c3c; }

        /* Battle UI */
        .hp-bar-container { width:100%; height:12px; background:#111; border:1px solid #444; border-radius:2px; overflow:hidden; margin-bottom:2px; }
        .hp-fill { height:100%; width:100%; transition:width 0.3s; }
        .quiz-panel { background: rgba(30, 30, 35, 0.95); border: 1px solid #571a1a; padding: 20px; margin-top: 5px; border-radius: 8px; }
        .opt-btn { width: 100%; padding: 14px; margin-bottom: 8px; background: #2f3640; border: 1px solid #57606f; color: #dcdde1; font-size: 1.2rem; cursor: pointer; font-family: "KaiTi"; font-weight: bold; border-radius: 6px; }
        #battle-tools { display:none; justify-content:center; gap:10px; margin-top:15px; flex-wrap: wrap; }
        .tool-btn { flex: 1; padding: 10px; font-size: 0.9rem; background: #34495e; min-width: 80px; }
        .flee-btn { background: #444; border-color: #7f8fa6; color: #a4b0be; flex: 0 0 100%; margin-top: 5px; }
        #post-answer-actions { display: none; flex-direction: column; gap: 8px; margin-top: 10px; }
        
        .battle-prep-panel { text-align: center; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 8px; border: 1px solid #444; margin-top: 10px; }
        .monster-rates-table { width: 100%; margin: 15px 0; border-collapse: collapse; font-size: 0.9rem; }
        .monster-rates-table td { padding: 8px; border-bottom: 1px solid #333; text-align: left; }

        .nav-bar { display: flex; background: #000; border-top: 1px solid #333; height: 60px; }
        .nav-btn { flex: 1; background: none; border: none; color: #555; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
        .nav-btn.active { color: var(--primary); background: rgba(194, 54, 22, 0.1); }

        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { background: #1e272e; width: 85%; max-width: 400px; padding: 30px; border: 1px solid var(--primary); text-align: center; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .float-txt { position: absolute; left: 50%; top: 40%; transform: translateX(-50%); font-weight:bold; pointer-events: none; animation: popUp 0.8s forwards; z-index: 150; text-shadow: 2px 2px 0 #000; }
        @keyframes popUp { 0%{opacity:0; transform:translate(-50%,0) scale(0.5);} 20%{opacity:1; transform:translate(-50%,-50px) scale(1.5);} 100%{opacity:0; transform:translate(-50%,-100px) scale(1);} }

        #cover-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }

        .daily-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .daily-day { background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 6px; padding: 8px; text-align: center; position: relative; opacity: 0.6; }
        .daily-day.active { border-color: var(--accent); opacity: 1; background: rgba(251, 197, 49, 0.1); transform: scale(1.05); box-shadow: 0 0 10px rgba(251,197,49,0.2); }
        .daily-day.claimed { border-color: #2ecc71; opacity: 0.4; filter: grayscale(1); }
        .daily-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .daily-txt { font-size: 0.6rem; color: #aaa; }

        .result-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .res-row { display: flex; justify-content: space-between; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; margin-bottom: 5px; }
        .res-val { font-weight: bold; color: #fff; }
        .gacha-ticket-badge { background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; position: absolute; top: -5px; right: -5px; font-weight: bold; animation: pulse 1s infinite; }
    </style>
</head>
<body>

<div class="embers"></div>

<div id="cover-screen">
    <div style="font-size:5rem; margin-bottom: 10px; filter: drop-shadow(0 0 20px var(--primary));">ğŸ”¥</div>
    <div style="font-size: 3rem; color: var(--primary); letter-spacing: 3px; font-weight: bold;">å­—éˆçµäºº</div>
    <p style="color:#7f8fa6; letter-spacing: 2px;">V40 å²è©©äº¤éŸ¿ç‰ˆ</p>
    <div id="status-text" style="color:#2ecc71; margin: 15px 0;">è¼‰å…¥ä¸­...</div>
    <button class="start-btn" onclick="initGameSafe()">é€²å…¥ä¸–ç•Œ</button>
    <div style="margin-top:20px; color:#555; cursor:pointer; text-decoration:underline; font-size:0.8rem;" onclick="hardReset()">é‡ç½®é€²åº¦ (Reset)</div>
</div>

<div class="modal" id="char-create-modal" style="z-index: 200;">
    <div class="modal-box">
        <h2 style="color:var(--accent);">é¸æ“‡æ‚¨çš„åŒ–èº«</h2>
        <p style="color:#aaa; font-size:0.9rem;">ä¸åŒçš„è·æ¥­æ“æœ‰ä¸åŒçš„æˆé•·å¤©è³¦</p>
        <div class="char-select-container" id="avatar-grid"></div>
        <button class="start-btn" onclick="confirmCharacter()">ç¢ºèªé¸æ“‡</button>
    </div>
</div>

<div class="app-container" id="app-ui" style="display:none;">
    <div class="top-bar">
        <div style="cursor:pointer;" onclick="toggleMute()" id="sound-btn">ğŸ”Š</div>
        <div class="gems">ğŸ’ <span id="ui-gems">0</span></div>
    </div>

    <div id="tab-char" class="content tab-page active">
        <div class="hero-summary">
            <div class="hero-avatar" id="ui-avatar">ğŸ¥·</div>
            <div class="hero-info">
                <div style="font-size:1.2rem; color:var(--accent);">
                    <span id="ui-name">Name</span> <span style="font-size:0.8rem; color:#aaa;" id="ui-job">Job</span>
                </div>
                <div style="font-size:0.8rem; background:#444; padding:2px 6px; border-radius:4px; display:inline-block; margin:2px 0;">Lv.<span id="ui-lvl">1</span></div>
                <div class="xp-container"><div class="xp-fill" id="ui-xp-bar"></div></div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">EXP: <span id="ui-xp-text">0/100</span></div>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-row"><span>âš”ï¸ æ”»æ“Š (ATK)</span><span id="stat-atk" style="color:#e74c3c">0</span></div>
            <div class="stat-row"><span>ğŸ›¡ï¸ é˜²ç¦¦ (DEF)</span><span id="stat-def" style="color:#3498db">0</span></div>
            <div class="stat-row"><span>â¤ï¸ ç”Ÿå‘½ (HP)</span><span id="stat-hp" style="color:#2ecc71">0</span></div>
            <div class="stat-row"><span>âš¡ æš´æ“Š (CRIT)</span><span id="stat-crit" style="color:#f1c40f">0%</span></div>
            <div class="stat-row"><span>ğŸ’¨ é–ƒé¿ (DODGE)</span><span id="stat-dodge" style="color:#9b59b6">0%</span></div>
            <div class="stat-row"><span>ğŸ€ å¹¸é‹ (LUCK)</span><span id="stat-luck" style="color:var(--luck)">0%</span></div>
        </div>

        <div class="equip-grid">
            <div class="equip-slot" id="slot-head" onclick="unequip('head')"><div class="slot-icon">â›‘ï¸</div><div class="slot-name">é ­ç›”</div></div>
            <div class="equip-slot" id="slot-body" onclick="unequip('body')"><div class="slot-icon">ğŸ‘•</div><div class="slot-name">é§ç”²</div></div>
            <div class="equip-slot" id="slot-gloves" onclick="unequip('gloves')"><div class="slot-icon">ğŸ§¤</div><div class="slot-name">è­·æ‰‹</div></div>
            <div class="equip-slot" id="slot-legs" onclick="unequip('legs')"><div class="slot-icon">ğŸ‘–</div><div class="slot-name">è­·è…¿</div></div>
            <div class="equip-slot" id="slot-feet" onclick="unequip('feet')"><div class="slot-icon">ğŸ‘¢</div><div class="slot-name">æˆ°é´</div></div>
            <div class="equip-slot" id="slot-accessory" onclick="unequip('accessory')"><div class="slot-icon">ğŸ’</div><div class="slot-name">é£¾å“</div></div>
            <div class="equip-slot" id="slot-weapon" onclick="unequip('weapon')"><div class="slot-icon">âš”ï¸</div><div class="slot-name">æ­¦å™¨</div></div>
            <div class="equip-slot" id="slot-offhand" onclick="unequip('offhand')"><div class="slot-icon">ğŸ›¡ï¸</div><div class="slot-name">é˜²å…·</div></div>
        </div>

        <div id="inventory-list" style="padding-bottom:20px;"></div>
    </div>

    <div id="tab-battle" class="content tab-page">
        <div id="battle-prep-screen">
            <div class="battle-prep-panel">
                <div style="font-size:4rem; margin-bottom:10px;">âš”ï¸</div>
                <div style="color:var(--primary); font-size:1.5rem; font-weight:bold;">ç‹©çµå ´</div>
                <div style="color:#7f8fa6; font-size:0.8rem; margin:10px 0;">æº–å‚™é€²å…¥å±éšªå€åŸŸ</div>
                <table class="monster-rates-table" id="monster-rates-list"></table>
                <button class="start-btn" onclick="startBattleSequence()" style="margin-top:10px;">âš”ï¸ é–‹å§‹ç‹©çµ (START)</button>
            </div>
        </div>

        <div id="battle-active-screen" style="display:none;">
            <div style="text-align:center; margin-top:5px;">
                <div style="font-size:6rem; filter:drop-shadow(0 0 30px #e74c3c); transition:0.2s;" id="boss-sprite">ğŸ‘¹</div>
                <div style="color:var(--primary); font-size:1.4rem; font-weight:bold;">
                    <span id="enemy-name">DEMON</span> <span style="font-size:1rem; color:#aaa;">Lv.<span id="enemy-level">1</span></span>
                </div>
                
                <div class="hp-bar-container"><div id="boss-hp-bar" class="hp-fill" style="background:#c0392b;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-bottom:10px;">
                    <span>ENEMY</span><span id="boss-hp-text"></span>
                </div>

                <div class="hp-bar-container" style="height:8px;"><div id="player-hp-bar" class="hp-fill" style="background:#27ae60;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa;">
                    <span>PLAYER</span><span id="player-hp-text"></span>
                </div>
            </div>
            
            <div id="quiz-area" style="margin-top:10px;"></div>
            
            <div id="post-answer-actions">
                <button class="start-btn btn-dict" id="btn-dict-link" onclick="openDictionary()">ğŸ” æ•™è‚²éƒ¨è¾­å…¸ (æŸ¥çœ‹è§£èªª)</button>
                <button class="start-btn" onclick="nextTurn()">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
            </div>

            <div id="battle-tools" style="display:flex;">
                <button class="start-btn tool-btn" onclick="usePotion()">ğŸ§ª è£œè¡€ (<span id="btn-potion-count">0</span>)</button>
                <button class="start-btn tool-btn" onclick="useShield()">ğŸ›¡ï¸ è­·ç›¾ (<span id="btn-shield-count">0</span>)</button>
                <button class="start-btn tool-btn flee-btn" onclick="fleeBattle()">ğŸ³ï¸ é€ƒé›¢æˆ°é¬¥</button>
            </div>
        </div>
    </div>

    <div id="tab-gacha" class="content tab-page">
        <div style="text-align:center; padding-top:40px;">
            <div style="font-size:7rem; margin-bottom:20px; filter:drop-shadow(0 0 30px var(--luck)); animation: float 3s infinite;">ğŸ</div>
            <h2 style="color:var(--accent);">å¹¸é‹å¯¶ç®±</h2>
            <div style="font-size: 0.9rem; color: var(--luck); margin-bottom: 10px; font-weight: bold;">å¹¸é‹åŠ æˆ: +<span id="gacha-luck-val">0</span>%</div>
            <p style="color:#7f8fa6; margin-bottom:30px; font-size:0.9rem;">100 å¯¶çŸ³ / æ¬¡<br>é£¾å“å¯æå‡å¹¸é‹ï¼Œå¢åŠ ç²å¾—å‚³èªªè£å‚™æ©Ÿç‡ï¼</p>
            <button class="start-btn" id="btn-gacha-pull" style="background:var(--luck); color:#000; position:relative;" onclick="pullGacha()">
                é–‹å•Ÿ (100ğŸ’)
            </button>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('char')">ğŸ‘¤ çµäºº</button>
        <button class="nav-btn" onclick="switchTab('battle')">âš”ï¸ æˆ°é¬¥</button>
        <button class="nav-btn" onclick="switchTab('gacha')">ğŸ’ å¯¶åº«</button>
    </div>

    <div class="modal" id="daily-login-modal">
        <div class="modal-box" style="border-color: var(--luck);">
            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“…</div>
            <h2 style="color:var(--luck); margin:0;">æ¯æ—¥ç°½åˆ°</h2>
            <p style="color:#aaa; font-size:0.8rem;">é€£çºŒç™»å…¥ï¼š<span id="login-streak-num" style="color:#fff; font-weight:bold;">1</span> å¤©</p>
            <div class="daily-grid" id="daily-list"></div>
            <div id="today-reward-msg" style="color:#fff; margin-bottom:15px; font-weight:bold;"></div>
            <button class="start-btn" onclick="closeDailyModal()">é ˜å–çå‹µ</button>
        </div>
    </div>

    <div class="modal" id="battle-result-modal">
        <div class="modal-box"></div>
    </div>
</div>

<script>
/**
 * éŠæˆ²å¼•æ“ V40 (å²è©©äº¤éŸ¿ç‰ˆ - Rich Music & Multi-track)
 */

// --- Epic Audio Engine (Multi-track Sequencer) ---
const AudioEngine = {
    ctx: null,
    isMuted: false,
    intervalId: null,
    step: 0, // 16th notes counter
    
    init: function() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },

    // --- Instruments ---
    playTone: function(freq, type, duration, vol=0.1, detune=0) {
        if(this.isMuted || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(detune) osc.detune.value = detune;
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },

    playKick: function() {
        if(this.isMuted || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.frequency.setValueAtTime(150, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.8, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.5);
    },

    playSnare: function() {
        if(this.isMuted || !this.ctx) return;
        const bufferSize = this.ctx.sampleRate * 0.5; // 0.5s noise
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 1000;
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(0.4, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.2);
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        noise.start();
    },

    playHihat: function(open) {
        if(this.isMuted || !this.ctx) return;
        // Simple high tone for hihat
        this.playTone(8000 + Math.random()*2000, 'square', open?0.1:0.05, 0.05);
    },

    playBass: function(freq) {
        // Fat Bass: 2 Sawtooth waves detuned
        this.playTone(freq, 'sawtooth', 0.3, 0.2);
        this.playTone(freq, 'sawtooth', 0.3, 0.2, 10); // Slight detune
    },

    // --- Sequencer ---
    playBGM: function(isBattle) {
        if(this.intervalId) clearInterval(this.intervalId);
        if(this.isMuted) return;

        this.step = 0;
        // Battle: 130 BPM -> 16th note ~ 115ms
        // Peaceful: Slower
        const speed = isBattle ? 115 : 300; 

        // --- Battle Music Composition (C Minor Epic) ---
        // 64 bar loop approx 1 minute
        // Structure: Intro(8) -> Build(8) -> MainA(8) -> MainB(8) ...
        
        // Frequencies: C2=65.41, D#2/Eb2=77.78, F2=87.31, G2=98.00, G#2/Ab2=103.83, A#2/Bb2=116.54
        const BASS_LINE = [
            65.41, 65.41, 65.41, 65.41, 65.41, 65.41, 65.41, 65.41, // C
            103.83, 103.83, 103.83, 103.83, 103.83, 103.83, 103.83, 103.83, // Ab
            87.31, 87.31, 87.31, 87.31, 87.31, 87.31, 87.31, 87.31, // F
            98.00, 98.00, 98.00, 98.00, 116.54, 116.54, 98.00, 98.00 // G -> Bb -> G
        ];

        // Heroic Melody (High Octave) C5=523, Eb5=622, F5=698, G5=784, Ab5=830, Bb5=932, C6=1046
        // Pattern defined in 16th notes logic below

        this.intervalId = setInterval(() => {
            if(this.isMuted) return;

            if (isBattle) {
                // 1. Rhythm (4/4 Rock Beat)
                if (this.step % 4 === 0) this.playKick(); // Kick on 1, 2, 3, 4
                if (this.step % 8 === 4) this.playSnare(); // Snare on 2 and 4
                if (this.step % 2 === 0) this.playHihat(false); // 8th note Hihats

                // 2. Bass (Chugging 8th notes)
                // Cycle through BASS_LINE array roughly every bar
                const barIndex = Math.floor(this.step / 16); 
                const bassNote = BASS_LINE[barIndex % BASS_LINE.length];
                if (this.step % 2 === 0) { // 8th notes
                    this.playBass(bassNote);
                }

                // 3. Lead Melody (Enters after 4 bars - roughly 8 seconds)
                if (barIndex >= 4) {
                    // Simple Heroic Motif
                    const motifStep = this.step % 32; // 2 bar phrases
                    let leadFreq = 0;
                    
                    if(motifStep === 0) leadFreq = 523.25; // C5
                    if(motifStep === 6) leadFreq = 622.25; // Eb5
                    if(motifStep === 12) leadFreq = 783.99; // G5
                    if(motifStep === 16) leadFreq = 698.46; // F5
                    if(motifStep === 22) leadFreq = 622.25; // Eb5
                    if(motifStep === 28) leadFreq = 587.33; // D5

                    if (leadFreq > 0) {
                        this.playTone(leadFreq, 'square', 0.2, 0.1);
                        this.playTone(leadFreq, 'square', 0.2, 0.1, 5); // Detune
                    }
                }

                // 4. Arpeggio (Background Texture)
                if (this.step % 2 !== 0) { // Off-beats
                     this.playTone(bassNote * 4, 'triangle', 0.05, 0.05); // High octave background
                }

            } else {
                // Peaceful BGM (Slower, no drums)
                if (this.step % 8 === 0) {
                    const peaceNotes = [261.63, 293.66, 329.63, 392.00];
                    const note = peaceNotes[Math.floor(this.step/8) % peaceNotes.length];
                    this.playTone(note, 'sine', 1.5, 0.05); // Long pads
                    this.playTone(note * 1.5, 'sine', 1.5, 0.03); // Harmony
                }
            }
            
            this.step++;
        }, speed);
    },

    stopBGM: function() {
        if(this.intervalId) clearInterval(this.intervalId);
    },

    sfx: {
        win: () => { AudioEngine.playTone(660, 'sine', 0.1); setTimeout(()=>AudioEngine.playTone(880, 'sine', 0.3), 100); },
        wrong: () => { AudioEngine.playTone(100, 'sawtooth', 0.3); AudioEngine.playTone(80, 'sawtooth', 0.3); },
        equip: () => { AudioEngine.playTone(1200, 'triangle', 0.1); },
        hit: () => { AudioEngine.playSnare(); }, // Impact sound
        victoryTheme: () => {
             AudioEngine.stopBGM();
             [523, 523, 523, 659, 783, 1046].forEach((f,i)=> setTimeout(()=>AudioEngine.playTone(f, 'square', 0.4, 0.2), i*180));
        }
    }
};

// --- Game Data ---
const JOB_DATA = {
    knight: { id:'knight', name:'å¸åœ‹é¨å£«', desc:'æ”»æ“Š/é˜²ç¦¦ å¹³è¡¡æˆé•·', growth:{atk:1.2, def:1.2, hp:1.0, luck:1.0, crit:0, dodge:0} },
    guardian: { id:'guardian', name:'ç›¾ç‰Œè­·è¡›', desc:'é˜²ç¦¦/è¡€é‡ æ¥µé™æˆé•·', growth:{atk:0.8, def:1.5, hp:1.5, luck:1.0, crit:0, dodge:0} },
    shaman: { id:'shaman', name:'éƒ¨è½å·«å¸«', desc:'æ”»æ“Š/å¹¸é‹ å°‹å¯¶å°ˆå®¶', growth:{atk:1.3, def:0.8, hp:0.8, luck:1.5, crit:0, dodge:0} },
    hunter: { id:'hunter', name:'æ£®æ—çµäºº', desc:'æ”»æ“Š/çˆ†æ“Š æš´åŠ›è¼¸å‡º', growth:{atk:1.4, def:0.8, hp:0.9, luck:1.0, crit:2, dodge:0} },
    assassin: { id:'assassin', name:'çš‡å®¶åˆºå®¢', desc:'çˆ†æ“Š/é–ƒé¿ éˆæ´»æ®ºæ‰‹', growth:{atk:1.2, def:0.7, hp:0.8, luck:1.0, crit:1.5, dodge:2} }
};

const PRESET_CHARS = [
    { n:'äºç‘Ÿ', i:'ğŸ¤´', job:'knight' }, { n:'è²å¾·', i:'ğŸ‘¸', job:'knight' },
    { n:'éµå£', i:'ğŸ‘®', job:'guardian' }, { n:'é‹¼ç›¾', i:'ğŸ‘·â€â™€ï¸', job:'guardian' },
    { n:'æ¢…æ—', i:'ğŸ§™â€â™‚ï¸', job:'shaman' }, { n:'æ‘©æ ¹', i:'ğŸ§šâ€â™€ï¸', job:'shaman' },
    { n:'ç¾…è³“', i:'ğŸ¹', job:'hunter' }, { n:'äºç‰¹', i:'ğŸ¦¸â€â™€ï¸', job:'hunter' },
    { n:'åŠè—', i:'ğŸ¥·', job:'assassin' }, { n:'é»‘å¯¡å©¦',i:'ğŸ•µï¸â€â™€ï¸', job:'assassin' }
];

const TIERS = [
    { id:'slime', n:'å²èŠå§†', i:'ğŸ’§', hp:30, xp:10, minLvl:1, chance:40 },
    { id:'bat', n:'å¸è¡€è™è ', i:'ğŸ¦‡', hp:50, xp:20, minLvl:2, chance:30 },
    { id:'skel', n:'éª·é«å…µ', i:'ğŸ’€', hp:80, xp:35, minLvl:5, chance:18 },
    { id:'wolf', n:'é­”ç‹¼', i:'ğŸº', hp:120, xp:50, minLvl:8, chance:10 },
    { id:'dragon', n:'ç´…é¾', i:'ğŸ²', hp:300, xp:200, minLvl:15, chance:2 }
];

const DAILY_REWARDS = [
    { t: 'gems', v: 30, i: 'ğŸ’', n:'å¯¶çŸ³' }, { t: 'xp', v: 50, i: 'âœ¨', n:'ç¶“é©—' },
    { t: 'potion', v: 2, i: 'ğŸ§ª', n:'è—¥æ°´' }, { t: 'gems', v: 50, i: 'ğŸ’', n:'å¯¶çŸ³' },
    { t: 'xp', v: 100, i: 'âœ¨', n:'ç¶“é©—' }, { t: 'shield', v: 2, i: 'ğŸ›¡ï¸', n:'è­·ç›¾' },
    { t: 'ticket', v: 1, i: 'ğŸ«', n:'å…è²»æŠ½' }
];

let player = {
    name: "Hunter", avatar: "ğŸ¥·", job: "knight",
    gems: 100, xp: 0, level: 1, 
    inventory: [], equipped: {}, 
    potions: 3, shields: 1,
    lastLogin: "", loginStreak: 0, gachaTickets: 0
};

let battle = { active: false, currentQ: null, stats: { turns: 0, correct: 0, maxCombo: 0, currCombo: 0, dmgTaken: 0, dmgDealt: 0 } };
let questionBank = [];
let selectedCharIndex = 0;

// --- Init & Save ---
function initGameSafe() {
    AudioEngine.init();
    AudioEngine.playBGM(false); 
    loadData();
    parseQuestionBank(); 
    renderMonsterRates();

    if (!player.job || player.name === "Hunter") {
        document.getElementById('cover-screen').style.display = 'none';
        showCharacterCreation();
    } else {
        updateUI();
        document.getElementById('cover-screen').style.display = 'none';
        document.getElementById('app-ui').style.display = 'flex';
        checkDailyLogin();
    }
}

function loadData() {
    const d = JSON.parse(localStorage.getItem('rpg_v40_save'));
    if (d) {
        player = { ...player, ...d.player };
        if(!player.potions) player.potions = 3;
        if(!player.shields) player.shields = 1;
        if(!player.job) player.job = 'knight';
    }
}

function saveData() {
    localStorage.setItem('rpg_v40_save', JSON.stringify({ player }));
}

function hardReset() {
    if(confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é€²åº¦å—ï¼Ÿ')) {
        localStorage.removeItem('rpg_v40_save');
        location.reload();
    }
}

// --- Character Creation ---
function showCharacterCreation() {
    const grid = document.getElementById('avatar-grid');
    grid.innerHTML = '';
    PRESET_CHARS.forEach((char, idx) => {
        const job = JOB_DATA[char.job];
        const div = document.createElement('div');
        div.className = 'char-card';
        div.onclick = () => selectChar(div, idx);
        div.innerHTML = `
            <div class="char-card-icon">${char.i}</div>
            <div class="char-card-info">
                <div class="char-card-name">${char.n}</div>
                <div class="char-card-job">${job.name}</div>
                <div class="char-card-desc">${job.desc}</div>
            </div>
        `;
        grid.appendChild(div);
    });
    selectChar(grid.children[0], 0);
    document.getElementById('char-create-modal').style.display = 'flex';
}

function selectChar(el, idx) {
    document.querySelectorAll('.char-card').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    selectedCharIndex = idx;
}

function confirmCharacter() {
    const char = PRESET_CHARS[selectedCharIndex];
    player.name = char.n;
    player.avatar = char.i;
    player.job = char.job;
    saveData();
    document.getElementById('char-create-modal').style.display = 'none';
    document.getElementById('app-ui').style.display = 'flex';
    updateUI();
    checkDailyLogin();
}

// --- Question Bank ---
function parseQuestionBank() {
    if(!window.MOE_DATA_STRING) {
        questionBank = [{q:'æ¸¬è©¦', a:'ç­”æ¡ˆ', w:['éŒ¯1']}];
        return;
    }
    let raw = window.MOE_DATA_STRING;
    raw = raw.replace(/2/g, 'ËŠ').replace(/3/g, 'Ë‡').replace(/4/g, 'Ë‹').replace(/5/g, 'Ë™');
    
    const lines = raw.trim().split('\n');
    questionBank = [];
    lines.forEach(line => {
        let p = line.split('|');
        if(p.length < 4) return;
        const clean = (s) => s.replace(/1/g, '').replace(/2/g, 'ËŠ').replace(/3/g, 'Ë‡').replace(/4/g, 'Ë‹').replace(/5/g, 'Ë™');
        let type = p[0], q = p[1], a = p[2], w = p[3];
        if (type === '1') q = clean(q);
        else { a = clean(a); w = clean(w); }
        questionBank.push({ type: type, q: q, a: a, w: w.split(',') });
    });
}

// --- Daily Login ---
function checkDailyLogin() {
    const today = new Date().toDateString();
    if (player.lastLogin === today) return;

    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (player.lastLogin === yesterday.toDateString()) player.loginStreak++;
    else player.loginStreak = 1;

    const streakIdx = (player.loginStreak - 1) % 7;
    const reward = DAILY_REWARDS[streakIdx];
    
    if(reward.t === 'gems') player.gems += reward.v;
    if(reward.t === 'xp') addXp(reward.v);
    if(reward.t === 'potion') player.potions += reward.v;
    if(reward.t === 'shield') player.shields += reward.v;
    if(reward.t === 'ticket') player.gachaTickets += reward.v;

    player.lastLogin = today;
    saveData();
    updateUI();
    
    const list = document.getElementById('daily-list');
    list.innerHTML = '';
    DAILY_REWARDS.forEach((r, idx) => {
        const div = document.createElement('div');
        let cls = 'daily-day';
        if (idx < streakIdx) cls += ' claimed';
        if (idx === streakIdx) cls += ' active';
        div.className = cls;
        div.innerHTML = `<div class="daily-icon">${r.i}</div><div class="daily-txt">${idx+1}å¤©<br>${r.n}x${r.v}</div>`;
        list.appendChild(div);
    });

    document.getElementById('today-reward-msg').innerText = `ç²å¾—ï¼š${reward.n} x${reward.v}`;
    document.getElementById('daily-login-modal').style.display = 'flex';
}

function closeDailyModal() {
    document.getElementById('daily-login-modal').style.display = 'none';
}

// --- Stats & UI ---
function getStats() {
    const job = JOB_DATA[player.job] || JOB_DATA.knight;
    const growth = job.growth;
    let base = {
        hp: Math.floor(100 + (player.level * 10 * growth.hp)),
        atk: Math.floor(10 + (player.level * 2 * growth.atk)),
        def: Math.floor(5 + (player.level * 1 * growth.def)),
        crit: 5 + (player.level * growth.crit),
        dodge: 5 + (player.level * growth.dodge),
        luck: 0 + (player.level * growth.luck)
    };
    Object.values(player.equipped).forEach(item => {
        if(item) {
            base.hp += (item.hp || 0); base.atk += (item.atk || 0);
            base.def += (item.def || 0); base.crit += (item.crit || 0);
            base.dodge += (item.dodge || 0); base.luck += (item.luck || 0);
        }
    });
    base.crit = Math.min(100, Math.floor(base.crit));
    base.dodge = Math.min(80, Math.floor(base.dodge));
    base.luck = Math.floor(base.luck);
    return base;
}

function addXp(amount) {
    player.xp += amount;
    const req = player.level * 100;
    if (player.xp >= req) {
        player.xp -= req;
        player.level++;
        AudioEngine.sfx.win();
        showFloatText("ç­‰ç´šæå‡!", "#f1c40f");
    }
    updateUI();
    saveData();
}

function updateUI() {
    const s = getStats();
    const jobName = JOB_DATA[player.job].name;

    document.getElementById('ui-gems').innerText = player.gems;
    document.getElementById('ui-lvl').innerText = player.level;
    document.getElementById('ui-xp-text').innerText = `${player.xp}/${player.level*100}`;
    document.getElementById('ui-xp-bar').style.width = `${(player.xp/(player.level*100))*100}%`;
    
    document.getElementById('ui-name').innerText = player.name;
    document.getElementById('ui-avatar').innerText = player.avatar;
    document.getElementById('ui-job').innerText = jobName;

    document.getElementById('stat-atk').innerText = s.atk;
    document.getElementById('stat-def').innerText = s.def;
    document.getElementById('stat-hp').innerText = s.hp;
    document.getElementById('stat-crit').innerText = s.crit + "%";
    document.getElementById('stat-dodge').innerText = s.dodge + "%";
    document.getElementById('stat-luck').innerText = s.luck + "%";
    document.getElementById('gacha-luck-val').innerText = s.luck;

    // Render Slots (Visual Update for Empty Slots)
    const names = {head:'é ­ç›”',body:'é§ç”²',legs:'è­·è…¿',feet:'æˆ°é´',gloves:'è­·æ‰‹',weapon:'æ­¦å™¨',offhand:'ç›¾ç‰Œ',accessory:'é£¾å“'};
    ['head','body','legs','feet','gloves','weapon','offhand','accessory'].forEach(slot => {
        const el = document.getElementById(`slot-${slot}`);
        const item = player.equipped[slot];
        if (item) {
            el.innerHTML = `<div class="slot-icon">${item.icon}</div><div class="slot-name">${item.name}</div>`;
            el.classList.add('slot-equipped');
            el.classList.remove('slot-empty');
        } else {
            const icons = {head:'â›‘ï¸',body:'ğŸ‘•',legs:'ğŸ‘–',feet:'ğŸ‘¢',gloves:'ğŸ§¤',weapon:'âš”ï¸',offhand:'ğŸ›¡ï¸',accessory:'ğŸ’'};
            el.innerHTML = `<div class="slot-icon">${icons[slot]}</div><div class="slot-name">${names[slot]}</div>`;
            el.classList.remove('slot-equipped');
            el.classList.add('slot-empty');
        }
    });

    const invDiv = document.getElementById('inventory-list');
    invDiv.innerHTML = '';
    player.inventory.forEach((item, idx) => {
        const d = document.createElement('div');
        d.className = 'inv-item';
        d.innerHTML = `
            <div style="font-size:1.5rem; margin-right:10px;">${item.icon}</div>
            <div>
                <div style="font-weight:bold; color:${getRarityColor(item.rarity)}">${item.name}</div>
                <div style="font-size:0.7rem; color:#aaa;">${getItemDesc(item)}</div>
            </div>
            <div class="inv-actions">
                <button class="btn-action btn-equip" onclick="equipItem(${idx})">è£å‚™</button>
                <button class="btn-action btn-sell" onclick="sellItem(${idx})">å‡ºå”®</button>
            </div>
        `;
        invDiv.appendChild(d);
    });
    
    const gachaBtn = document.getElementById('btn-gacha-pull');
    if (player.gachaTickets > 0) {
        gachaBtn.innerHTML = `é–‹å•Ÿ <span style="font-size:0.8rem">(ğŸ« x${player.gachaTickets})</span><div class="gacha-ticket-badge">å…è²»</div>`;
        gachaBtn.style.background = "linear-gradient(45deg, #f1c40f, #e67e22)";
    } else {
        gachaBtn.innerHTML = `é–‹å•Ÿ (100ğŸ’)`;
        gachaBtn.style.background = "var(--luck)";
    }
}

function getRarityColor(r) { return r===3?'#e74c3c':(r===2?'#f1c40f':(r===1?'#3498db':'#fff')); }
function getItemDesc(i) {
    let s=[]; 
    if(i.atk) s.push(`æ”»+${i.atk}`); if(i.def) s.push(`é˜²+${i.def}`); 
    if(i.hp) s.push(`å‘½+${i.hp}`); if(i.luck) s.push(`é‹+${i.luck}`);
    return s.join(' ');
}

// --- Battle System ---
function startBattleSequence() {
    AudioEngine.playBGM(true);
    document.getElementById('battle-prep-screen').style.display = 'none';
    document.getElementById('battle-active-screen').style.display = 'block';
    
    const roll = Math.random() * 100;
    let target;
    if (roll < 40) target = TIERS[0];
    else if (roll < 70) target = TIERS[1];
    else if (roll < 88) target = TIERS[2];
    else if (roll < 98) target = TIERS[3];
    else target = TIERS[4];

    const isBoss = target.id === 'dragon' || Math.random() < 0.05;
    
    battle = {
        active: true,
        maxHp: target.hp * (isBoss?3:1),
        bossHp: target.hp * (isBoss?3:1),
        playerHp: getStats().hp,
        monster: target,
        isBoss: isBoss,
        shieldTurns: 0,
        currentQ: null,
        stats: { turns: 0, correct: 0, maxCombo: 0, currCombo: 0, dmgTaken: 0, dmgDealt: 0 }
    };
    
    document.getElementById('boss-sprite').innerText = target.i;
    document.getElementById('boss-sprite').style.transform = isBoss ? 'scale(1.5)' : 'scale(1)';
    document.getElementById('enemy-name').innerText = (isBoss?"BOSS ":"") + target.n;
    document.getElementById('enemy-level').innerText = Math.max(1, Math.floor(player.level + (isBoss?2:0)));
    document.getElementById('battle-tools').style.display = 'flex';
    
    updateBattleUI();
    loadQuestion();
}

function updateBattleUI() {
    const b = battle;
    const pPct = Math.max(0, (b.playerHp / getStats().hp)*100);
    const mPct = Math.max(0, (b.bossHp / b.maxHp)*100);
    
    document.getElementById('player-hp-bar').style.width = `${pPct}%`;
    document.getElementById('player-hp-text').innerText = `${Math.floor(b.playerHp)}/${getStats().hp}`;
    document.getElementById('boss-hp-bar').style.width = `${mPct}%`;
    document.getElementById('boss-hp-text').innerText = `${Math.floor(b.bossHp)}/${b.maxHp}`;
    
    document.getElementById('btn-potion-count').innerText = player.potions;
    document.getElementById('btn-shield-count').innerText = player.shields;
}

function loadQuestion() {
    if(!battle.active) return;
    document.getElementById('post-answer-actions').style.display = 'none'; 
    
    const q = questionBank[Math.floor(Math.random()*questionBank.length)];
    battle.currentQ = q; 
    const options = [q.a, ...q.w].sort(()=>Math.random()-0.5);
    
    let html = `<div class="quiz-panel"><div style="font-size:1.2rem; text-align:center; margin-bottom:15px; color:#fff;">${q.q}</div>`;
    options.forEach(opt => {
        html += `<button class="opt-btn" onclick="handleAns(this, '${opt}', '${q.a}')">${opt}</button>`;
    });
    html += `</div>`;
    document.getElementById('quiz-area').innerHTML = html;
}

function handleAns(btn, choice, ans) {
    if(!battle.active) return;
    document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
    
    const correct = choice === ans;
    const stats = getStats();
    battle.stats.turns++;

    if(correct) {
        btn.style.background = "#27ae60";
        battle.stats.correct++;
        battle.stats.currCombo++;
        if(battle.stats.currCombo > battle.stats.maxCombo) battle.stats.maxCombo = battle.stats.currCombo;
        
        const isCrit = Math.random()*100 < stats.crit;
        const dmg = Math.floor(stats.atk * (isCrit?1.5:1) * (1 + battle.stats.currCombo*0.1));
        battle.bossHp -= dmg;
        battle.stats.dmgDealt += dmg;
        AudioEngine.sfx.hit();
        showFloatText(isCrit?`çˆ†æ“Š ${dmg}!`:`${dmg}`, "#f1c40f");
    } else {
        btn.style.background = "#c0392b";
        battle.stats.currCombo = 0;
        AudioEngine.sfx.wrong();
        showFloatText("å¤±èª¤", "#aaa");
        monsterAttack();
    }
    
    updateBattleUI();
    document.getElementById('post-answer-actions').style.display = 'flex';
}

function nextTurn() {
    if(battle.bossHp <= 0) winBattle();
    else if(battle.playerHp <= 0) loseBattle();
    else loadQuestion();
}

function openDictionary() {
    if(!battle.currentQ) return;
    const q = battle.currentQ;
    let term = "";
    if(q.type === '1') {
        term = q.a;
    } else {
        term = q.q.replace(/[ã€Œã€ã€ã€]/g, ''); 
    }
    const url = `https://dict.revised.moe.edu.tw/search.jsp?md=1&word=${encodeURIComponent(term)}`;
    window.open(url, '_blank');
}

function monsterAttack() {
    if(battle.shieldTurns > 0) {
        battle.shieldTurns--;
        showFloatText("æ ¼æ“‹!", "#3498db");
        return;
    }
    if(Math.random()*100 < getStats().dodge) {
        showFloatText("é–ƒé¿!", "#9b59b6");
        return;
    }
    const dmg = Math.max(1, (player.level*5) - Math.floor(getStats().def/2));
    battle.playerHp -= dmg;
    battle.stats.dmgTaken += dmg;
    showFloatText(`-${dmg}`, "#e74c3c");
}

function usePotion() {
    if(player.potions > 0 && battle.active) {
        player.potions--;
        const heal = Math.floor(getStats().hp * 0.5);
        battle.playerHp = Math.min(battle.playerHp + heal, getStats().hp);
        updateBattleUI();
        showFloatText(`æ¢å¾© ${heal}`, "#2ecc71");
    }
}

function useShield() {
    if(player.shields > 0 && battle.active) {
        player.shields--;
        battle.shieldTurns = 2;
        updateBattleUI();
        showFloatText("è­·ç›¾é–‹å•Ÿ", "#3498db");
    }
}

function fleeBattle() {
    if(confirm('ç¢ºå®šè¦é€ƒè·‘å—ï¼Ÿ')) {
        battle.active = false;
        AudioEngine.playBGM(false);
        document.getElementById('battle-active-screen').style.display = 'none';
        document.getElementById('battle-prep-screen').style.display = 'block';
    }
}

function winBattle() {
    battle.active = false;
    AudioEngine.sfx.victoryTheme();
    const m = battle.monster;
    let xpGain = m.xp * (battle.isBoss?5:1);
    let gemGain = Math.floor(xpGain/2);
    let gotPotion = Math.random() > 0.8;
    addXp(xpGain);
    player.gems += gemGain;
    if(gotPotion) player.potions++;
    const s = battle.stats;
    const accuracy = Math.round((s.correct / s.turns) * 100) || 0;
    
    const modalBox = document.querySelector('#battle-result-modal .modal-box');
    modalBox.innerHTML = `
        <div style="font-size:4rem; margin-bottom:5px;">ğŸ†</div>
        <h2 style="font-family:var(--font-title); color:#f1c40f; margin:0 0 10px 0;">æˆ°é¬¥å‹åˆ©</h2>
        <div class="result-stat-grid">
            <div class="res-row"><span>âš”ï¸ å›åˆæ•¸</span><span class="res-val" style="color:#ddd">${s.turns}</span></div>
            <div class="res-row"><span>ğŸ”¥ ç¸½å‚·å®³</span><span class="res-val" style="color:#e74c3c">${s.dmgDealt}</span></div>
            <div class="res-row"><span>ğŸ¯ æº–ç¢ºç‡</span><span class="res-val" style="color:#3498db">${accuracy}%</span></div>
            <div class="res-row"><span>ğŸ å¯¶çŸ³</span><span class="res-val" style="color:#2ecc71">+${gemGain}</span></div>
        </div>
        <button class="start-btn" onclick="showLootMenu(${xpGain}, ${gemGain}, ${gotPotion})">ç¢ºèª</button>
    `;
    document.getElementById('battle-result-modal').style.display = 'flex';
    saveData();
}

function showLootMenu(xp, gems, potion) {
    const modalBox = document.querySelector('#battle-result-modal .modal-box');
    let potionHtml = potion ? '<div style="color:#2ecc71">ğŸ§ª ç²å¾—è—¥æ°´ x1</div>' : '';
    modalBox.innerHTML = `
        <div style="font-size:4rem; margin-bottom:10px;">ğŸ’</div>
        <h2 style="font-family:var(--font-title); color:#fff; margin:0 0 15px 0;">æˆ°åˆ©å“</h2>
        <div style="font-size:1.2rem; color:#fff; font-weight:bold; margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px;">
            ç¶“é©— +${xp}<br>å¯¶çŸ³ +${gems}
            ${potionHtml}
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="start-btn" onclick="continueBattle()">âš”ï¸ ç¹¼çºŒç‹©çµ</button>
            <button class="start-btn btn-secondary" onclick="exitBattle()">ğŸ  è¿”å›ç‡Ÿåœ°</button>
        </div>
    `;
}

function continueBattle() {
    document.getElementById('battle-result-modal').style.display = 'none';
    startBattleSequence();
}

function exitBattle() {
    AudioEngine.playBGM(false); 
    document.getElementById('battle-result-modal').style.display = 'none';
    document.getElementById('battle-active-screen').style.display = 'none';
    document.getElementById('battle-prep-screen').style.display = 'block';
}

function loseBattle() {
    battle.active = false;
    alert("ä½ è¢«æ“Šæ•—äº†...");
    AudioEngine.playBGM(false);
    document.getElementById('battle-active-screen').style.display = 'none';
    document.getElementById('battle-prep-screen').style.display = 'block';
}

function pullGacha() {
    let cost = 100;
    let useTicket = player.gachaTickets > 0;
    if (!useTicket && player.gems < cost) return alert("å¯¶çŸ³ä¸è¶³!");
    if (useTicket) player.gachaTickets--;
    else player.gems -= cost;

    const parts = ['head','body','legs','feet','gloves','weapon','offhand','accessory'];
    const part = parts[Math.floor(Math.random()*parts.length)];
    const rarity = Math.random() < (0.1 + getStats().luck*0.01) ? 3 : (Math.random()<0.3 ? 2 : 1);
    
    const partNames = {head:'é ­ç›”', body:'é§ç”²', legs:'è­·è…¿', feet:'æˆ°é´', gloves:'è­·æ‰‹', weapon:'æ­¦å™¨', offhand:'ç›¾ç‰Œ', accessory:'é£¾å“'};
    const rarityNames = ['æ™®é€š', 'ç¨€æœ‰', 'å‚³èªª'];
    const item = {
        name: `${rarityNames[rarity-1]} ${partNames[part]}`,
        slot: part, rarity: rarity,
        icon: {head:'â›‘ï¸',body:'ğŸ‘•',legs:'ğŸ‘–',feet:'ğŸ‘¢',gloves:'ğŸ§¤',weapon:'âš”ï¸',offhand:'ğŸ›¡ï¸',accessory:'ğŸ’'}[part],
        atk: part==='weapon' ? rarity*5 : 0,
        def: part!=='weapon' && part!=='accessory' ? rarity*3 : 0,
        hp: part==='body' ? rarity*20 : 0,
        luck: part==='accessory' ? rarity*2 : 0,
        crit: part==='weapon' ? rarity : 0
    };
    
    player.inventory.push(item);
    AudioEngine.sfx.equip();
    saveData();
    updateUI();
    const costMsg = useTicket ? "æ¶ˆè€—æŠ½çåˆ¸ x1" : "æ¶ˆè€— 100 å¯¶çŸ³";
    alert(`[${costMsg}]\nç²å¾—ï¼š${item.name}\n${getItemDesc(item)}`);
}

function equipItem(idx) {
    const item = player.inventory[idx];
    if(player.equipped[item.slot]) player.inventory.push(player.equipped[item.slot]);
    player.equipped[item.slot] = item;
    player.inventory.splice(idx, 1);
    AudioEngine.sfx.equip();
    saveData();
    updateUI();
}

function unequip(slot) {
    if(player.equipped[slot]) {
        player.inventory.push(player.equipped[slot]);
        delete player.equipped[slot];
        AudioEngine.sfx.equip();
        saveData();
        updateUI();
    }
}

function sellItem(idx) {
    const item = player.inventory[idx];
    const price = item.rarity * 20;
    if (confirm(`ç¢ºå®šè¦å‡ºå”®ã€Œ${item.name}ã€å—ï¼Ÿ\né ä¼°å”®åƒ¹ï¼š${price} ğŸ’`)) {
        player.gems += price;
        player.inventory.splice(idx, 1);
        saveData();
        updateUI();
    }
}

function switchTab(t) {
    document.querySelectorAll('.tab-page').forEach(e => e.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
    event.currentTarget.classList.add('active');
}

function renderMonsterRates() {
    const t = document.getElementById('monster-rates-list');
    t.innerHTML = TIERS.map(m => `<tr><td>${m.i} ${m.n}</td><td>Lv.${m.minLvl}+</td><td>${m.chance}%</td></tr>`).join('');
}

function toggleMute() {
    AudioEngine.isMuted = !AudioEngine.isMuted;
    if(AudioEngine.isMuted) AudioEngine.stopBGM();
    else AudioEngine.playBGM(battle.active);
    document.getElementById('sound-btn').innerText = AudioEngine.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
}

function showFloatText(txt, color) {
    const el = document.createElement('div');
    el.className = 'float-txt';
    el.style.color = color;
    el.innerText = txt;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 1000);
}
</script>
</body>
</html>
