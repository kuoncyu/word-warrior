<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­—éˆçµäººï¼šç™¾å±¤å¡”å‚³èªª (V49)</title>
    <script src="moe_data.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');

        :root {
            --bg-dark: #0f0f10;
            --panel-bg: rgba(25, 25, 30, 0.98);
            --primary: #c23616;
            --accent: #fbc531;
            --luck: #00d2d3;
            --enhance: #e056fd;
            --boss: #e74c3c;
            --text: #f5f6fa;
            --font-main: 'Noto Serif TC', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text);
            margin: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
            background: radial-gradient(circle at 50% 30%, #1e0505 0%, #000 100%);
        }

        /* --- Animations --- */
        @keyframes monster-hit {
            0% { transform: scale(1) translate(0,0); filter: brightness(1); }
            20% { transform: scale(0.9) translate(-5px, 0); filter: brightness(2) drop-shadow(0 0 10px #fff); }
            40% { transform: scale(1) translate(5px, 0); filter: brightness(1); }
            100% { transform: scale(1) translate(0,0); }
        }
        @keyframes screen-shake-red {
            0%, 100% { transform: translate(0,0); box-shadow: inset 0 0 0 transparent; }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, -5px); box-shadow: inset 0 0 50px rgba(255,0,0,0.6); }
            20%, 40%, 60%, 80% { transform: translate(5px, 5px); }
        }
        @keyframes boss-ult {
            0% { transform: scale(1.5); filter: hue-rotate(0deg); }
            50% { transform: scale(1.8); filter: hue-rotate(90deg) brightness(2); }
            100% { transform: scale(1.5); filter: hue-rotate(0deg); }
        }

        .anim-monster-hit { animation: monster-hit 0.4s ease-out; }
        .anim-player-hit { animation: screen-shake-red 0.5s ease-out; border: 2px solid red !important; }
        .anim-boss-ult { animation: boss-ult 0.8s ease-in-out; }

        .embers {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: -1;
            background-image: radial-gradient(rgba(194, 54, 22, 0.3) 1px, transparent 1px);
            background-size: 50px 50px; animation: rise 25s linear infinite; opacity: 0.5;
        }
        @keyframes rise { from {transform: translateY(0);} to {transform: translateY(-600px);} }

        .app-container {
            width: 100%; max-width: 550px; height: 100%; max-height: 950px;
            background: var(--panel-bg); border: 2px solid #571a1a;
            box-shadow: 0 0 80px rgba(194, 54, 22, 0.3); position: relative;
            display: flex; flex-direction: column; overflow: hidden;
            transition: border 0.2s;
        }
        @media (min-width: 550px) { .app-container { border-radius: 12px; height: 95vh; } }

        /* UI Components */
        .top-header { background: rgba(0,0,0,0.9); border-bottom: 1px solid #444; display: flex; flex-direction: column; }
        .top-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .nav-bar { display: flex; height: 50px; }
        .nav-btn { flex: 1; background: none; border: none; color: #555; font-size: 0.9rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .nav-btn.active { color: var(--text); border-bottom-color: var(--primary); background: rgba(255,255,255,0.05); }
        
        .gems { color: var(--accent); font-size: 1.1rem; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        
        .content { flex: 1; overflow-y: auto; padding: 15px; position: relative; scroll-behavior: smooth; }
        .tab-page { display: none; animation: fadeIn 0.4s; }
        .tab-page.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        .start-btn {
            background: linear-gradient(135deg, #c23616, #8e44ad);
            color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 12px 25px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            letter-spacing: 1px; width: 100%;
            box-shadow: 0 0 15px rgba(194, 54, 22, 0.5); border-radius: 4px; margin-bottom: 8px;
        }
        .start-btn:active { transform: scale(0.96); filter: brightness(0.8); }
        .btn-secondary { background: #34495e; box-shadow: none; border-color: #57606f; }
        .btn-dict { background: #27ae60; border-color: #2ecc71; font-size: 0.9rem; }
        .btn-fix { background: #d35400; border-color: #e67e22; font-size: 0.8rem; padding: 5px; width: auto; display: inline-block; margin-top: 5px;}

        /* Character & Stats */
        .hero-summary { display:flex; align-items:center; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #333; }
        .hero-avatar { font-size: 3.5rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        .hero-info { flex:1; }
        .xp-container { width: 100%; background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top:5px; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #8e44ad, #9b59b6); width: 0%; transition: width 0.5s; }

        .stat-box { background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #333; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        
        .equip-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .equip-slot { aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: 0.2s; opacity: 0.5; filter: grayscale(1); }
        .slot-equipped { border-color: var(--accent); background: rgba(251, 197, 49, 0.15); opacity: 1; filter: none; box-shadow: inset 0 0 10px rgba(251, 197, 49, 0.2); }
        .slot-icon { font-size: 1.6rem; position: relative; }
        .enhance-badge { position: absolute; top:-5px; right:-10px; background: var(--enhance); color:#fff; font-size:0.6rem; padding:1px 4px; border-radius:4px; font-weight:bold; box-shadow: 0 0 5px var(--enhance); }
        .slot-name { font-size: 0.6rem; color: #7f8fa6; margin-top: 2px; }
        .slot-equipped .slot-name { color: #fff; font-weight: bold; }

        /* Inventory */
        .inv-item { display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 5px; border-left: 3px solid #555; border-radius: 4px; }
        .inv-actions { margin-left: auto; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .btn-action { padding: 4px 8px; border: 1px solid #555; color: white; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 0.7rem; min-width: 50px; }
        .btn-equip { background: #353b48; }
        .btn-enhance { background: #8e44ad; border-color: #9b59b6; }
        .btn-sell { background: #2c3e50; border-color: #c0392b; color: #e74c3c; }

        /* Map Select */
        .map-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .map-card { background: rgba(255,255,255,0.05); border: 1px solid #444; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .map-card:hover { border-color: var(--primary); background: rgba(194, 54, 22, 0.1); }
        .map-card.locked { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; border-color: #555; }
        .map-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .map-name { font-weight: bold; color: #fff; }
        .map-info { font-size: 0.7rem; color: #aaa; margin-top: 5px; }

        /* Battle UI */
        .hp-bar-container { width:100%; height:12px; background:#111; border:1px solid #444; border-radius:2px; overflow:hidden; margin-bottom:2px; }
        .hp-fill { height:100%; width:100%; transition:width 0.3s; }
        .timer-track { width: 100%; height: 8px; background: #333; margin-top: 10px; border-radius: 4px; overflow: hidden; border: 1px solid #555; }
        .timer-bar { width: 100%; height: 100%; background: #00d2d3; transition: width 0.1s linear, background 0.3s; }

        .quiz-panel { background: rgba(30, 30, 35, 0.95); border: 1px solid #571a1a; padding: 20px; margin-top: 5px; border-radius: 8px; }
        .opt-btn { width: 100%; padding: 14px; margin-bottom: 8px; background: #2f3640; border: 1px solid #57606f; color: #dcdde1; font-size: 1.2rem; cursor: pointer; font-family: "KaiTi"; font-weight: bold; border-radius: 6px; }
        #battle-tools { display:none; justify-content:center; gap:10px; margin-top:15px; flex-wrap: wrap; }
        .tool-btn { flex: 1; padding: 10px; font-size: 0.9rem; background: #34495e; min-width: 80px; }
        .flee-btn { background: #444; border-color: #7f8fa6; color: #a4b0be; flex: 0 0 100%; margin-top: 5px; }
        #post-answer-actions { display: none; flex-direction: column; gap: 5px; margin-top: 10px; }
        
        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { background: #1e272e; width: 85%; max-width: 400px; padding: 30px; border: 1px solid var(--primary); text-align: center; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .float-txt { position: absolute; left: 50%; top: 40%; transform: translateX(-50%); font-weight:bold; pointer-events: none; animation: popUp 0.8s forwards; z-index: 150; text-shadow: 2px 2px 0 #000; }
        @keyframes popUp { 0%{opacity:0; transform:translate(-50%,0) scale(0.5);} 20%{opacity:1; transform:translate(-50%,-50px) scale(1.5);} 100%{opacity:0; transform:translate(-50%,-100px) scale(1);} }

        /* Char Create specific */
        .char-select-container { display: flex; flex-direction: column; gap: 10px; height: 350px; overflow-y: auto; margin: 15px 0; padding-right: 5px; }
        .char-card { display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; padding: 10px; cursor: pointer; transition: 0.2s; }
        .char-card.selected { border-color: var(--accent); background: rgba(251, 197, 49, 0.15); box-shadow: 0 0 10px rgba(251,197,49,0.3); }
        .char-card-icon { font-size: 2.5rem; margin-right: 15px; }
        .char-card-info { flex: 1; text-align: left; }
        .char-card-name { font-weight: bold; font-size: 1.1rem; color: #fff; }
        .char-card-job { font-size: 0.8rem; color: var(--accent); margin-bottom: 2px; }
        .char-card-desc { font-size: 0.7rem; color: #aaa; }

        #cover-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }

        .daily-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .daily-day { background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 6px; padding: 8px; text-align: center; position: relative; opacity: 0.6; }
        .daily-day.active { border-color: var(--accent); opacity: 1; background: rgba(251, 197, 49, 0.1); transform: scale(1.05); box-shadow: 0 0 10px rgba(251,197,49,0.2); }
        .daily-day.claimed { border-color: #2ecc71; opacity: 0.4; filter: grayscale(1); }
        .daily-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .daily-txt { font-size: 0.6rem; color: #aaa; }

        .result-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .res-row { display: flex; justify-content: space-between; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; margin-bottom: 5px; }
        .res-val { font-weight: bold; color: #fff; }
        .gacha-ticket-badge { background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; position: absolute; top: -5px; right: -5px; font-weight: bold; animation: pulse 1s infinite; }
    </style>
</head>
<body>

<div class="embers"></div>

<div id="cover-screen">
    <div style="font-size:5rem; margin-bottom: 10px; filter: drop-shadow(0 0 20px var(--primary));">ğŸ”¥</div>
    <div style="font-size: 3rem; color: var(--primary); letter-spacing: 3px; font-weight: bold;">å­—éˆçµäºº</div>
    <p style="color:#7f8fa6; letter-spacing: 2px;">V49 ä¿®æ­£ç‰ˆ</p>
    <div id="status-text" style="color:#2ecc71; margin: 15px 0;">è¼‰å…¥ä¸­...</div>
    <button class="start-btn" onclick="initGameSafe()">é€²å…¥ä¸–ç•Œ</button>
    <div style="margin-top:20px; color:#555; cursor:pointer; text-decoration:underline; font-size:0.8rem;" onclick="hardReset()">é‡ç½®é€²åº¦ (Reset)</div>
</div>

<div class="modal" id="char-create-modal" style="z-index: 200;">
    <div class="modal-box">
        <h2 style="color:var(--accent);">é¸æ“‡æ‚¨çš„åŒ–èº«</h2>
        <div class="char-select-container" id="avatar-grid"></div>
        <button class="start-btn" onclick="confirmCharacter()">ç¢ºèªé¸æ“‡</button>
    </div>
</div>

<div class="app-container" id="app-ui" style="display:none;">
    <div class="top-header">
        <div class="top-bar">
            <div style="cursor:pointer;" onclick="toggleMute()" id="sound-btn">ğŸ”Š</div>
            <div class="gems">ğŸ’ <span id="ui-gems">0</span></div>
        </div>
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('char')">ğŸ‘¤ çµäºº</button>
            <button class="nav-btn" onclick="switchTab('battle')">âš”ï¸ æˆ°é¬¥</button>
            <button class="nav-btn" onclick="switchTab('gacha')">ğŸ’ å¯¶åº«</button>
        </div>
    </div>

    <div id="tab-char" class="content tab-page active">
        <div class="hero-summary">
            <div class="hero-avatar" id="ui-avatar">ğŸ¥·</div>
            <div class="hero-info">
                <div style="font-size:1.2rem; color:var(--accent);">
                    <span id="ui-name">Name</span> <span style="font-size:0.8rem; color:#aaa;" id="ui-job">Job</span>
                </div>
                <div style="font-size:0.8rem; background:#444; padding:2px 6px; border-radius:4px; display:inline-block; margin:2px 0;">Lv.<span id="ui-lvl">1</span></div>
                <div class="xp-container"><div class="xp-fill" id="ui-xp-bar"></div></div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">EXP: <span id="ui-xp-text">0/100</span></div>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-row"><span>âš”ï¸ æ”»æ“Š (ATK)</span><span id="stat-atk" style="color:#e74c3c">0</span></div>
            <div class="stat-row"><span>ğŸ›¡ï¸ é˜²ç¦¦ (DEF)</span><span id="stat-def" style="color:#3498db">0</span></div>
            <div class="stat-row"><span>â¤ï¸ ç”Ÿå‘½ (HP)</span><span id="stat-hp" style="color:#2ecc71">0</span></div>
            <div class="stat-row"><span>âš¡ æš´æ“Š (CRIT)</span><span id="stat-crit" style="color:#f1c40f">0%</span></div>
            <div class="stat-row"><span>ğŸ’¨ é–ƒé¿ (DODGE)</span><span id="stat-dodge" style="color:#9b59b6">0%</span></div>
            <div class="stat-row"><span>ğŸ€ å¹¸é‹ (LUCK)</span><span id="stat-luck" style="color:var(--luck)">0%</span></div>
            <div style="margin-top:10px; border-top:1px solid #444; padding-top:5px;">
                <div class="stat-row"><span>ğŸ¯ æ­£ç¢ºç‡</span><span id="stat-acc">0%</span></div>
                <div class="stat-row"><span>ğŸ“ ç¸½é¡Œæ•¸</span><span id="stat-total-q">0</span></div>
                <div class="stat-row"><span>ğŸ”¥ æœ€é«˜é€£å°</span><span id="stat-max-streak">0</span></div>
            </div>
        </div>

        <div class="equip-grid">
            <div class="equip-slot" id="slot-head" onclick="unequip('head')"><div class="slot-icon">â›‘ï¸</div><div class="slot-name">é ­ç›”</div></div>
            <div class="equip-slot" id="slot-body" onclick="unequip('body')"><div class="slot-icon">ğŸ‘•</div><div class="slot-name">é§ç”²</div></div>
            <div class="equip-slot" id="slot-gloves" onclick="unequip('gloves')"><div class="slot-icon">ğŸ§¤</div><div class="slot-name">è­·æ‰‹</div></div>
            <div class="equip-slot" id="slot-legs" onclick="unequip('legs')"><div class="slot-icon">ğŸ‘–</div><div class="slot-name">è­·è…¿</div></div>
            <div class="equip-slot" id="slot-feet" onclick="unequip('feet')"><div class="slot-icon">ğŸ‘¢</div><div class="slot-name">æˆ°é´</div></div>
            <div class="equip-slot" id="slot-accessory" onclick="unequip('accessory')"><div class="slot-icon">ğŸ’</div><div class="slot-name">é£¾å“</div></div>
            <div class="equip-slot" id="slot-weapon" onclick="unequip('weapon')"><div class="slot-icon">âš”ï¸</div><div class="slot-name">æ­¦å™¨</div></div>
            <div class="equip-slot" id="slot-offhand" onclick="unequip('offhand')"><div class="slot-icon">ğŸ›¡ï¸</div><div class="slot-name">é˜²å…·</div></div>
        </div>

        <div id="inventory-list" style="padding-bottom:50px;"></div>
    </div>

    <div id="tab-battle" class="content tab-page">
        <div id="map-select-screen">
            <div style="font-size:1.5rem; text-align:center; color:var(--primary); font-weight:bold; margin-bottom:15px;">é¸æ“‡ç‹©çµå€åŸŸ</div>
            <div class="map-grid" id="map-grid"></div>
        </div>

        <div id="battle-active-screen" style="display:none;">
            <div style="text-align:center; margin-top:5px;">
                <div style="font-size:4rem; filter:drop-shadow(0 0 30px #e74c3c); transition:0.2s;" id="boss-sprite">ğŸ‘¹</div>
                <div style="color:var(--primary); font-size:1.4rem; font-weight:bold;">
                    <span id="enemy-name">DEMON</span> <span style="font-size:1rem; color:#aaa;">Lv.<span id="enemy-level">1</span></span>
                </div>
                <div id="enemy-trait" style="font-size:0.8rem; color:#f1c40f; margin-bottom:5px; height:20px;"></div>
                
                <div class="hp-bar-container"><div id="boss-hp-bar" class="hp-fill" style="background:#c0392b;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-bottom:10px;">
                    <span>ENEMY</span><span id="boss-hp-text"></span>
                </div>

                <div class="hp-bar-container" style="height:8px;"><div id="player-hp-bar" class="hp-fill" style="background:#27ae60;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa;">
                    <span>PLAYER</span><span id="player-hp-text"></span>
                </div>
            </div>

            <div class="timer-track"><div class="timer-bar" id="battle-timer-bar"></div></div>
            <div id="quiz-area" style="margin-top:10px;"></div>
            
            <div id="post-answer-actions">
                <button class="start-btn" onclick="nextTurn()">â¡ï¸ ä¸‹ä¸€å›åˆ</button>
                <button class="start-btn btn-dict" id="btn-dict-link" onclick="openDictionary()">ğŸ” æ•™è‚²éƒ¨è¾­å…¸ (æŸ¥çœ‹è§£èªª)</button>
                <div style="text-align:center;"><button class="start-btn btn-fix" onclick="fixError()">ğŸ› ï¸ ä¿®æ­£ç­”æ¡ˆ (è£œè¡€)</button></div>
            </div>

            <div id="battle-tools" style="display:flex;">
                <button class="start-btn tool-btn" onclick="usePotion()">ğŸ§ª è£œè¡€ (<span id="btn-potion-count">0</span>)</button>
                <button class="start-btn tool-btn" onclick="useShield()">ğŸ›¡ï¸ è­·ç›¾ (<span id="btn-shield-count">0</span>)</button>
                <button class="start-btn tool-btn flee-btn" onclick="fleeBattle()">ğŸ³ï¸ æ’¤é€€</button>
            </div>
        </div>
    </div>

    <div id="tab-gacha" class="content tab-page">
        <div style="text-align:center; padding-top:40px;">
            <div style="font-size:7rem; margin-bottom:20px; filter:drop-shadow(0 0 30px var(--luck)); animation: float 3s infinite;">ğŸ</div>
            <h2 style="color:var(--accent);">å¹¸é‹å¯¶ç®±</h2>
            <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; display:inline-block; margin-bottom:15px; border:1px solid #444;">
                ç›®å‰æŒæœ‰ï¼š<span style="color:var(--accent); font-weight:bold; font-size:1.2rem;" id="gacha-gems-display">0</span> ğŸ’
            </div>
            <div style="font-size: 0.9rem; color: var(--luck); margin-bottom: 10px; font-weight: bold;">å¹¸é‹åŠ æˆ: +<span id="gacha-luck-val">0</span>%</div>
            <p style="color:#7f8fa6; margin-bottom:30px; font-size:0.9rem;">100 å¯¶çŸ³ / æ¬¡<br>è£å‚™ç­‰ç´šéš¨è§’è‰²ç­‰ç´šæå‡ï¼</p>
            <button class="start-btn" id="btn-gacha-pull" style="background:var(--luck); color:#000; position:relative;" onclick="pullGacha()">é–‹å•Ÿ (100ğŸ’)</button>
        </div>
    </div>

    <div class="modal" id="daily-login-modal">
        <div class="modal-box" style="border-color: var(--luck);">
            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“…</div>
            <h2 style="color:var(--luck); margin:0;">æ¯æ—¥ç°½åˆ°</h2>
            <p style="color:#aaa; font-size:0.8rem;">é€£çºŒç™»å…¥ï¼š<span id="login-streak-num" style="color:#fff; font-weight:bold;">1</span> å¤©</p>
            <div class="daily-grid" id="daily-list"></div>
            <div id="today-reward-msg" style="color:#fff; margin-bottom:15px; font-weight:bold;"></div>
            <button class="start-btn" onclick="closeDailyModal()">é ˜å–çå‹µ</button>
        </div>
    </div>

    <div class="modal" id="enhance-modal">
        <div class="modal-box" style="border-color: var(--enhance);">
            <div style="font-size:3rem; margin-bottom:5px;">âš’ï¸</div>
            <h2 style="color:var(--enhance); margin:0 0 10px 0;">è£å‚™å¼·åŒ–</h2>
            <div id="enhance-info" style="color:#ddd; font-size:0.9rem; margin-bottom:15px; text-align:left;"></div>
            <button class="start-btn" style="background:var(--enhance);" onclick="doEnhance()">å¼·åŒ– (æ¶ˆè€—ğŸ’)</button>
            <button class="start-btn btn-secondary" onclick="closeEnhanceModal()" style="margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="modal" id="battle-result-modal"><div class="modal-box"></div></div>
</div>

<script>
/**
 * éŠæˆ²å¼•æ“ V49 (ç™¾å±¤å¡”å‚³èªª + ä¿®æ­£è¨ˆæ™‚æ‰£è¡€Bug)
 */

const AudioEngine = {
    ctx: null, isMuted: false, intervalId: null, step: 0,
    init: function() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },
    playTone: function(freq, type, duration, vol=0.1, detune=0) {
        if(this.isMuted || !this.ctx) return;
        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime); if(detune) osc.detune.value = detune;
        gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + duration);
    },
    playNoise: function(duration, vol) {
        if(this.isMuted || !this.ctx) return;
        const b = this.ctx.createBuffer(1, this.ctx.sampleRate*duration, this.ctx.sampleRate);
        const d = b.getChannelData(0); for(let i=0;i<b.length;i++) d[i]=Math.random()*2-1;
        const n = this.ctx.createBufferSource(); n.buffer=b; const g=this.ctx.createGain(); g.gain.value=vol;
        n.connect(g); g.connect(this.ctx.destination); n.start();
    },
    sfx: {
        click: () => AudioEngine.playTone(800, 'sine', 0.05, 0.05),
        confirm: () => { AudioEngine.playTone(600, 'square', 0.1); setTimeout(()=>AudioEngine.playTone(800, 'square', 0.1), 100); },
        coin: () => { AudioEngine.playTone(1500, 'sine', 0.1); setTimeout(()=>AudioEngine.playTone(2000, 'sine', 0.2), 50); },
        enhance: () => { [400,500,600,800].forEach((f,i)=>setTimeout(()=>AudioEngine.playTone(f,'square',0.1,0.1),i*100)); },
        enhanceFail: () => { AudioEngine.playTone(150, 'sawtooth', 0.5); },
        gacha: () => { [523,659,783,1046,1318].forEach((f,i)=>setTimeout(()=>AudioEngine.playTone(f,'triangle',0.2,0.1),i*80)); },
        attack: () => { AudioEngine.playNoise(0.15, 0.3); AudioEngine.playTone(100, 'sawtooth', 0.2, 0.2); },
        hit: () => { AudioEngine.playTone(80, 'sawtooth', 0.3, 0.4); },
        win: () => { AudioEngine.playTone(660, 'sine', 0.1); setTimeout(()=>AudioEngine.playTone(880, 'sine', 0.3), 100); },
        wrong: () => { AudioEngine.playTone(150, 'sawtooth', 0.2); setTimeout(()=>AudioEngine.playTone(100, 'sawtooth', 0.2), 100); },
        tick: () => AudioEngine.playTone(1000, 'square', 0.05, 0.05),
        ult: () => { AudioEngine.playNoise(0.5, 0.5); [100, 200, 100].forEach((f,i)=> setTimeout(()=>AudioEngine.playTone(f, 'sawtooth', 0.2, 0.5), i*100)); },
        victoryTheme: () => { AudioEngine.stopBGM(); [523, 523, 523, 659, 783, 1046].forEach((f,i)=> setTimeout(()=>AudioEngine.playTone(f, 'square', 0.4, 0.2), i*180)); }
    },
    playBGM: function(isBattle) {
        if(this.intervalId) clearInterval(this.intervalId);
        if(this.isMuted) return;
        this.step = 0;
        const speed = isBattle ? 115 : 300; 
        const BASS_LINE = [65.4, 65.4, 65.4, 65.4, 65.4, 65.4, 65.4, 65.4, 103.8, 103.8, 103.8, 103.8, 87.3, 87.3, 98.0, 116.5];
        this.intervalId = setInterval(() => {
            if(this.isMuted) return;
            if (isBattle) {
                if (this.step % 4 === 0) { AudioEngine.playTone(150, 'sine', 0.1, 0.8); AudioEngine.playTone(50, 'sine', 0.1, 0.8); }
                if (this.step % 8 === 4) AudioEngine.playNoise(0.1, 0.3);
                if (this.step % 2 === 0) { const bass = BASS_LINE[Math.floor(this.step/16) % BASS_LINE.length]; AudioEngine.playTone(bass, 'sawtooth', 0.2, 0.15); AudioEngine.playTone(bass, 'sawtooth', 0.2, 0.15, 10); }
                if (Math.floor(this.step/16) >= 2) { const ms = this.step % 32; let l = 0; if(ms===0)l=523.25; if(ms===6)l=622.25; if(ms===12)l=783.99; if(ms===16)l=698.46; if(l) AudioEngine.playTone(l, 'square', 0.2, 0.08); }
            } else {
                if (this.step % 8 === 0) { const n = [261, 293, 329, 392][Math.floor(this.step/8)%4]; AudioEngine.playTone(n, 'sine', 1.5, 0.05); AudioEngine.playTone(n*1.5, 'sine', 1.5, 0.03); }
            }
            this.step++;
        }, speed);
    },
    stopBGM: function() { if(this.intervalId) clearInterval(this.intervalId); }
};

// --- Game Data ---
const JOB_DATA = {
    knight: { name:'å¸åœ‹é¨å£«', desc:'æ”»å®ˆå¹³è¡¡', growth:{atk:1.2, def:1.2, hp:1.0, luck:1.0, crit:0, dodge:0} },
    guardian: { name:'ç›¾ç‰Œè­·è¡›', desc:'é˜²ç¦¦è¡€é‡', growth:{atk:0.8, def:1.5, hp:1.5, luck:1.0, crit:0, dodge:0} },
    shaman: { name:'éƒ¨è½å·«å¸«', desc:'å°‹å¯¶å°ˆå®¶', growth:{atk:1.3, def:0.8, hp:0.8, luck:1.5, crit:0, dodge:0} },
    hunter: { name:'æ£®æ—çµäºº', desc:'æš´åŠ›è¼¸å‡º', growth:{atk:1.4, def:0.8, hp:0.9, luck:1.0, crit:2, dodge:0} },
    assassin: { name:'çš‡å®¶åˆºå®¢', desc:'é–ƒé¿æ®ºæ‰‹', growth:{atk:1.2, def:0.7, hp:0.8, luck:1.0, crit:1.5, dodge:2} }
};
const PRESET_CHARS = [
    { n:'äºç‘Ÿ', i:'ğŸ¤´', job:'knight' }, { n:'è²å¾·', i:'ğŸ‘¸', job:'knight' },
    { n:'éµå£', i:'ğŸ‘®', job:'guardian' }, { n:'é‹¼ç›¾', i:'ğŸ‘·â€â™€ï¸', job:'guardian' },
    { n:'æ¢…æ—', i:'ğŸ§™â€â™‚ï¸', job:'shaman' }, { n:'æ‘©æ ¹', i:'ğŸ§šâ€â™€ï¸', job:'shaman' },
    { n:'ç¾…è³“', i:'ğŸ¹', job:'hunter' }, { n:'äºç‰¹', i:'ğŸ¦¸â€â™€ï¸', job:'hunter' },
    { n:'åŠè—', i:'ğŸ¥·', job:'assassin' }, { n:'é»‘å¯¡å©¦',i:'ğŸ•µï¸â€â™€ï¸', job:'assassin' }
];

// Expanded Monster DB (33 Monsters)
const MONSTERS = {
    // Lv 1-10
    m01: { n:'å²èŠå§†', i:'ğŸ’§', hp:30, atk:5, xp:10, t:'' },
    m02: { n:'è™è ', i:'ğŸ¦‡', hp:40, atk:8, xp:12, t:'' },
    m03: { n:'é‡é¼ ', i:'ğŸ€', hp:35, atk:10, xp:15, t:'' },
    // Lv 10-20
    m04: { n:'é­”ç‹¼', i:'ğŸº', hp:80, atk:15, xp:30, t:'G' },
    m05: { n:'å·¨èœ˜è››', i:'ğŸ•·ï¸', hp:100, atk:18, xp:35, t:'' },
    m06: { n:'æ¯’è›‡', i:'ğŸ', hp:90, atk:22, xp:40, t:'S' },
    // Lv 20-30
    m07: { n:'éª·é«å…µ', i:'ğŸ’€', hp:150, atk:25, xp:60, t:'' },
    m08: { n:'æ®­å±', i:'ğŸ§Ÿ', hp:200, atk:20, xp:65, t:'H' },
    m09: { n:'å¹½éˆ', i:'ğŸ‘»', hp:120, atk:35, xp:70, t:'S' },
    // Lv 30-40
    m10: { n:'å²©çŸ³é­”åƒ', i:'ğŸ—¿', hp:400, atk:30, xp:100, t:'T' },
    m11: { n:'åŠç¸äºº', i:'ğŸ‘¹', hp:350, atk:45, xp:110, t:'' },
    m12: { n:'å“¥å¸ƒæ—ç‹', i:'ğŸ‘º', hp:300, atk:50, xp:120, t:'G' },
    // Lv 40-50
    m13: { n:'å¸è¡€é¬¼', i:'ğŸ§›', hp:500, atk:60, xp:180, t:'H' },
    m14: { n:'çŸ³åƒé¬¼', i:'ğŸ¦‡', hp:600, atk:55, xp:190, t:'T' },
    m15: { n:'é»‘é­”å¥³', i:'ğŸ§™â€â™€ï¸', hp:450, atk:80, xp:200, t:'G' },
    // Lv 50-60
    m16: { n:'èœ¥èœ´äºº', i:'ğŸ¦', hp:800, atk:70, xp:300, t:'H' },
    m17: { n:'ä¹é ­è›‡', i:'ğŸ‰', hp:1000, atk:80, xp:320, t:'R' },
    m18: { n:'éµç”²é¾œ', i:'ğŸ¢', hp:1500, atk:50, xp:350, t:'T' },
    // Lv 60-70
    m19: { n:'é›ªæ€ª', i:'ğŸ¦', hp:1200, atk:100, xp:450, t:'T' },
    m20: { n:'å†°é­”åƒ', i:'â›„', hp:1400, atk:90, xp:480, t:'R' },
    m21: { n:'éœœç‹¼', i:'ğŸº', hp:1000, atk:120, xp:500, t:'G' },
    // Lv 70-80
    m22: { n:'æœ¨ä¹ƒä¼Š', i:'ğŸ¤•', hp:1800, atk:110, xp:650, t:'T' },
    m23: { n:'å·¨è ', i:'ğŸ¦‚', hp:1600, atk:130, xp:700, t:'R' },
    m24: { n:'é˜¿åŠªæ¯”æ–¯', i:'ğŸ¶', hp:2000, atk:150, xp:800, t:'S' },
    // Lv 80-90
    m25: { n:'æƒ¡é­”', i:'ğŸ‘¿', hp:3000, atk:200, xp:1000, t:'H' },
    m26: { n:'é­…é­”', i:'ğŸ§šâ€â™€ï¸', hp:2500, atk:250, xp:1100, t:'G' },
    m27: { n:'åœ°ç„çŠ¬', i:'ğŸ•', hp:2800, atk:220, xp:1200, t:'G' },
    // Lv 90-100
    m28: { n:'ç´…é¾', i:'ğŸ²', hp:5000, atk:300, xp:2000, t:'B' },
    m29: { n:'é³³å‡°', i:'ğŸ¦…', hp:4500, atk:350, xp:2200, t:'H' },
    m30: { n:'è™›ç©ºè¡Œè€…', i:'ğŸ‘½', hp:6000, atk:400, xp:2500, t:'S' },
    // Lv 100 Final
    m31: { n:'æ··æ²Œç¥', i:'ğŸŒŒ', hp:10000, atk:600, xp:5000, t:'B' }
};

// 11 Maps (Every 10 levels)
const MAPS = [
    { id:'m1', n:'æ–°æ‰‹æ‘ (Lv.1)', minLvl:1, icon:'ğŸ›–', mons:['m01','m02','m03'] },
    { id:'m2', n:'è¿·éœ§æ£®æ— (Lv.10)', minLvl:10, icon:'ğŸŒ²', mons:['m04','m05','m06'] },
    { id:'m3', n:'è’æ¶¼å¢“åœ’ (Lv.20)', minLvl:20, icon:'ğŸª¦', mons:['m07','m08','m09'] },
    { id:'m4', n:'å²©çŸ³å³½è°· (Lv.30)', minLvl:30, icon:'â›°ï¸', mons:['m10','m11','m12'] },
    { id:'m5', n:'å¸è¡€å¤å ¡ (Lv.40)', minLvl:40, icon:'ğŸ°', mons:['m13','m14','m15'] },
    { id:'m6', n:'åŠ‡æ¯’æ²¼æ¾¤ (Lv.50)', minLvl:50, icon:'ğŸŠ', mons:['m16','m17','m18'] },
    { id:'m7', n:'æ¥µå¯’å†°åŸ (Lv.60)', minLvl:60, icon:'â„ï¸', mons:['m19','m20','m21'] },
    { id:'m8', n:'é»ƒæ²™éºè·¡ (Lv.70)', minLvl:70, icon:'ğŸ•Œ', mons:['m22','m23','m24'] },
    { id:'m9', n:'ç‡ƒç‡’åœ°ç„ (Lv.80)', minLvl:80, icon:'ğŸ”¥', mons:['m25','m26','m27'] },
    { id:'m10', n:'å·¨é¾å·¢ç©´ (Lv.90)', minLvl:90, icon:'ğŸŒ‹', mons:['m28','m29','m30'] },
    { id:'m11', n:'è™›ç©ºä¹‹é–€ (Lv.100)', minLvl:100, icon:'ğŸŒŒ', mons:['m30','m28','m31'] }
];

const DAILY_REWARDS = [ {t:'gems',v:30,i:'ğŸ’',n:'å¯¶çŸ³'}, {t:'xp',v:50,i:'âœ¨',n:'ç¶“é©—'}, {t:'potion',v:2,i:'ğŸ§ª',n:'è—¥æ°´'}, {t:'gems',v:50,i:'ğŸ’',n:'å¯¶çŸ³'}, {t:'xp',v:100,i:'âœ¨',n:'ç¶“é©—'}, {t:'shield',v:2,i:'ğŸ›¡ï¸',n:'è­·ç›¾'}, {t:'ticket',v:1,i:'ğŸ«',n:'å…è²»æŠ½'} ];

let player = {
    name: "Hunter", avatar: "ğŸ¥·", job: "knight", gems: 100, xp: 0, level: 1, inventory: [], equipped: {}, potions: 3, shields: 1, lastLogin: "", loginStreak: 0, gachaTickets: 0,
    totalQ: 0, correctQ: 0, maxStreak: 0
};
let battle = { active: false, mapId: 'm1', timerId: null, timeLeft: 30, lastDamage: 0, stats: {} };
let questionBank = [], customCorrections = {}, selectedCharIndex = 0, enhanceTargetIdx = -1;

function initGameSafe() {
    AudioEngine.init(); AudioEngine.sfx.click(); AudioEngine.playBGM(false); 
    loadData(); parseQuestionBank(); renderMaps();
    if (!player.job || player.name === "Hunter") { document.getElementById('cover-screen').style.display = 'none'; showCharacterCreation(); }
    else { updateUI(); document.getElementById('cover-screen').style.display = 'none'; document.getElementById('app-ui').style.display = 'flex'; checkDailyLogin(); }
}

function loadData() {
    const d = JSON.parse(localStorage.getItem('rpg_v49_save'));
    if (d) { player = { ...player, ...d.player }; if(!player.totalQ) player.totalQ=0; }
    const fixes = JSON.parse(localStorage.getItem('rpg_fixes')); if(fixes) customCorrections = fixes;
}
function saveData() { localStorage.setItem('rpg_v49_save', JSON.stringify({ player })); }
function saveCorrections() { localStorage.setItem('rpg_fixes', JSON.stringify(customCorrections)); }
function hardReset() { if(confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é€²åº¦å—ï¼Ÿ')) { localStorage.removeItem('rpg_v49_save'); location.reload(); } }

// --- Character & Stats ---
function showCharacterCreation() {
    const grid = document.getElementById('avatar-grid'); grid.innerHTML = '';
    PRESET_CHARS.forEach((char, idx) => {
        const job = JOB_DATA[char.job]; const div = document.createElement('div'); div.className = 'char-card';
        div.onclick = () => { AudioEngine.sfx.click(); selectChar(div, idx); };
        div.innerHTML = `<div class="char-card-icon">${char.i}</div><div class="char-card-info"><div class="char-card-name">${char.n}</div><div class="char-card-job">${job.name}</div><div class="char-card-desc">${job.desc}</div></div>`;
        grid.appendChild(div);
    });
    selectChar(grid.children[0], 0); document.getElementById('char-create-modal').style.display = 'flex';
}
function selectChar(el, idx) { document.querySelectorAll('.char-card').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); selectedCharIndex = idx; }
function confirmCharacter() { AudioEngine.sfx.confirm(); const char = PRESET_CHARS[selectedCharIndex]; player.name = char.n; player.avatar = char.i; player.job = char.job; saveData(); document.getElementById('char-create-modal').style.display = 'none'; document.getElementById('app-ui').style.display = 'flex'; updateUI(); checkDailyLogin(); }

function parseQuestionBank() {
    if(typeof window.MOE_DATA_STRING !== 'undefined') {
        let raw = window.MOE_DATA_STRING.replace(/2/g, 'ËŠ').replace(/3/g, 'Ë‡').replace(/4/g, 'Ë‹').replace(/5/g, 'Ë™');
        const lines = raw.trim().split('\n'); questionBank = [];
        lines.forEach(line => {
            let p = line.split('|'); if(p.length < 4) return;
            const clean = (s) => s.replace(/1/g, '').replace(/2/g, 'ËŠ').replace(/3/g, 'Ë‡').replace(/4/g, 'Ë‹').replace(/5/g, 'Ë™');
            let type = p[0], q = p[1], a = p[2], w = p[3]; if (type === '1') q = clean(q); else { a = clean(a); w = clean(w); }
            if(customCorrections[q]) a = customCorrections[q];
            questionBank.push({ type: type, q: q, a: a, w: w.split(',') });
        });
    } else {
        questionBank = [{q:'è³‡æ–™åº«æœªè®€å–', a:'è«‹ç¢ºä¿æª”æ¡ˆåŒç›®éŒ„', w:['éŒ¯èª¤']}];
        alert("âš ï¸ éŒ¯èª¤ï¼šç„¡æ³•è®€å– moe_data.js\nè«‹ç¢ºä¿è©²æª”æ¡ˆèˆ‡å­—éˆçµäºº.html ä½æ–¼åŒä¸€å€‹è³‡æ–™å¤¾ä¸­ï¼");
    }
}

function checkDailyLogin() {
    const today = new Date().toDateString(); if (player.lastLogin === today) return;
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
    if (player.lastLogin === yesterday.toDateString()) player.loginStreak++; else player.loginStreak = 1;
    const reward = DAILY_REWARDS[(player.loginStreak - 1) % 7];
    if(reward.t === 'gems') player.gems += reward.v; if(reward.t === 'xp') addXp(reward.v); if(reward.t === 'potion') player.potions += reward.v; if(reward.t === 'shield') player.shields += reward.v; if(reward.t === 'ticket') player.gachaTickets += reward.v;
    player.lastLogin = today; saveData(); updateUI();
    const list = document.getElementById('daily-list'); list.innerHTML = '';
    DAILY_REWARDS.forEach((r, idx) => {
        const div = document.createElement('div'); let cls = 'daily-day'; if (idx < (player.loginStreak-1)%7) cls += ' claimed'; if (idx === (player.loginStreak-1)%7) cls += ' active';
        div.className = cls; div.innerHTML = `<div class="daily-icon">${r.i}</div><div class="daily-txt">${idx+1}å¤©<br>${r.n}x${r.v}</div>`; list.appendChild(div);
    });
    document.getElementById('today-reward-msg').innerText = `ç²å¾—ï¼š${reward.n} x${reward.v}`; document.getElementById('daily-login-modal').style.display = 'flex';
}
function closeDailyModal() { AudioEngine.sfx.confirm(); document.getElementById('daily-login-modal').style.display = 'none'; }

function getStats() {
    const job = JOB_DATA[player.job] || JOB_DATA.knight; const growth = job.growth;
    let base = { hp: Math.floor(100 + (player.level * 10 * growth.hp)), atk: Math.floor(10 + (player.level * 2 * growth.atk)), def: Math.floor(5 + (player.level * 1 * growth.def)), crit: 5 + (player.level * growth.crit), dodge: 5 + (player.level * growth.dodge), luck: 0 + (player.level * growth.luck) };
    Object.values(player.equipped).forEach(item => {
        if(item) {
            let mult = 1 + (item.level||0) * 0.1; 
            base.hp += Math.floor((item.hp||0)*mult); base.atk += Math.floor((item.atk||0)*mult); base.def += Math.floor((item.def||0)*mult); base.crit += (item.crit||0); base.dodge += (item.dodge||0); base.luck += (item.luck||0);
            if(item.bonus) { Object.keys(item.bonus).forEach(k => base[k] += item.bonus[k]); }
        }
    });
    base.crit = Math.min(100, Math.floor(base.crit)); base.dodge = Math.min(80, Math.floor(base.dodge)); base.luck = Math.floor(base.luck);
    return base;
}

function updateUI() {
    const s = getStats(); const acc = player.totalQ > 0 ? Math.round((player.correctQ/player.totalQ)*100) : 0;
    document.getElementById('ui-gems').innerText = player.gems; document.getElementById('ui-lvl').innerText = player.level;
    document.getElementById('ui-xp-text').innerText = `${player.xp}/${player.level*100}`; document.getElementById('ui-xp-bar').style.width = `${(player.xp/(player.level*100))*100}%`;
    document.getElementById('ui-name').innerText = player.name; document.getElementById('ui-avatar').innerText = player.avatar; document.getElementById('ui-job').innerText = JOB_DATA[player.job].name;
    document.getElementById('stat-atk').innerText = s.atk; document.getElementById('stat-def').innerText = s.def; document.getElementById('stat-hp').innerText = s.hp;
    document.getElementById('stat-crit').innerText = s.crit + "%"; document.getElementById('stat-dodge').innerText = s.dodge + "%"; document.getElementById('stat-luck').innerText = s.luck + "%";
    document.getElementById('stat-acc').innerText = acc + "%"; document.getElementById('stat-total-q').innerText = player.totalQ; document.getElementById('stat-max-streak').innerText = player.maxStreak || 0;
    document.getElementById('gacha-gems-display').innerText = player.gems;
    document.getElementById('gacha-luck-val').innerText = getStats().luck;

    const names = {head:'é ­ç›”',body:'é§ç”²',legs:'è­·è…¿',feet:'æˆ°é´',gloves:'è­·æ‰‹',weapon:'æ­¦å™¨',offhand:'ç›¾ç‰Œ',accessory:'é£¾å“'};
    ['head','body','legs','feet','gloves','weapon','offhand','accessory'].forEach(slot => {
        const el = document.getElementById(`slot-${slot}`); const item = player.equipped[slot];
        if (item) { el.innerHTML = `<div class="slot-icon">${item.icon}${item.level?`<span class="enhance-badge">+${item.level}</span>`:''}</div><div class="slot-name">${item.name}</div>`; el.className='equip-slot slot-equipped'; } 
        else { el.innerHTML = `<div class="slot-icon">${{head:'â›‘ï¸',body:'ğŸ‘•',legs:'ğŸ‘–',feet:'ğŸ‘¢',gloves:'ğŸ§¤',weapon:'âš”ï¸',offhand:'ğŸ›¡ï¸',accessory:'ğŸ’'}[slot]}</div><div class="slot-name">${names[slot]}</div>`; el.className='equip-slot'; }
    });

    const invDiv = document.getElementById('inventory-list'); invDiv.innerHTML = '';
    player.inventory.forEach((item, idx) => {
        const d = document.createElement('div'); d.className = 'inv-item';
        d.innerHTML = `<div style="font-size:1.5rem; margin-right:10px;">${item.icon}</div><div><div style="font-weight:bold; color:${getRarityColor(item.rarity)}">${item.name} ${item.level?`+${item.level}`:''}</div><div style="font-size:0.7rem; color:#aaa;">${getItemDesc(item)}</div></div><div class="inv-actions"><button class="btn-action btn-equip" onclick="equipItem(${idx})">è£å‚™</button><button class="btn-action btn-enhance" onclick="openEnhance(${idx})">å¼·åŒ–</button><button class="btn-action btn-sell" onclick="sellItem(${idx})">å‡ºå”®</button></div>`;
        invDiv.appendChild(d);
    });
    
    const gachaBtn = document.getElementById('btn-gacha-pull');
    if (player.gachaTickets > 0) { gachaBtn.innerHTML = `é–‹å•Ÿ <span style="font-size:0.8rem">(ğŸ« x${player.gachaTickets})</span><div class="gacha-ticket-badge">å…è²»</div>`; gachaBtn.style.background = "linear-gradient(45deg, #f1c40f, #e67e22)"; } 
    else { gachaBtn.innerHTML = `é–‹å•Ÿ (100ğŸ’)`; gachaBtn.style.background = "var(--luck)"; }
}

function getRarityColor(r) { return r===3?'#e74c3c':(r===2?'#f1c40f':(r===1?'#3498db':'#fff')); }
function getItemDesc(i) { let s=[]; if(i.atk) s.push(`æ”»+${i.atk}`); if(i.def) s.push(`é˜²+${i.def}`); if(i.hp) s.push(`å‘½+${i.hp}`); if(i.luck) s.push(`é‹+${i.luck}`); return s.join(' '); }

// --- Map & Battle System ---
function renderMaps() {
    const grid = document.getElementById('map-grid'); grid.innerHTML = '';
    MAPS.forEach(m => {
        const div = document.createElement('div');
        const unlockLvl = player.level + 5; // Allow challenge if level+5 >= map level
        const isLocked = unlockLvl < m.minLvl;
        div.className = `map-card ${isLocked ? 'locked' : ''}`;
        div.innerHTML = `
            <div class="map-icon">${isLocked ? 'ğŸ”’' : m.icon}</div>
            <div class="map-name">${m.n}</div>
            <div class="map-monsters" style="${isLocked?'color:#e74c3c':''}">${isLocked ? `éœ€ç­‰ç´š ${m.minLvl}` : `Lv.${m.minLvl}+`}</div>
        `;
        div.onclick = () => { 
            AudioEngine.sfx.click(); 
            if(isLocked) { alert(`ç­‰ç´šä¸è¶³ï¼éœ€ç­‰ç´š ${m.minLvl}`); return; }
            startBattleSequence(m.id); 
        };
        grid.appendChild(div);
    });
}

function startBattleSequence(mapId) {
    if(mapId) battle.mapId = mapId;
    AudioEngine.playBGM(true);
    document.getElementById('map-select-screen').style.display = 'none';
    document.getElementById('battle-active-screen').style.display = 'block';
    
    const map = MAPS.find(m => m.id === battle.mapId);
    const mKey = map.mons[Math.floor(Math.random()*map.mons.length)];
    const mData = MONSTERS[mKey];
    
    // Boss Mutation: 5% Chance
    const isBoss = Math.random() < 0.05;
    const hpMult = isBoss ? 5 : 1; const atkMult = isBoss ? 1.5 : 1;
    
    battle = {
        active: true, mapId: battle.mapId, monster: mData, isBoss: isBoss,
        maxHp: mData.hp * hpMult, bossHp: mData.hp * hpMult, playerHp: getStats().hp,
        shieldTurns: 0, currentQ: null, timerId: null, timeLeft: 30, lastDamage: 0,
        stats: { turns: 0, correct: 0, maxCombo: 0, currCombo: 0, dmgTaken: 0, dmgDealt: 0 }
    };
    
    let traitText = "";
    if(mData.t==='T') traitText="ğŸ›¡ï¸ å …ç¡¬ (é«˜é˜²ç¦¦)";
    if(mData.t==='R') traitText="ğŸŒµ å°–åˆº (åå½ˆå‚·å®³)";
    if(mData.t==='H') traitText="â¤ï¸ å†ç”Ÿ (æ¯å›åˆå›è¡€)";
    if(mData.t==='S') traitText="ğŸ‘» è™›ç„¡ (é«˜é–ƒé¿)";
    if(mData.t==='G') traitText="âš”ï¸ ç‹‚æš´ (é«˜æ”»è–„è¡€)";
    if(mData.t==='B') traitText="â˜ ï¸ å‚³èªªç”Ÿç‰©";
    
    if(isBoss) traitText = "ğŸ‘‘ ç‹è€…é™è‡¨ï¼å…¨èƒ½åŠ›å¤§å¹…æå‡ï¼";

    document.getElementById('enemy-trait').innerText = traitText;
    document.getElementById('boss-sprite').innerText = mData.i;
    document.getElementById('boss-sprite').style.transform = isBoss ? 'scale(2.0)' : 'scale(1.5)';
    document.getElementById('boss-sprite').style.filter = isBoss ? 'drop-shadow(0 0 10px red)' : 'none';
    
    document.getElementById('enemy-name').innerText = (isBoss ? "ç‹è€… " : "") + mData.n; 
    document.getElementById('enemy-name').style.color = isBoss ? "#e74c3c" : "var(--primary)";
    
    document.getElementById('enemy-level').innerText = Math.max(1, map.minLvl + Math.floor(Math.random()*5));
    document.getElementById('battle-tools').style.display = 'flex';
    
    updateBattleUI(); loadQuestion();
}

function updateBattleUI() {
    const b = battle;
    const pPct = Math.max(0, (b.playerHp / getStats().hp)*100); const mPct = Math.max(0, (b.bossHp / b.maxHp)*100);
    document.getElementById('player-hp-bar').style.width = `${pPct}%`; document.getElementById('player-hp-text').innerText = `${Math.floor(b.playerHp)}/${getStats().hp}`;
    document.getElementById('boss-hp-bar').style.width = `${mPct}%`; document.getElementById('boss-hp-text').innerText = `${Math.floor(b.bossHp)}/${b.maxHp}`;
    document.getElementById('btn-potion-count').innerText = player.potions; document.getElementById('btn-shield-count').innerText = player.shields;
}

function loadQuestion() {
    if(!battle.active) return;
    if(battle.timerId) clearInterval(battle.timerId);
    
    const mapInfo = MAPS.find(m => m.id === battle.mapId);
    let limit = 30 - Math.floor(mapInfo.minLvl / 5); 
    if(limit < 10) limit = 10;
    battle.timeLeft = limit;
    
    document.getElementById('battle-timer-bar').style.width = '100%';
    document.getElementById('battle-timer-bar').style.background = '#00d2d3';
    
    battle.timerId = setInterval(() => {
        if(!battle.active) return;
        battle.timeLeft--;
        const pct = (battle.timeLeft / limit) * 100;
        const bar = document.getElementById('battle-timer-bar');
        bar.style.width = `${pct}%`;
        if(battle.timeLeft < 5) { bar.style.background = '#e74c3c'; AudioEngine.sfx.tick(); }
        
        if(battle.timeLeft <= 0) {
            clearInterval(battle.timerId);
            // Time OUT: FORCE WRONG ANSWER (string 'TIMEOUT') so it triggers monsterAttack
            handleAns(null, null, 'TIMEOUT_FORCE_WRONG'); 
        }
    }, 1000);

    document.getElementById('post-answer-actions').style.display = 'none'; 
    const q = questionBank[Math.floor(Math.random()*questionBank.length)]; battle.currentQ = q; 
    const options = [q.a, ...q.w].sort(()=>Math.random()-0.5);
    
    let html = `<div class="quiz-panel"><div style="font-size:1.2rem; text-align:center; margin-bottom:15px; color:#fff;">${q.q}</div>`;
    options.forEach(opt => { html += `<button class="opt-btn" onclick="handleAns(this, '${opt}', '${q.a}')">${opt}</button>`; });
    html += `</div>`;
    document.getElementById('quiz-area').innerHTML = html;
}

function handleAns(btn, choice, ans) {
    if(!battle.active) return;
    clearInterval(battle.timerId);
    document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
    
    battle.stats.turns++;
    battle.lastDamage = 0;
    player.totalQ++;

    if(choice === ans) { 
        if(btn) btn.style.background = "#27ae60";
        player.correctQ++;
        battle.stats.correct++; battle.stats.currCombo++;
        if(battle.stats.currCombo > player.maxStreak) player.maxStreak = battle.stats.currCombo;
        
        const stats = getStats();
        const isCrit = Math.random()*100 < stats.crit;
        let dmg = Math.floor(stats.atk * (isCrit?1.5:1) * (1 + battle.stats.currCombo*0.1));
        
        if(battle.monster.t === 'T') dmg = Math.floor(dmg * 0.7); 
        if(battle.isBoss) dmg = Math.floor(dmg * 0.8);

        if(battle.monster.t === 'S' && Math.random() < 0.3) { 
            dmg = 0; showFloatText("MISS (è™›ç„¡)!", "#aaa"); 
        } else if (battle.isBoss && Math.random() < 0.2) {
            dmg = 0; showFloatText("BOSS é–ƒé¿!", "#e74c3c");
        } else {
            battle.bossHp -= dmg; battle.stats.dmgDealt += dmg;
            AudioEngine.sfx.attack();
            document.getElementById('boss-sprite').className = 'anim-monster-hit';
            setTimeout(()=>document.getElementById('boss-sprite').className='', 400);
            showFloatText(isCrit?`çˆ†æ“Š ${dmg}!`:`${dmg}`, "#f1c40f");
            
            if(battle.monster.t === 'R') {
                const ref = Math.floor(dmg * 0.2);
                if(ref > 0) { playerHpChange(-ref); showFloatText(`åå‚· -${ref}`, "#e74c3c"); }
            }
        }
    } else { 
        if(btn) btn.style.background = "#c0392b";
        battle.stats.currCombo = 0;
        AudioEngine.sfx.wrong();
        if(choice === null) showFloatText("æ™‚é–“åˆ°!", "#e74c3c");
        else showFloatText("å¤±èª¤", "#aaa");
        monsterAttack();
    }
    
    if(battle.monster.t === 'H' && battle.bossHp > 0) {
        const heal = Math.floor(battle.maxHp * 0.05);
        battle.bossHp = Math.min(battle.maxHp, battle.bossHp + heal);
        showFloatText(`å†ç”Ÿ +${heal}`, "#2ecc71");
    }

    updateBattleUI(); saveData(); 
    document.getElementById('post-answer-actions').style.display = 'flex';
}

function monsterAttack() {
    if(battle.shieldTurns > 0) { battle.shieldTurns--; showFloatText("æ ¼æ“‹!", "#3498db"); return; }
    if(Math.random()*100 < getStats().dodge) { showFloatText("é–ƒé¿!", "#9b59b6"); return; }
    
    let mAtk = battle.monster.atk + (MAPS.find(m=>m.id===battle.mapId).minLvl * 2);
    if(battle.isBoss) mAtk *= 1.5; 

    let dmg = Math.floor(mAtk - (getStats().def * 0.3));
    dmg = Math.max(1, dmg);

    if(battle.isBoss && Math.random() < 0.3) {
        dmg = Math.floor(dmg * 2.5);
        AudioEngine.sfx.ult();
        document.getElementById('boss-sprite').className = 'anim-boss-ult';
        setTimeout(()=>document.getElementById('boss-sprite').className='', 800);
        showFloatText("BOSS å¿…æ®ºæŠ€!!", "#e74c3c");
    }

    playerHpChange(-dmg);
    battle.stats.dmgTaken += dmg; battle.lastDamage = dmg; 
    
    AudioEngine.sfx.hit();
    document.querySelector('.app-container').className = 'app-container anim-player-hit';
    setTimeout(()=>document.querySelector('.app-container').className='app-container', 500);
    showFloatText(`-${dmg}`, "#e74c3c");
}

function playerHpChange(val) {
    const max = getStats().hp;
    battle.playerHp = Math.min(max, battle.playerHp + val);
}

function nextTurn() {
    AudioEngine.sfx.click();
    if(battle.bossHp <= 0) winBattle();
    else if(battle.playerHp <= 0) loseBattle();
    else loadQuestion();
}

function winBattle() {
    battle.active = false; AudioEngine.sfx.victoryTheme();
    const m = battle.monster; 
    let xpGain = m.xp * (battle.isBoss?5:1); 
    let gemGain = Math.floor(xpGain/2); 
    let gotPotion = Math.random() > 0.8;
    
    addXp(xpGain); player.gems += gemGain; if(gotPotion) player.potions++;
    const s = battle.stats; const acc = Math.round((s.correct / s.turns) * 100) || 0;
    
    const modalBox = document.querySelector('#battle-result-modal .modal-box');
    modalBox.innerHTML = `<div style="font-size:4rem; margin-bottom:5px;">ğŸ†</div><h2 style="font-family:var(--font-title); color:#f1c40f; margin:0 0 10px 0;">æˆ°é¬¥å‹åˆ©</h2><div class="result-stat-grid"><div class="res-row"><span>âš”ï¸ å›åˆæ•¸</span><span class="res-val" style="color:#ddd">${s.turns}</span></div><div class="res-row"><span>ğŸ”¥ ç¸½å‚·å®³</span><span class="res-val" style="color:#e74c3c">${s.dmgDealt}</span></div><div class="res-row"><span>ğŸ¯ æº–ç¢ºç‡</span><span class="res-val" style="color:#3498db">${acc}%</span></div><div class="res-row"><span>ğŸ å¯¶çŸ³</span><span class="res-val" style="color:#2ecc71">+${gemGain}</span></div></div><button class="start-btn" onclick="showLootMenu(${xpGain}, ${gemGain}, ${gotPotion})">ç¢ºèª</button>`;
    document.getElementById('battle-result-modal').style.display = 'flex'; saveData();
}

function showLootMenu(xp, gems, potion) {
    AudioEngine.sfx.confirm(); updateUI(); 
    const modalBox = document.querySelector('#battle-result-modal .modal-box');
    let potionHtml = potion ? '<div style="color:#2ecc71">ğŸ§ª ç²å¾—è—¥æ°´ x1</div>' : '';
    modalBox.innerHTML = `<div style="font-size:4rem; margin-bottom:10px;">ğŸ’</div><h2 style="font-family:var(--font-title); color:#fff; margin:0 0 15px 0;">æˆ°åˆ©å“</h2><div style="font-size:1.2rem; color:#fff; font-weight:bold; margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px;">ç¶“é©— +${xp}<br>å¯¶çŸ³ +${gems}${potionHtml}</div><div style="display:flex; flex-direction:column; gap:10px;"><button class="start-btn" onclick="continueBattle()">âš”ï¸ ç¹¼çºŒç‹©çµ</button><button class="start-btn btn-secondary" onclick="exitBattle()">ğŸ  è¿”å›ç‡Ÿåœ°</button></div>`;
}

function continueBattle() { AudioEngine.sfx.click(); document.getElementById('battle-result-modal').style.display = 'none'; startBattleSequence(); }
function exitBattle() { AudioEngine.sfx.click(); AudioEngine.playBGM(false); document.getElementById('battle-result-modal').style.display = 'none'; document.getElementById('battle-active-screen').style.display = 'none'; renderMaps(); document.getElementById('map-select-screen').style.display = 'block'; }
function loseBattle() { battle.active = false; alert("ä½ è¢«æ“Šæ•—äº†..."); AudioEngine.playBGM(false); document.getElementById('battle-active-screen').style.display = 'none'; renderMaps(); document.getElementById('map-select-screen').style.display = 'block'; }

// --- Enhance System ---
function openEnhance(idx) {
    AudioEngine.sfx.click(); enhanceTargetIdx = idx;
    const item = player.inventory[idx]; const currentLvl = item.level || 0;
    if(currentLvl >= 15) { alert("æ­¤è£å‚™å·²é”æœ€é«˜å¼·åŒ–ç­‰ç´šï¼"); return; }
    
    const cost = (currentLvl + 1) * 10;
    const rate = Math.max(25, 100 - (currentLvl * 5));
    
    const modal = document.getElementById('enhance-modal');
    document.getElementById('enhance-info').innerHTML = `
        <div style="text-align:center; margin-bottom:10px; font-size:1.2rem; font-weight:bold; color:var(--enhance);">${item.name} +${currentLvl} â¤ +${currentLvl+1}</div>
        <div>ğŸ’ è²»ç”¨ï¼š${cost}</div>
        <div>ğŸ² æˆåŠŸç‡ï¼š${rate}%</div>
        <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">æ¯ +5 ç­‰ç´šå°‡éš¨æ©Ÿè³¦äºˆæ–°å±¬æ€§ï¼<br>å¤±æ•—ä¸æœƒæ¶ˆå¤±ï¼Œåƒ…æå¤±å¯¶çŸ³ã€‚</div>
    `;
    modal.style.display = 'flex';
}
function closeEnhanceModal() { document.getElementById('enhance-modal').style.display = 'none'; enhanceTargetIdx = -1; }

function doEnhance() {
    if(enhanceTargetIdx === -1) return;
    const item = player.inventory[enhanceTargetIdx]; const currentLvl = item.level || 0;
    const cost = (currentLvl + 1) * 10;
    const rate = Math.max(25, 100 - (currentLvl * 5));

    if(player.gems < cost) { alert("å¯¶çŸ³ä¸è¶³ï¼"); return; }
    player.gems -= cost; updateUI(); 

    if(Math.random() * 100 < rate) {
        AudioEngine.sfx.enhance();
        item.level = currentLvl + 1;
        if(item.level % 5 === 0) {
            if(!item.bonus) item.bonus = {};
            const types = ['atk','def','hp','crit','dodge','luck'];
            const type = types[Math.floor(Math.random()*types.length)];
            const val = Math.floor(Math.random()*5) + 3;
            item.bonus[type] = (item.bonus[type] || 0) + val;
            alert(`å¼·åŒ–æˆåŠŸï¼(+${item.level})\nç²å¾—é¡å¤–å±¬æ€§ï¼š${type.toUpperCase()} +${val}`);
        } else {
            alert(`å¼·åŒ–æˆåŠŸï¼ (+${item.level})`);
        }
        saveData(); updateUI(); closeEnhanceModal();
    } else {
        AudioEngine.sfx.enhanceFail();
        alert("å¼·åŒ–å¤±æ•—...");
        saveData(); updateUI();
    }
}

// --- Utils & Fixes ---
function addXp(amount) { player.xp += amount; const req = player.level * 100; if (player.xp >= req) { player.xp -= req; player.level++; AudioEngine.sfx.win(); showFloatText("ç­‰ç´šæå‡!", "#f1c40f"); } updateUI(); saveData(); }
function fixError() {
    AudioEngine.sfx.click(); if(!battle.currentQ) return;
    const qKey = battle.currentQ.q; const newAns = prompt(`é¡Œç›®ï¼šã€Œ${qKey}ã€\nç›®å‰ç­”æ¡ˆï¼šã€Œ${battle.currentQ.a}ã€\nè«‹è¼¸å…¥æ­£ç¢ºç­”æ¡ˆï¼š`);
    if(newAns && newAns.trim() !== "") {
        customCorrections[qKey] = newAns.trim(); saveCorrections(); battle.currentQ.a = newAns.trim();
        if(battle.lastDamage > 0) { playerHpChange(battle.lastDamage); battle.stats.dmgTaken -= battle.lastDamage; battle.lastDamage = 0; updateBattleUI(); alert("å·²ä¿®æ­£ä¸¦è£œå›è¡€é‡ï¼"); }
        else alert("å·²ä¿®æ­£è³‡æ–™åº«ï¼");
    }
}
function openDictionary() { AudioEngine.sfx.click(); if(!battle.currentQ) return; const q = battle.currentQ; let term = (q.type === '1') ? q.a : q.q.replace(/[ã€Œã€ã€ã€]/g, ''); window.open(`https://dict.revised.moe.edu.tw/search.jsp?md=1&word=${encodeURIComponent(term)}`, '_blank'); }
function usePotion() { if(player.potions>0 && battle.active) { player.potions--; playerHpChange(Math.floor(getStats().hp*0.5)); AudioEngine.sfx.coin(); updateBattleUI(); showFloatText("æ¢å¾©", "#2ecc71"); } }
function useShield() { if(player.shields>0 && battle.active) { player.shields--; battle.shieldTurns=2; AudioEngine.sfx.enhance(); updateBattleUI(); showFloatText("è­·ç›¾", "#3498db"); } }
function fleeBattle() { if(confirm('é€ƒè·‘?')) { battle.active=false; AudioEngine.playBGM(false); document.getElementById('battle-active-screen').style.display='none'; document.getElementById('map-select-screen').style.display='block'; } }
function equipItem(idx) { AudioEngine.sfx.enhance(); const item=player.inventory[idx]; if(player.equipped[item.slot]) player.inventory.push(player.equipped[item.slot]); player.equipped[item.slot]=item; player.inventory.splice(idx,1); saveData(); updateUI(); }
function unequip(slot) { if(player.equipped[slot]) { AudioEngine.sfx.enhance(); player.inventory.push(player.equipped[slot]); delete player.equipped[slot]; saveData(); updateUI(); } }
function sellItem(idx) { AudioEngine.sfx.click(); if(confirm('ç¢ºå®šå‡ºå”®?')) { AudioEngine.sfx.coin(); player.gems += player.inventory[idx].rarity*20; player.inventory.splice(idx,1); saveData(); updateUI(); } }
function pullGacha() { 
    AudioEngine.sfx.click(); let cost=100; let useTicket=player.gachaTickets>0; if(!useTicket && player.gems<cost) return alert("å¯¶çŸ³ä¸è¶³!");
    if(useTicket) player.gachaTickets--; else player.gems-=cost; AudioEngine.sfx.gacha();
    const parts=['head','body','legs','feet','gloves','weapon','offhand','accessory']; const part=parts[Math.floor(Math.random()*parts.length)];
    const rarity=Math.random()<(0.1+getStats().luck*0.01)?3:(Math.random()<0.3?2:1);
    const lvlMult=1+(player.level*0.1); 
    const item={ name:`${['æ™®é€š','ç¨€æœ‰','å‚³èªª'][rarity-1]} ${{head:'é ­ç›”',body:'é§ç”²',legs:'è­·è…¿',feet:'æˆ°é´',gloves:'è­·æ‰‹',weapon:'æ­¦å™¨',offhand:'ç›¾ç‰Œ',accessory:'é£¾å“'}[part]}`, slot:part, rarity:rarity, icon:{head:'â›‘ï¸',body:'ğŸ‘•',legs:'ğŸ‘–',feet:'ğŸ‘¢',gloves:'ğŸ§¤',weapon:'âš”ï¸',offhand:'ğŸ›¡ï¸',accessory:'ğŸ’'}[part], level:0, atk:Math.floor((part==='weapon'?rarity*5:0)*lvlMult), def:Math.floor((part!=='weapon'&&part!=='accessory'?rarity*3:0)*lvlMult), hp:Math.floor((part==='body'?rarity*20:0)*lvlMult), luck:Math.floor((part==='accessory'?rarity*2:0)*lvlMult), crit:Math.floor((part==='weapon'?rarity:0)*lvlMult) };
    player.inventory.push(item); saveData(); updateUI();
    setTimeout(()=>alert(`ç²å¾—ï¼š${item.name}`), 500);
}
function switchTab(t) { AudioEngine.sfx.click(); document.querySelectorAll('.tab-page').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); }
function toggleMute() { AudioEngine.isMuted=!AudioEngine.isMuted; if(AudioEngine.isMuted) AudioEngine.stopBGM(); else AudioEngine.playBGM(battle.active); document.getElementById('sound-btn').innerText=AudioEngine.isMuted?'ğŸ”‡':'ğŸ”Š'; }
function showFloatText(txt,c) { const el=document.createElement('div'); el.className='float-txt'; el.style.color=c; el.innerText=txt; document.body.appendChild(el); setTimeout(()=>el.remove(),1000); }
</script>
</body>
</html>





