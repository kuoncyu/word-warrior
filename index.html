<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­—éˆçµäººï¼šç™¾å±¤å¡”å‚³èªª (V50 - è£å‚™é©æ–°ç‰ˆ)</title>
    <script src="moe_data.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');

        :root {
            --bg-dark: #0f0f10;
            --panel-bg: rgba(25, 25, 30, 0.98);
            --primary: #c23616;
            --accent: #fbc531;
            --luck: #00d2d3;
            --enhance: #e056fd;
            --boss: #e74c3c;
            --text: #f5f6fa;
            --font-main: 'Noto Serif TC', serif;
            --common: #dcdde1;
            --rare: #00a8ff;
            --legendary: #e1b12c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text);
            margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar {
            padding: 10px 15px; background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .res-box { display: flex; gap: 15px; font-size: 0.9rem; }
        .res-item { display: flex; align-items: center; gap: 5px; }

        /* ä¸»å…§å®¹å€ */
        .main-container { flex: 1; position: relative; overflow: hidden; }
        .tab-page {
            display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            padding: 15px; overflow-y: auto; flex-direction: column; align-items: center;
        }
        .tab-page.active { display: flex; animation: fadeIn 0.3s; }

        /* åº•éƒ¨å°èˆª */
        .nav-bar {
            height: 60px; background: #1e1e24; display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid #333; z-index: 20;
        }
        .nav-btn {
            background: none; border: none; color: #7f8c8d; font-size: 1.5rem;
            padding: 10px; transition: 0.2s; cursor: pointer;
        }
        .nav-btn.active { color: var(--accent); transform: scale(1.1); text-shadow: 0 0 10px rgba(251, 197, 49, 0.5); }

        /* é€šç”¨æŒ‰éˆ• */
        .btn {
            background: linear-gradient(135deg, #353b48, #2f3640); color: white; border: 1px solid #555;
            padding: 8px 16px; border-radius: 4px; font-family: var(--font-main); cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); border-color: #e84118; }
        .btn-accent { background: var(--accent); color: #2f3640; font-weight: bold; border-color: #e1b12c; }

        /* æˆ°é¬¥å€ */
        .battle-area { width: 100%; max-width: 600px; text-align: center; margin-top: 20px; }
        .enemy-box { margin-bottom: 20px; position: relative; height: 150px; display: flex; justify-content: center; align-items: center; }
        .enemy-sprite { font-size: 5rem; filter: drop-shadow(0 0 10px red); animation: float 3s infinite ease-in-out; }
        .hp-bar-bg { width: 80%; height: 10px; background: #333; margin: 10px auto; border-radius: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.2s; }
        
        .quiz-box { 
            background: rgba(0,0,0,0.6); padding: 20px; border-radius: 10px; border: 1px solid #444; width: 90%; max-width: 500px;
        }
        .quiz-question { font-size: 1.5rem; margin-bottom: 15px; color: var(--accent); font-weight: bold; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { padding: 15px; font-size: 1.1rem; }

        /* è£å‚™èˆ‡èƒŒåŒ… */
        .inventory-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 10px; width: 100%; max-width: 600px; padding-bottom: 80px;
        }
        .item-card {
            background: #2f3640; border: 2px solid #444; border-radius: 5px; padding: 5px;
            display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative;
        }
        .item-card.equipped { border-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .item-icon { font-size: 2rem; margin-bottom: 5px; }
        .item-info { text-align: center; font-size: 0.8rem; }
        .item-lvl { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; background: #000; padding: 1px 3px; border-radius: 3px; }
        .item-enhance { position: absolute; top: 2px; right: 2px; font-size: 0.7rem; color: var(--enhance); font-weight: bold; }

        /* ç¨€æœ‰åº¦é¡è‰² */
        .rarity-1 { border-color: var(--common); color: var(--common); }
        .rarity-2 { border-color: var(--rare); color: var(--rare); }
        .rarity-3 { border-color: var(--legendary); color: var(--legendary); box-shadow: 0 0 8px rgba(225, 177, 44, 0.3); }

        /* è£å‚™è©³æƒ…å½ˆçª— */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: #1e1e24; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
            border: 1px solid #555; text-align: center;
        }
        .detail-stats { text-align: left; margin: 15px 0; background: #111; padding: 10px; border-radius: 4px; }
        .detail-stat-row { display: flex; justify-content: space-between; margin: 3px 0; }
        .bonus-stat { color: #2ecc71; font-size: 0.9em; } /* é™„åŠ å±¬æ€§é¡è‰² */
        .req-stat { color: #e74c3c; font-size: 0.9em; margin-top: 5px; font-weight: bold; }
        .req-ok { color: #2ecc71; }

        /* å•†åº—å¯¶ç®± */
        .chest-selector {
            display: flex; overflow-x: auto; gap: 10px; padding: 10px; width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        .chest-option {
            min-width: 120px; background: #2f3640; padding: 10px; border-radius: 5px; border: 2px solid #555;
            display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.5;
        }
        .chest-option.unlocked { opacity: 1; border-color: var(--accent); }
        .chest-option.selected { background: #3c4450; border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .chest-icon { font-size: 2.5rem; margin-bottom: 5px; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <div class="top-bar">
        <div style="font-weight:900; color:var(--accent);">å­—éˆçµäºº</div>
        <div class="res-box">
            <div class="res-item">ğŸª™ <span id="ui-gold">0</span></div>
            <div class="res-item">ğŸ’ <span id="ui-gems">0</span></div>
            <div class="res-item">Lv.<span id="ui-lvl">1</span></div>
        </div>
    </div>

    <div class="main-container">
        <div id="tab-battle" class="tab-page active">
            <div class="battle-area">
                <div style="font-size:1.2rem; margin-bottom:5px;">ç¬¬ <span id="ui-floor">1</span> å±¤</div>
                <div class="enemy-box">
                    <div class="enemy-sprite" id="enemy-visual">ğŸ‘»</div>
                </div>
                <div class="hp-bar-bg"><div class="hp-bar-fill" id="enemy-hp-bar"></div></div>
                <div style="margin-bottom:15px;">HP: <span id="enemy-hp">100</span> / <span id="enemy-max-hp">100</span></div>
                
                <div class="quiz-box" id="quiz-container">
                    <div class="quiz-question" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
                    <div class="quiz-options" id="q-options">
                        </div>
                </div>
            </div>
            <div style="margin-top:auto; padding:10px; color:#777; font-size:0.8rem;">æ­£ç¢ºç­”é¡Œæ”»æ“Šæ•µäººï¼ŒéŒ¯èª¤ç­”é¡Œæ‰£è¡€</div>
        </div>

        <div id="tab-hero" class="tab-page">
            <div style="display:flex; justify-content:space-between; width:100%; max-width:600px; margin-bottom:15px; background:#222; padding:10px; border-radius:5px;">
                <div>
                    <div>æ”»æ“ŠåŠ›: <span id="stat-atk" style="color:var(--primary)">0</span></div>
                    <div>é˜²ç¦¦åŠ›: <span id="stat-def" style="color:#3498db">0</span></div>
                </div>
                <div>
                    <div>ç”Ÿå‘½å€¼: <span id="stat-hp" style="color:#2ecc71">0</span></div>
                    <div>çˆ†æ“Šç‡: <span id="stat-crit" style="color:var(--accent)">0</span>%</div>
                </div>
            </div>
            <h3>è£å‚™æ¬„ä½</h3>
            <div class="inventory-grid" id="equip-slots" style="margin-bottom:20px; min-height:100px;">
                </div>
            <h3>èƒŒåŒ… (<span id="inv-count">0</span>/50)</h3>
            <div style="margin-bottom:10px;">
                <button class="btn" onclick="sortInventory()">æ•´ç†èƒŒåŒ…</button>
                <button class="btn" style="background:#c0392b" onclick="sellAllCommon()">ä¸€éµå‡ºå”®æ™®é€š</button>
            </div>
            <div class="inventory-grid" id="inventory-list">
                </div>
        </div>

        <div id="tab-shop" class="tab-page">
            <h2>è™›ç©ºå¯¶ç®±</h2>
            <p style="color:#aaa; font-size:0.9rem;">æ¯ 10 ç´šè§£é–æ›´é«˜ç´šçš„å¯¶ç®±</p>
            
            <div class="chest-selector" id="chest-list">
                </div>

            <div style="text-align:center; margin-top:20px; background:#222; padding:20px; border-radius:10px; width:90%; max-width:400px;">
                <h3 id="selected-chest-name">è«‹é¸æ“‡å¯¶ç®±</h3>
                <p id="selected-chest-desc" style="color:#888;">--</p>
                <button class="btn btn-accent" id="btn-draw" onclick="drawChest()" style="font-size:1.2rem; padding:10px 30px; margin-top:10px;">
                    æŠ½å– (ğŸ’<span id="draw-cost">--</span>)
                </button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('battle')">âš”ï¸</button>
        <button class="nav-btn" onclick="switchTab('hero')">ğŸ’</button>
        <button class="nav-btn" onclick="switchTab('shop')">ğŸ›’</button>
    </div>

    <div id="item-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="modal-name">è£å‚™åç¨±</h2>
            <div id="modal-rarity" style="margin-bottom:10px;">ç¨€æœ‰åº¦</div>
            <div class="detail-stats" id="modal-stats">
                </div>
            <div id="modal-req-lvl" class="req-stat">éœ€æ±‚ç­‰ç´š: 1</div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" id="btn-equip" onclick="doEquip()">è£å‚™</button>
                <button class="btn" id="btn-enhance" onclick="doEnhance()" style="background:var(--enhance); border-color:#be2edd">å¼·åŒ– (+<span id="modal-next-enhance">1</span>)</button>
                <button class="btn" onclick="doSell()" style="background:#7f8c8d">å‡ºå”®</button>
            </div>
            <div id="enhance-cost-display" style="font-size:0.8rem; color:#aaa; margin-top:5px;"></div>
        </div>
    </div>

<script>
    // --- éŠæˆ²è³‡æ–™è¨­å®š ---
    
    // å¯¶ç®±è¨­å®š
    // åƒ¹æ ¼: 10, 20, 35, 50, 70, 90, 115, 140, 170, 200
    // è§£é–ç­‰ç´š: 1, 10, 20, 30... 90
    // æ‰è½å€é–“: 1-10, 11-20...
    const CHEST_CONFIG = [
        { tier: 0, minLvl: 1,  dropMin: 1,  dropMax: 10, cost: 10,  name: "åˆå§‹å¯¶ç®±" },
        { tier: 1, minLvl: 10, dropMin: 11, dropMax: 20, cost: 20,  name: "é’éŠ…å¯¶ç®±" },
        { tier: 2, minLvl: 20, dropMin: 21, dropMax: 30, cost: 35,  name: "é»‘éµå¯¶ç®±" },
        { tier: 3, minLvl: 30, dropMin: 31, dropMax: 40, cost: 50,  name: "ç™½éŠ€å¯¶ç®±" },
        { tier: 4, minLvl: 40, dropMin: 41, dropMax: 50, cost: 70,  name: "é»ƒé‡‘å¯¶ç®±" },
        { tier: 5, minLvl: 50, dropMin: 51, dropMax: 60, cost: 90,  name: "ç™½é‡‘å¯¶ç®±" },
        { tier: 6, minLvl: 60, dropMin: 61, dropMax: 70, cost: 115, name: "é‘½çŸ³å¯¶ç®±" },
        { tier: 7, minLvl: 70, dropMin: 71, dropMax: 80, cost: 140, name: "å¤§å¸«å¯¶ç®±" },
        { tier: 8, minLvl: 80, dropMin: 81, dropMax: 90, cost: 170, name: "å®—å¸«å¯¶ç®±" },
        { tier: 9, minLvl: 90, dropMin: 91, dropMax: 100, cost: 200, name: "ç‹è€…å¯¶ç®±" }
    ];

    const PARTS = { head:'é ­ç›”', body:'é§ç”²', legs:'è­·è…¿', feet:'æˆ°é´', gloves:'è­·æ‰‹', weapon:'æ­¦å™¨', offhand:'ç›¾ç‰Œ', accessory:'é£¾å“' };
    const PART_ICONS = { head:'â›‘ï¸', body:'ğŸ‘•', legs:'ğŸ‘–', feet:'ğŸ‘¢', gloves:'ğŸ§¤', weapon:'âš”ï¸', offhand:'ğŸ›¡ï¸', accessory:'ğŸ’' };
    const RARITY_NAMES = ['æ™®é€š', 'ç¨€æœ‰', 'å‚³èªª'];
    
    // éŠæˆ²ç‹€æ…‹
    let player = {
        level: 1,
        exp: 0,
        maxExp: 100,
        gold: 1000,
        gems: 50,
        floor: 1,
        hp: 100,
        maxHp: 100,
        inventory: [], // èƒŒåŒ…
        equipped: {},  // å·²è£å‚™éƒ¨ä½
        stats: { atk:10, def:0, crit:0, luck:0 } // ç¸½å±¬æ€§
    };

    let currentEnemy = null;
    let selectedChestIndex = 0;
    let selectedItemIndex = -1; // ç”¨æ–¼å½ˆçª—æ“ä½œ

    // éŸ³æ•ˆæ¨¡æ“¬
    const AudioEngine = {
        sfx: { click: () => {}, win: () => {}, hit: () => {}, correct: () => {}, wrong: () => {} }
    };

    // --- æ ¸å¿ƒé‚è¼¯ ---

    function init() {
        loadData();
        updateStats();
        renderUI();
        renderChests();
        nextBattle();
    }

    // å»ºç«‹è£å‚™ (æ ¸å¿ƒä¿®æ”¹: å¢åŠ ç­‰ç´šåƒæ•¸)
    function createItem(lvlMin, lvlMax) {
        // éš¨æ©Ÿç­‰ç´š
        const level = Math.floor(Math.random() * (lvlMax - lvlMin + 1)) + lvlMin;
        
        // ç¨€æœ‰åº¦æ¬Šé‡ (é‹æ°£å½±éŸ¿)
        const roll = Math.random() * 100;
        let rarity = 1;
        if (roll < 5 + (player.stats.luck * 0.1)) rarity = 3;
        else if (roll < 25 + (player.stats.luck * 0.2)) rarity = 2;

        const partKeys = Object.keys(PARTS);
        const part = partKeys[Math.floor(Math.random() * partKeys.length)];
        
        // åŸºç¤æ•¸å€¼è¨ˆç®— (éš¨ç­‰ç´šæˆé•·)
        const baseMult = level * 1.5; // ç­‰ç´šä¿‚æ•¸
        const rMult = rarity; // ç¨€æœ‰åº¦ä¿‚æ•¸

        let item = {
            id: Date.now() + Math.random(),
            name: `Lv.${level} ${RARITY_NAMES[rarity-1]}${PARTS[part]}`,
            part: part,
            rarity: rarity,
            level: level,      // è£å‚™ç­‰ç´š
            reqLevel: level,   // éœ€æ±‚ç­‰ç´š (é€šå¸¸ç­‰æ–¼ç‰©å“ç­‰ç´š)
            enhance: 0,        // å¼·åŒ–ç­‰ç´š
            icon: PART_ICONS[part],
            baseStats: {},     // åŸºç¤ç™½å€¼
            bonusStats: []     // å¼·åŒ–è§£é–çš„ç¶ å­—
        };

        // è¨­å®šåŸºç¤å±¬æ€§
        if (part === 'weapon') { item.baseStats.atk = Math.floor((10 + level * 2) * rMult); item.baseStats.crit = Math.floor(rarity * level * 0.1); }
        else if (part === 'body') { item.baseStats.hp = Math.floor((50 + level * 10) * rMult); item.baseStats.def = Math.floor(level * rMult); }
        else if (part === 'offhand') { item.baseStats.def = Math.floor((5 + level * 1.5) * rMult); item.baseStats.hp = Math.floor(level * 5); }
        else if (part === 'accessory') { item.baseStats.luck = Math.floor(rarity * level * 0.5); item.baseStats.crit = Math.floor(rarity); }
        else { 
            // å…¶ä»–é˜²å…·
            item.baseStats.def = Math.floor((2 + level) * rMult); 
            item.baseStats.hp = Math.floor(level * 3);
        }

        // æ¸…ç† 0 çš„å±¬æ€§
        for(let k in item.baseStats) { if(item.baseStats[k] <= 0) delete item.baseStats[k]; }

        return item;
    }

    // å¼·åŒ–è£å‚™ (æ ¸å¿ƒä¿®æ”¹)
    function enhanceItem(item) {
        if (item.enhance >= 15) return false;
        
        // æˆæœ¬è¨ˆç®— (éš¨ç­‰ç´šèˆ‡å¼·åŒ–éšç´šæå‡)
        const cost = Math.floor((item.level * 10 + 50) * (item.enhance + 1));
        if (player.gold < cost) {
            alert("é‡‘å¹£ä¸è¶³ï¼");
            return false;
        }

        player.gold -= cost;
        item.enhance += 1;

        // 1. æå‡åŸºç¤æ•¸å€¼ (æ¯ç´šç´„ +5% åŸºç¤å€¼ï¼Œæˆ–è‡³å°‘ +1)
        for (let key in item.baseStats) {
            let increase = Math.ceil(item.baseStats[key] * 0.05);
            if (increase < 1) increase = 1;
            item.baseStats[key] += increase;
        }

        // 2. æ¯ +5 è§£é–é™„åŠ å±¬æ€§ (æœ€å¤š 3 æ¢)
        if (item.enhance % 5 === 0) {
            addBonusStat(item);
            alert(`å¼·åŒ–æˆåŠŸï¼è£å‚™ç²å¾—äº†æ–°çš„é™„åŠ å±¬æ€§ï¼`);
        } else {
            // alert(`å¼·åŒ–æˆåŠŸï¼+${item.enhance}`);
        }

        saveData();
        renderUI();
        updateModalContent(); // å¦‚æœå½ˆçª—é–‹è‘—ï¼Œæ›´æ–°å½ˆçª—
        return true;
    }

    // å¢åŠ é™„åŠ å±¬æ€§ logic
    function addBonusStat(item) {
        const types = [
            { key: 'atk', name: 'æ”»æ“ŠåŠ›' },
            { key: 'def', name: 'é˜²ç¦¦åŠ›' },
            { key: 'hp', name: 'ç”Ÿå‘½å€¼' },
            { key: 'crit', name: 'çˆ†æ“Šç‡%' },
            { key: 'luck', name: 'å¹¸é‹' }
        ];
        const type = types[Math.floor(Math.random() * types.length)];
        
        // æ•¸å€¼å¼·åº¦ä¾è³´ç¨€æœ‰åº¦èˆ‡ç­‰ç´š
        // æ™®é€š: ä¿‚æ•¸ 1, ç¨€æœ‰: 1.5, å‚³èªª: 2.5
        const rMult = item.rarity === 3 ? 2.5 : (item.rarity === 2 ? 1.5 : 1);
        let val = 0;

        if (type.key === 'crit') val = Math.floor((Math.random() * 2 + 1) * rMult); // 1-5%
        else if (type.key === 'luck') val = Math.floor((Math.random() * 3 + 1) * rMult);
        else if (type.key === 'hp') val = Math.floor((Math.random() * 50 + 20) * item.level * 0.2 * rMult);
        else val = Math.floor((Math.random() * 5 + 2) * item.level * 0.2 * rMult);

        if (val <= 0) val = 1;

        item.bonusStats.push({ name: type.name, val: val, key: type.key });
    }

    // è£å‚™é™åˆ¶æª¢æŸ¥
    function canEquip(item) {
        return player.level >= item.reqLevel;
    }

    // æŠ½å¯¶ç®±
    function drawChest() {
        const chest = CHEST_CONFIG[selectedChestIndex];
        
        // æª¢æŸ¥è§£é–
        if (player.level < chest.minLvl) {
            alert(`ç­‰ç´šä¸è¶³ï¼éœ€é”åˆ° Lv.${chest.minLvl} æ‰èƒ½æŠ½å–æ­¤å¯¶ç®±ã€‚`);
            return;
        }

        if (player.gems < chest.cost) {
            alert("é‘½çŸ³ä¸è¶³ï¼");
            return;
        }

        if (player.inventory.length >= 50) {
            alert("èƒŒåŒ…å·²æ»¿ï¼");
            return;
        }

        player.gems -= chest.cost;
        const newItem = createItem(chest.dropMin, chest.dropMax);
        player.inventory.push(newItem);
        
        saveData();
        updateStats();
        renderUI();
        
        // ç°¡å–®çš„ç²å¾—æç¤º
        setTimeout(() => alert(`ç²å¾—ï¼š${newItem.name}`), 100);
    }

    // --- UI æ¸²æŸ“ ---

    function switchTab(t) {
        document.querySelectorAll('.tab-page').forEach(e => e.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        // ç°¡å–®è™•ç† active button
        if(t==='battle') document.querySelectorAll('.nav-btn')[0].classList.add('active');
        if(t==='hero') document.querySelectorAll('.nav-btn')[1].classList.add('active');
        if(t==='shop') document.querySelectorAll('.nav-btn')[2].classList.add('active');
    }

    function renderChests() {
        const container = document.getElementById('chest-list');
        container.innerHTML = '';
        CHEST_CONFIG.forEach((c, idx) => {
            const el = document.createElement('div');
            el.className = `chest-option ${player.level >= c.minLvl ? 'unlocked' : ''} ${idx === selectedChestIndex ? 'selected' : ''}`;
            el.innerHTML = `
                <div class="chest-icon">ğŸ</div>
                <div style="font-size:0.8rem; font-weight:bold;">${c.name}</div>
                <div style="font-size:0.7rem;">Lv.${c.minLvl}è§£é–</div>
            `;
            el.onclick = () => selectChest(idx);
            container.appendChild(el);
        });
        selectChest(selectedChestIndex); // æ›´æ–°é¡¯ç¤ºæ–‡å­—
    }

    function selectChest(idx) {
        selectedChestIndex = idx;
        const chest = CHEST_CONFIG[idx];
        document.getElementById('selected-chest-name').innerText = chest.name;
        document.getElementById('selected-chest-desc').innerText = `æ‰è½ Lv.${chest.dropMin} ~ Lv.${chest.dropMax} è£å‚™`;
        document.getElementById('draw-cost').innerText = chest.cost;
        
        // é‡ç¹ªé¸å–ç‹€æ…‹
        const opts = document.querySelectorAll('.chest-option');
        opts.forEach((o, i) => {
            if (i === idx) o.classList.add('selected');
            else o.classList.remove('selected');
        });

        // æŒ‰éˆ•ç‹€æ…‹
        const btn = document.getElementById('btn-draw');
        if (player.level < chest.minLvl) {
            btn.style.opacity = 0.5;
            btn.innerText = `éœ€ Lv.${chest.minLvl} è§£é–`;
        } else {
            btn.style.opacity = 1;
            btn.innerText = `æŠ½å– (ğŸ’${chest.cost})`;
        }
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        const slots = document.getElementById('equip-slots');
        list.innerHTML = '';
        slots.innerHTML = '';

        // æ¸²æŸ“å·²è£å‚™
        Object.keys(player.equipped).forEach(part => {
            const item = player.equipped[part];
            if (item) {
                slots.appendChild(createItemEl(item, true));
            } else {
                // ç©ºæ ¼å­
                const empty = document.createElement('div');
                empty.className = 'item-card';
                empty.style.opacity = 0.3;
                empty.innerHTML = `<div class="item-icon">${PART_ICONS[part]}</div><div class="item-info">${PARTS[part]}</div>`;
                slots.appendChild(empty);
            }
        });

        // æ¸²æŸ“èƒŒåŒ…
        player.inventory.forEach((item, idx) => {
            const el = createItemEl(item, false);
            el.onclick = () => openModal(idx, false);
            list.appendChild(el);
        });

        document.getElementById('inv-count').innerText = player.inventory.length;
    }

    function createItemEl(item, isEquipped) {
        const el = document.createElement('div');
        el.className = `item-card rarity-${item.rarity} ${isEquipped ? 'equipped' : ''}`;
        if (isEquipped) el.onclick = () => openModal(-1, true, item.part); // ç‰¹æ®Šè™•ç†å·²è£å‚™é»æ“Š

        el.innerHTML = `
            <div class="item-lvl">Lv.${item.level}</div>
            ${item.enhance > 0 ? `<div class="item-enhance">+${item.enhance}</div>` : ''}
            <div class="item-icon">${item.icon}</div>
            <div class="item-info">${item.name.split(' ')[1]}</div>
        `;
        return el;
    }

    function renderUI() {
        document.getElementById('ui-gold').innerText = player.gold;
        document.getElementById('ui-gems').innerText = player.gems;
        document.getElementById('ui-lvl').innerText = player.level;
        
        document.getElementById('stat-atk').innerText = player.stats.atk;
        document.getElementById('stat-def').innerText = player.stats.def;
        document.getElementById('stat-hp').innerText = player.stats.hp + "/" + player.maxHp;
        document.getElementById('stat-crit').innerText = player.stats.crit;

        renderInventory();
        renderChests(); // æ›´æ–°å¯¶ç®±è§£é–ç‹€æ…‹
    }

    // --- å½ˆçª—èˆ‡è£å‚™æ“ä½œ ---

    let currentModalItem = null;
    let currentModalIsEquipped = false;
    let currentModalPart = null;

    function openModal(index, isEquipped, part = null) {
        selectedItemIndex = index;
        currentModalIsEquipped = isEquipped;
        currentModalPart = part;
        
        if (isEquipped) {
            currentModalItem = player.equipped[part];
        } else {
            currentModalItem = player.inventory[index];
        }

        if (!currentModalItem) return;

        updateModalContent();
        document.getElementById('item-modal').style.display = 'flex';
    }

    function updateModalContent() {
        const item = currentModalItem;
        if(!item) return;

        document.getElementById('modal-name').innerText = item.name + (item.enhance > 0 ? ` +${item.enhance}` : '');
        document.getElementById('modal-name').className = `rarity-${item.rarity}`;
        document.getElementById('modal-rarity').innerText = `${RARITY_NAMES[item.rarity-1]} ${PARTS[item.part]} (Lv.${item.level})`;
        
        // é¡¯ç¤ºå±¬æ€§
        let statsHtml = '';
        // åŸºç¤
        for(let k in item.baseStats) {
            statsHtml += `<div class="detail-stat-row"><span>${k.toUpperCase()}</span> <span>${item.baseStats[k]}</span></div>`;
        }
        // é™„åŠ 
        item.bonusStats.forEach(b => {
            statsHtml += `<div class="detail-stat-row bonus-stat"><span>${b.name}</span> <span>+${b.val}</span></div>`;
        });
        document.getElementById('modal-stats').innerHTML = statsHtml;

        // éœ€æ±‚ç­‰ç´šèˆ‡æŒ‰éˆ•ç‹€æ…‹
        const reqEl = document.getElementById('modal-req-lvl');
        const btnEquip = document.getElementById('btn-equip');
        
        reqEl.innerText = `éœ€æ±‚ç­‰ç´š: ${item.reqLevel}`;
        if (player.level >= item.reqLevel) {
            reqEl.className = 'req-stat req-ok';
            btnEquip.disabled = false;
        } else {
            reqEl.className = 'req-stat';
            btnEquip.disabled = true;
        }

        // æŒ‰éˆ•é‚è¼¯
        if (currentModalIsEquipped) {
            btnEquip.innerText = "å¸ä¸‹";
        } else {
            btnEquip.innerText = "è£å‚™";
        }

        const enhanceBtn = document.getElementById('btn-enhance');
        const enhanceCostEl = document.getElementById('enhance-cost-display');
        
        if (item.enhance >= 15) {
            enhanceBtn.disabled = true;
            enhanceBtn.innerText = "å·²æ»¿ç´š";
            enhanceCostEl.innerText = "";
        } else {
            enhanceBtn.disabled = false;
            enhanceBtn.innerText = `å¼·åŒ– (+${item.enhance+1})`;
            const cost = Math.floor((item.level * 10 + 50) * (item.enhance + 1));
            enhanceCostEl.innerText = `æ¶ˆè€—: ğŸª™${cost}`;
            
            // æç¤ºä¸‹ä¸€å€‹ Bonus
            if ((item.enhance + 1) % 5 === 0) {
                 enhanceCostEl.innerText += " (å°‡è§£é–é™„åŠ å±¬æ€§!)";
                 enhanceCostEl.style.color = "#e056fd";
            }
        }
    }

    function closeModal(e) {
        document.getElementById('item-modal').style.display = 'none';
    }

    function doEquip() {
        if (currentModalIsEquipped) {
            // å¸ä¸‹
            player.inventory.push(currentModalItem);
            delete player.equipped[currentModalPart];
        } else {
            // è£å‚™
            if (!canEquip(currentModalItem)) {
                alert("ç­‰ç´šä¸è¶³ï¼Œç„¡æ³•è£å‚™ï¼");
                return;
            }
            
            // æª¢æŸ¥è©²éƒ¨ä½æ˜¯å¦æœ‰èˆŠè£å‚™
            const part = currentModalItem.part;
            if (player.equipped[part]) {
                player.inventory.push(player.equipped[part]);
            }
            player.equipped[part] = currentModalItem;
            player.inventory.splice(selectedItemIndex, 1);
        }
        
        updateStats();
        renderUI();
        closeModal();
    }

    function doEnhance() {
        if (enhanceItem(currentModalItem)) {
            // UI å·²åœ¨ enhanceItem æ›´æ–°
        }
    }

    function doSell() {
        if(!confirm("ç¢ºå®šè¦å‡ºå”®å—ï¼Ÿ")) return;
        
        const price = Math.floor(currentModalItem.level * 5 * currentModalItem.rarity);
        player.gold += price;

        if (currentModalIsEquipped) {
            delete player.equipped[currentModalPart];
        } else {
            player.inventory.splice(selectedItemIndex, 1);
        }

        updateStats();
        renderUI();
        closeModal();
    }

    function sellAllCommon() {
        if (!confirm("ç¢ºå®šå‡ºå”®æ‰€æœ‰èƒŒåŒ…ä¸­çš„æ™®é€šè£å‚™ï¼Ÿ")) return;
        let sold = 0;
        let gain = 0;
        for (let i = player.inventory.length - 1; i >= 0; i--) {
            if (player.inventory[i].rarity === 1) {
                gain += Math.floor(player.inventory[i].level * 5);
                player.inventory.splice(i, 1);
                sold++;
            }
        }
        player.gold += gain;
        renderUI();
        alert(`å‡ºå”®äº† ${sold} ä»¶è£å‚™ï¼Œç²å¾— ${gain} é‡‘å¹£`);
    }

    function sortInventory() {
        player.inventory.sort((a, b) => {
            if (b.rarity !== a.rarity) return b.rarity - a.rarity;
            return b.level - a.level;
        });
        renderUI();
    }

    function updateStats() {
        // åŸºç¤è£¸èº«å±¬æ€§
        let s = { atk:10 + player.level*2, def:0, hp:100 + player.level*10, crit:0, luck:0 };
        
        // åŠ ä¸Šè£å‚™å±¬æ€§
        for(let part in player.equipped) {
            const item = player.equipped[part];
            
            // 1. åŸºç¤ç™½å€¼
            for(let k in item.baseStats) {
                if(s[k] !== undefined) s[k] += item.baseStats[k];
            }
            
            // 2. é™„åŠ ç¶ å€¼
            item.bonusStats.forEach(bonus => {
                if (bonus.key === 'atk') s.atk += bonus.val;
                if (bonus.key === 'def') s.def += bonus.val;
                if (bonus.key === 'hp') s.hp += bonus.val;
                if (bonus.key === 'crit') s.crit += bonus.val;
                if (bonus.key === 'luck') s.luck += bonus.val;
            });
        }
        
        player.stats = s;
        player.maxHp = s.hp;
        if(player.hp > player.maxHp) player.hp = player.maxHp;
    }

    // --- æˆ°é¬¥èˆ‡é¡Œç›®é‚è¼¯ (ç°¡åŒ–ç‰ˆ) ---
    
    function nextBattle() {
        const isBoss = player.floor % 10 === 0;
        const scale = 1 + player.floor * 0.2;
        
        currentEnemy = {
            hp: Math.floor((isBoss ? 500 : 100) * scale),
            maxHp: Math.floor((isBoss ? 500 : 100) * scale),
            atk: Math.floor((isBoss ? 20 : 5) * scale)
        };
        
        updateBattleUI();
        nextQuestion();
    }

    function updateBattleUI() {
        document.getElementById('ui-floor').innerText = player.floor;
        document.getElementById('enemy-hp').innerText = currentEnemy.hp;
        document.getElementById('enemy-max-hp').innerText = currentEnemy.maxHp;
        
        const pct = (currentEnemy.hp / currentEnemy.maxHp) * 100;
        document.getElementById('enemy-hp-bar').style.width = `${pct}%`;
    }

    function nextQuestion() {
        // å¾ moe_data.js ç²å–é¡Œç›®ï¼Œå¦‚æœæ²’æœ‰è³‡æ–™å‰‡ä½¿ç”¨å‡è³‡æ–™
        let q = { t: "æ¸¬è©¦", a: "A", o: ["A", "B", "C", "D"] };
        
        if (window.MOE_DATA_STRING) {
            const lines = window.MOE_DATA_STRING.trim().split('\n');
            const raw = lines[Math.floor(Math.random() * lines.length)].split('|');
            // æ ¼å¼ï¼šé¡Œå‹|é¡Œç›®|æ­£ç¢º|éŒ¯1,éŒ¯2,éŒ¯3
            const wrongOpts = raw[3].split(',');
            const opts = [raw[2], ...wrongOpts].sort(() => Math.random() - 0.5);
            
            q = {
                t: raw[0] == '1' ? `è«‹é¸å‡ºã€Œ${raw[2]}ã€çš„åœ‹å­—ï¼š${raw[1]}` : `è«‹é¸å‡ºã€Œ${raw[1]}ã€çš„æ³¨éŸ³`,
                a: raw[2],
                o: opts
            };
        }

        document.getElementById('q-text').innerText = q.t;
        const optBox = document.getElementById('q-options');
        optBox.innerHTML = '';
        
        q.o.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn option-btn';
            btn.innerText = opt;
            btn.onclick = () => answer(opt === q.a);
            optBox.appendChild(btn);
        });
    }

    function answer(isCorrect) {
        const visual = document.getElementById('enemy-visual');
        
        if (isCorrect) {
            // ç©å®¶æ”»æ“Š
            let dmg = player.stats.atk;
            if (Math.random() * 100 < player.stats.crit) {
                dmg *= 2;
                visual.innerText = "ğŸ’¥";
            } else {
                visual.innerText = "ğŸ’¢";
            }
            
            setTimeout(() => visual.innerText = "ğŸ‘»", 300);

            currentEnemy.hp -= dmg;
            if (currentEnemy.hp <= 0) {
                winBattle();
                return;
            }
        } else {
            // ç©å®¶å—å‚·
            const dmg = Math.max(1, currentEnemy.atk - player.stats.def);
            player.hp -= dmg;
            if (player.hp <= 0) {
                player.hp = player.maxHp;
                alert("ä½ è¢«æ‰“æ•—äº†ï¼é€€å›ä¸Šä¸€å±¤...");
                player.floor = Math.max(1, player.floor - 1);
                nextBattle();
            }
            document.querySelector('.main-container').style.animation = 'shake 0.2s';
            setTimeout(() => document.querySelector('.main-container').style.animation = '', 200);
        }
        updateStats(); // æ›´æ–°è¡€é‡é¡¯ç¤º
        updateBattleUI();
        if (currentEnemy.hp > 0) nextQuestion();
    }

    function winBattle() {
        const goldGain = Math.floor(player.floor * 10 * (1 + player.stats.luck*0.05));
        const expGain = 20;
        
        player.gold += goldGain;
        player.exp += expGain;
        
        if (player.exp >= player.maxExp) {
            player.level++;
            player.exp = 0;
            player.maxExp = Math.floor(player.maxExp * 1.2);
            alert(`æ­å–œå‡ç´šï¼ç­‰ç´šæå‡è‡³ ${player.level}`);
            updateStats();
        }

        player.floor++;
        saveData();
        renderUI();
        nextBattle();
    }

    // --- å­˜æª”ç³»çµ± ---
    function saveData() {
        const data = {
            player: player
        };
        localStorage.setItem('WordHunterSave_V50', JSON.stringify(data));
    }

    function loadData() {
        const raw = localStorage.getItem('WordHunterSave_V50');
        if (raw) {
            const data = JSON.parse(raw);
            // åˆä½µå­˜æª”èˆ‡æ–°çµæ§‹ (é¿å…èˆŠå­˜æª”ç¼ºå°‘ bonusStats å ±éŒ¯)
            player = { ...player, ...data.player };
            
            // æª¢æŸ¥èˆŠè£å‚™çµæ§‹ä¿®æ­£
            player.inventory.forEach(fixItemStruct);
            for(let p in player.equipped) fixItemStruct(player.equipped[p]);
        }
    }
    
    function fixItemStruct(item) {
        if(!item) return;
        if(!item.bonusStats) item.bonusStats = [];
        if(!item.reqLevel) item.reqLevel = item.level || 1;
        if(!item.enhance) item.enhance = 0;
        if(!item.baseStats) {
            // å˜—è©¦å¾èˆŠçµæ§‹æ¢å¾©
            item.baseStats = {};
            if(item.atk) item.baseStats.atk = item.atk;
            if(item.def) item.baseStats.def = item.def;
            if(item.hp) item.baseStats.hp = item.hp;
            if(item.crit) item.baseStats.crit = item.crit;
            if(item.luck) item.baseStats.luck = item.luck;
        }
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>
