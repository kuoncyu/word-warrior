<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­—éˆçµäººï¼šæˆ°æ­Œçµ‚ç«  (V35)</title>
    <script src="moe_data.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Cinzel:wght@700&display=swap');

        :root {
            --bg-dark: #0f0f10;
            --panel-bg: rgba(25, 25, 30, 0.98);
            --primary: #c23616;
            --accent: #fbc531;
            --luck: #00d2d3;
            --text: #f5f6fa;
            --danger: #e74c3c;
            --font-title: 'Cinzel', serif;
            --font-main: 'Noto Serif TC', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text);
            margin: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
            background: radial-gradient(circle at 50% 30%, #1e0505 0%, #000 100%);
        }

        .embers {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: -1;
            background-image: radial-gradient(rgba(194, 54, 22, 0.3) 1px, transparent 1px);
            background-size: 50px 50px; animation: rise 25s linear infinite; opacity: 0.5;
        }
        @keyframes rise { from {transform: translateY(0);} to {transform: translateY(-600px);} }

        .app-container {
            width: 100%; max-width: 550px; height: 100%; max-height: 950px;
            background: var(--panel-bg); border: 2px solid #571a1a;
            box-shadow: 0 0 80px rgba(194, 54, 22, 0.3); position: relative;
            display: flex; flex-direction: column; overflow: hidden;
        }
        @media (min-width: 550px) { .app-container { border-radius: 12px; height: 95vh; } }

        /* UI Components */
        .top-bar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
        .gems { color: var(--accent); font-family: var(--font-title); font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        
        .content { flex: 1; overflow-y: auto; padding: 15px; position: relative; scroll-behavior: smooth; }
        .tab-page { display: none; animation: fadeIn 0.4s; }
        .tab-page.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        .start-btn {
            background: linear-gradient(135deg, #c23616, #8e44ad);
            color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 12px 25px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            font-family: var(--font-title); letter-spacing: 1px; width: 100%;
            box-shadow: 0 0 15px rgba(194, 54, 22, 0.5); border-radius: 4px;
        }
        .start-btn:active { transform: scale(0.96); filter: brightness(0.8); }
        .btn-secondary { background: #34495e; box-shadow: none; border-color: #57606f; }
        .btn-danger { background: #c0392b; box-shadow: 0 0 10px rgba(192, 57, 43, 0.4); border-color: #e74c3c; }

        /* Stats & Equipment */
        .hero-summary { display:flex; align-items:center; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #333; }
        .hero-avatar { font-size: 3.5rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        .hero-info { flex:1; }
        .xp-container { width: 100%; background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top:5px; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #8e44ad, #9b59b6); width: 0%; transition: width 0.5s; }

        .stat-box { background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #333; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        
        .equip-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; 
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333;
        }
        .equip-slot {
            aspect-ratio: 1; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.2s;
        }
        .slot-equipped { border-color: var(--accent); background: rgba(251, 197, 49, 0.1); }
        .slot-icon { font-size: 1.6rem; }
        .slot-name { font-size: 0.6rem; color: #7f8fa6; margin-top: 2px; }

        /* Inventory Items */
        .inv-item { display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 5px; border-left: 3px solid #555; border-radius: 4px; }
        .inv-actions { margin-left: auto; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .btn-action { padding: 6px 10px; border: 1px solid #555; color: white; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 0.75rem; min-width: 60px; }
        .btn-equip { background: #353b48; }

        /* Battle Start Screen */
        .battle-prep-panel {
            text-align: center; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 8px; border: 1px solid #444; margin-top: 10px;
        }
        .monster-rates-table { width: 100%; margin: 15px 0; border-collapse: collapse; font-size: 0.9rem; }
        .monster-rates-table td { padding: 8px; border-bottom: 1px solid #333; text-align: left; }
        .rate-bar-bg { width: 60px; height: 4px; background: #333; display: inline-block; vertical-align: middle; margin-left: 5px; border-radius: 2px; }
        .rate-bar-fill { height: 100%; border-radius: 2px; }

        /* Battle UI */
        .hp-bar-container { width:100%; height:12px; background:#111; border:1px solid #444; border-radius:2px; overflow:hidden; margin-bottom:2px; }
        .hp-fill { height:100%; width:100%; transition:width 0.3s; }
        .timer-container { width: 100%; height: 6px; background: #333; margin-top: 15px; border-radius: 3px; overflow: hidden; }
        .timer-fill { height: 100%; background: #00a8ff; width: 100%; transition: width 1s linear; }

        .quiz-panel { background: rgba(30, 30, 35, 0.95); border: 1px solid #571a1a; padding: 20px; margin-top: 5px; border-radius: 8px; }
        .opt-btn { width: 100%; padding: 14px; margin-bottom: 8px; background: #2f3640; border: 1px solid #57606f; color: #dcdde1; font-size: 1.2rem; cursor: pointer; font-family: "KaiTi"; font-weight: bold; border-radius: 6px; }

        #battle-tools { display:none; justify-content:center; gap:10px; margin-top:15px; flex-wrap: wrap; }
        .tool-btn { flex: 1; padding: 10px; font-size: 0.9rem; background: #34495e; min-width: 80px; }
        .flee-btn { background: #444; border-color: #7f8fa6; color: #a4b0be; flex: 0 0 100%; margin-top: 5px; }

        /* Nav */
        .nav-bar { display: flex; background: #000; border-top: 1px solid #333; height: 60px; }
        .nav-btn { flex: 1; background: none; border: none; color: #555; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
        .nav-btn.active { color: var(--primary); background: rgba(194, 54, 22, 0.1); }

        /* Modal */
        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { background: #1e272e; width: 85%; max-width: 400px; padding: 30px; border: 1px solid var(--primary); text-align: center; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .float-txt { position: absolute; left: 50%; top: 40%; transform: translateX(-50%); font-family: var(--font-title); font-weight:bold; pointer-events: none; animation: popUp 0.8s forwards; z-index: 150; text-shadow: 2px 2px 0 #000; }
        @keyframes popUp { 0%{opacity:0; transform:translate(-50%,0) scale(0.5);} 20%{opacity:1; transform:translate(-50%,-50px) scale(1.5);} 100%{opacity:0; transform:translate(-50%,-100px) scale(1);} }

        #cover-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        
        .pulse-icon { animation: pulse 2s infinite; }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }
    </style>
</head>
<body>

<div class="embers"></div>

<div id="cover-screen">
    <div style="font-size:5rem; margin-bottom: 10px; filter: drop-shadow(0 0 20px var(--primary));" class="pulse-icon">ğŸ”¥</div>
    <div style="font-family: var(--font-title); font-size: 3rem; color: var(--primary); letter-spacing: 3px;">WORD<br>WARRIOR</div>
    <p style="color:#7f8fa6; letter-spacing: 2px;">V35 DYNAMIC WAR THEMES</p>
    <div id="status-text" style="color:#2ecc71; margin: 15px 0;">è¼‰å…¥ä¸­...</div>
    <button class="start-btn" onclick="initGameSafe()">ENTER WORLD</button>
    <div style="margin-top:20px; color:#555; cursor:pointer; text-decoration:underline; font-size:0.8rem;" onclick="hardReset()">é‡ç½®éŠæˆ² (Reset)</div>
</div>

<div class="app-container" id="app-ui" style="display:none;">
    <div class="top-bar">
        <div style="cursor:pointer;" onclick="toggleMute()" id="sound-btn">ğŸ”‡</div>
        <div class="gems">ğŸ’ <span id="ui-gems">0</span></div>
    </div>

    <div id="tab-char" class="content tab-page active">
        <div class="hero-summary">
            <div class="hero-avatar">ğŸ¥·</div>
            <div class="hero-info">
                <div style="font-family:var(--font-title); font-size:1.2rem; color:var(--accent);">HUNTER <span style="font-size:0.8rem; background:#444; padding:2px 6px; border-radius:4px;">Lv.<span id="ui-lvl">1</span></span></div>
                <div class="xp-container"><div class="xp-fill" id="ui-xp-bar"></div></div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">EXP: <span id="ui-xp-text">0/100</span></div>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-row"><span>âš”ï¸ æ”»æ“Š (ATK)</span><span id="stat-atk" style="color:#e74c3c">0</span></div>
            <div class="stat-row"><span>ğŸ›¡ï¸ é˜²ç¦¦ (DEF)</span><span id="stat-def" style="color:#3498db">0</span></div>
            <div class="stat-row"><span>â¤ï¸ ç”Ÿå‘½ (HP)</span><span id="stat-hp" style="color:#2ecc71">0</span></div>
            <div class="stat-row"><span>âš¡ æš´æ“Š (CRIT)</span><span id="stat-crit" style="color:#f1c40f">0%</span></div>
            <div class="stat-row"><span>ğŸ’¨ é–ƒé¿ (DODGE)</span><span id="stat-dodge" style="color:#9b59b6">0%</span></div>
            <div class="stat-row"><span>ğŸ€ å¹¸é‹ (LUCK)</span><span id="stat-luck" style="color:var(--luck)">0%</span></div>
        </div>

        <div class="equip-grid">
            <div class="equip-slot" id="slot-head" onclick="unequip('head')"><div class="slot-icon">â›‘ï¸</div><div class="slot-name">é ­éƒ¨</div></div>
            <div class="equip-slot" id="slot-body" onclick="unequip('body')"><div class="slot-icon">ğŸ‘•</div><div class="slot-name">èº«é«”</div></div>
            <div class="equip-slot" id="slot-gloves" onclick="unequip('gloves')"><div class="slot-icon">ğŸ§¤</div><div class="slot-name">æ‰‹å¥—</div></div>
            <div class="equip-slot" id="slot-legs" onclick="unequip('legs')"><div class="slot-icon">ğŸ‘–</div><div class="slot-name">è¤²å­</div></div>
            <div class="equip-slot" id="slot-feet" onclick="unequip('feet')"><div class="slot-icon">ğŸ‘¢</div><div class="slot-name">é‹å­</div></div>
            <div class="equip-slot" id="slot-accessory" onclick="unequip('accessory')"><div class="slot-icon">ğŸ’</div><div class="slot-name">é£¾å“</div></div>
            <div class="equip-slot" id="slot-weapon" onclick="unequip('weapon')"><div class="slot-icon">âš”ï¸</div><div class="slot-name">æ­¦å™¨</div></div>
            <div class="equip-slot" id="slot-offhand" onclick="unequip('offhand')"><div class="slot-icon">ğŸ›¡ï¸</div><div class="slot-name">é˜²å…·</div></div>
        </div>

        <div id="inventory-list" style="padding-bottom:20px;"></div>
    </div>

    <div id="tab-battle" class="content tab-page">
        <div id="battle-prep-screen">
            <div style="font-size:4rem; text-align:center; margin-bottom:10px;">âš”ï¸</div>
            <div style="font-family:var(--font-title); font-size:1.5rem; text-align:center; color:var(--primary);">HUNTING GROUNDS</div>
            <div style="text-align:center; color:#7f8fa6; font-size:0.8rem; margin-bottom:20px;">æº–å‚™é€²å…¥å±éšªå€åŸŸ</div>
            <div class="battle-prep-panel">
                <div style="color:#fff; font-weight:bold; border-bottom:1px solid #555; padding-bottom:5px;">ğŸ‘¾ å€åŸŸå¨è„…åº¦ (Threat)</div>
                <table class="monster-rates-table" id="monster-rates-list"></table>
            </div>
            <button class="start-btn" onclick="startBattleSequence()">âš”ï¸ é–‹å§‹ç‹©çµ (START)</button>
        </div>

        <div id="battle-active-screen" style="display:none;">
            <div style="text-align:center; margin-top:5px;">
                <div style="font-size:6rem; filter:drop-shadow(0 0 30px #e74c3c); transition:0.2s;" id="boss-sprite">ğŸ‘¹</div>
                <div style="font-family:var(--font-title); color:var(--primary); font-size:1.4rem;">
                    <span id="enemy-name">DEMON</span> <span style="font-size:1rem; color:#aaa;">Lv.<span id="enemy-level">1</span></span>
                </div>
                
                <div class="hp-bar-container"><div id="boss-hp-bar" class="hp-fill" style="background:#c0392b;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-bottom:10px;">
                    <span>ENEMY</span><span id="boss-hp-text"></span>
                </div>

                <div class="hp-bar-container" style="height:8px;"><div id="player-hp-bar" class="hp-fill" style="background:#27ae60;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa;">
                    <span>PLAYER</span><span id="player-hp-text"></span>
                </div>
                <div id="battle-status" style="height:20px; color:#f1c40f; font-size:0.8rem; font-weight:bold; margin-top:5px;"></div>
            </div>

            <div id="quiz-area" style="margin-top:10px;"></div>

            <div id="battle-tools" style="display:flex;">
                <button class="start-btn tool-btn" onclick="usePotion()">ğŸ§ª è£œè¡€ (<span id="btn-potion-count">0</span>)</button>
                <button class="start-btn tool-btn" onclick="useShield()">ğŸ›¡ï¸ è­·ç›¾ (<span id="btn-shield-count">0</span>)</button>
                <button class="start-btn tool-btn flee-btn" onclick="fleeBattle()">ğŸ³ï¸ é€ƒé›¢æˆ°é¬¥</button>
            </div>
        </div>
    </div>

    <div id="tab-gacha" class="content tab-page">
        <div style="text-align:center; padding-top:40px;">
            <div style="font-size:7rem; margin-bottom:20px; filter:drop-shadow(0 0 30px var(--luck)); animation: float 3s infinite;">ğŸ</div>
            <h2 style="font-family:var(--font-title); color:var(--accent);">LUCKY BOX</h2>
            <div style="font-size: 0.9rem; color: var(--luck); margin-bottom: 10px; font-weight: bold;">å¹¸é‹åŠ æˆ: +<span id="gacha-luck-val">0</span>%</div>
            <p style="color:#7f8fa6; margin-bottom:30px; font-size:0.9rem;">100 Gems / Pull<br>é£¾å“å¯æå‡å¹¸é‹ï¼Œå¢åŠ ç²å¾—å‚³èªªè£å‚™æ©Ÿç‡ï¼</p>
            <button class="start-btn" style="background:var(--luck); color:#000;" onclick="pullGacha()">OPEN (100ğŸ’)</button>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('char')">ğŸ‘¤ çµäºº</button>
        <button class="nav-btn" onclick="switchTab('battle')">âš”ï¸ æˆ°é¬¥</button>
        <button class="nav-btn" onclick="switchTab('gacha')">ğŸ’ å¯¶åº«</button>
    </div>

    <div class="modal" id="feedback-modal">
        <div class="modal-box">
            <h2 id="fb-title" style="font-family:var(--font-title); margin:0;">NEXT</h2>
            <div id="fb-word" style="font-size:3rem; font-family:'KaiTi'; margin:15px 0; color:#fff;"></div>
            <div id="fb-pron" style="color:var(--accent); font-size:1.5rem; font-family:'KaiTi'; font-weight:bold;"></div>
            <a id="fb-link" href="#" target="_blank" style="display:block; margin:15px auto; color:#3498db; text-decoration:none;">ğŸ“– è©³ç´°è§£é‡‹</a>
            <button class="start-btn" onclick="nextQuestion()">ä¸‹ä¸€æ³¢æ”»æ“Š</button>
        </div>
    </div>

    <div class="modal" id="battle-result-modal">
        <div class="modal-box">
            <div id="result-icon" style="font-size:4rem; margin-bottom:10px;">ğŸ†</div>
            <h2 id="result-title" style="font-family:var(--font-title); color:#f1c40f; margin:0 0 10px 0; font-size:2rem;">VICTORY</h2>
            <p id="result-msg" style="color:#aaa; font-size:0.9rem;">æˆ°é¬¥çµæŸ</p>
            <div id="loot-info" style="font-size:1.2rem; color:#fff; font-weight:bold; margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; display:none;"></div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="start-btn" id="btn-result-continue" onclick="continueBattle()">âš”ï¸ ç¹¼çºŒç‹©çµ</button>
                <button class="start-btn btn-secondary" onclick="exitBattle()">ğŸ  è¿”å›ç‡Ÿåœ°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Data & Game State ---
    let QUESTIONS = [];
    let activeQuestionPool = [];
    let timerInterval;
    let timeLeft = 30;

    const SLOT_TYPES = ['head', 'body', 'gloves', 'legs', 'feet', 'accessory', 'weapon', 'offhand'];
    const SLOT_CONFIG = {
        head: { icon:'â›‘ï¸', name:'é ­éƒ¨', base:3 },
        body: { icon:'ğŸ‘•', name:'èº«é«”', base:5 },
        gloves: { icon:'ğŸ§¤', name:'æ‰‹å¥—', base:2 },
        legs: { icon:'ğŸ‘–', name:'è¤²å­', base:4 },
        feet: { icon:'ğŸ‘¢', name:'é‹å­', base:2 },
        accessory: { icon:'ğŸ’', name:'é£¾å“', base:2 }, 
        weapon: { icon:'âš”ï¸', name:'æ­¦å™¨', base:10 },
        offhand: { icon:'ğŸ›¡ï¸', name:'é˜²å…·', base:4 }
    };

    let player = { gems: 100, xp: 0, level: 1, inventory: [], equipped: {}, potions: 3, shields: 1 };
    
    // V34 MONSTER DATA
    const MONSTER_DATA = {
        minion: [{n:'å²èŠå§†',i:'ğŸ¦ '},{n:'è¸ç‰›æ€ª',i:'ğŸŒ'},{n:'æ†¤æ€’å°é›',i:'ğŸ¤'},{n:'ç¶ æ¯›èŸ²',i:'ğŸ›'},{n:'å°çŸ³æ€ª',i:'ğŸª¨'},{n:'å¸è¡€è™è ',i:'ğŸ¦‡'},{n:'å¯¶ç®±æ€ª',i:'ğŸ“¦'},{n:'è˜‘è‡äºº',i:'ğŸ„'}],
        small: [{n:'å“¥å¸ƒæ—',i:'ğŸ‘º'},{n:'é‡è±¬æ€ª',i:'ğŸ—'},{n:'éª·é«å£«å…µ',i:'ğŸ’€'},{n:'èœ¥èœ´äºº',i:'ğŸ¦'},{n:'è’é‡ç›œè³Š',i:'ğŸ¥·'},{n:'å¢æ—ç‹¼',i:'ğŸº'},{n:'å·¨é¼ ',i:'ğŸ€'},{n:'æ¼‚æµ®ä¹‹çœ¼',i:'ğŸ‘ï¸'}],
        medium: [{n:'ç™½æ¯›çŒ©çŒ©',i:'ğŸ¦'},{n:'æ²¼æ¾¤å¥³å·«',i:'ğŸ§™â€â™€ï¸'},{n:'é£Ÿäººé­”',i:'ğŸ‘¹'},{n:'é›™é ­è›‡',i:'ğŸ'},{n:'çŸ³åƒé¬¼',i:'ğŸ—¿'},{n:'éµç”²çŠ€ç‰›',i:'ğŸ¦'},{n:'é£ŸäººèŠ±',i:'ğŸŒº'},{n:'å¹½éˆé¨å£«',i:'ğŸ‘»'}],
        miniboss: [{n:'å±±è±¬é¦–é ˜',i:'ğŸ—'},{n:'èµ¤è‰²æƒ¡é¬¼',i:'ğŸ‘¹'},{n:'å·¨å‹èœ˜è››',i:'ğŸ•·ï¸'},{n:'ç¨çœ¼å·¨äºº',i:'ğŸ‘ï¸â€ğŸ—¨ï¸'},{n:'è©›å’’é¨å£«',i:'ğŸ’€'},{n:'æ­»éˆæ³•å¸«',i:'ğŸ§™â€â™‚ï¸'},{n:'ç‰›é ­äºº',i:'ğŸ®'},{n:'æš—å½±åˆºå®¢',i:'ğŸ‘¤'}],
        boss: [{n:'æ·±æ·µæƒ¡éˆ',i:'ğŸ‘»'},{n:'å¸è¡€é¬¼ç‹',i:'ğŸ§›'},{n:'éª¸éª¨å·¨é¾',i:'ğŸ‰'},{n:'æ··æ²Œç‚é­”',i:'ğŸ”¥'},{n:'æ·±æ·µé ˜ä¸»',i:'ğŸ‘¿'},{n:'å¢®è½å¤©ä½¿',i:'ğŸ‘¼'},{n:'é å¤å·¨ç¸',i:'ğŸ¦–'}]
    };

    const MONSTER_TIERS = {
        minion: { label: 'é›œé­šç´š', lvlMod: 0, hpMult: 1, xpMult: 1, color: '#95a5a6', icon: 'ğŸŸ', chance: 40, music: 'minion' },
        small: { label: 'å°æ€ªç´š', lvlMod: 2, hpMult: 1.5, xpMult: 2, color: '#2ecc71', icon: 'ğŸº', chance: 30, music: 'minion' },
        medium: { label: 'ä¸­ç­‰æ€ª', lvlMod: 3, hpMult: 2.5, xpMult: 5, color: '#3498db', icon: 'ğŸ‘¹', chance: 20, music: 'normal' },
        miniboss: { label: 'å°ç‹ç´š', lvlMod: 5, hpMult: 5, xpMult: 15, color: '#9b59b6', icon: 'ğŸ’€', chance: 8, music: 'normal' },
        boss: { label: 'é­”ç‹ç´š', lvlMod: 7, hpMult: 10, xpMult: 50, color: '#e74c3c', icon: 'ğŸ‘‘', chance: 2, music: 'boss' }
    };

    let battle = { active: false, bossHp: 100, maxHp: 100, playerHp: 100, monsterType: 'minion', monsterName: 'Monster', monsterIcon: 'ğŸ‘¹', monsterLvl: 1, shieldTurns: 0 };
    const RARITY = { common: { c:'#95a5a6',m:1,n:'æ™®é€š' }, rare: { c:'#3498db',m:1.5,n:'ç¨€æœ‰' }, epic: { c:'#9b59b6',m:2.5,n:'å²è©©' }, legendary: { c:'#e74c3c',m:4,n:'å‚³èªª' } };
    const ITEM_NAMES = { head:['çš®å¸½','éµç›”','æˆ°è¡“ç›”'], body:['å¸ƒè¡£','é–å­ç”²','ç§˜éŠ€é§'], gloves:['å·¥ä½œæ‰‹å¥—','æˆ°é¬¥æ‹³å¥—','æ³°å¦è­·æ‰‹'], legs:['äºéº»è¤²','è­·è„›ç”²','æš—å½±è­·è…¿'], feet:['è‰é‹','æˆ°é¬¥é´','ç–¾é¢¨é´'], accessory:['å¹¸é‹è‰','æœˆå…‰çŸ³','å‘½é‹ä¹‹è¼ª'], weapon:['éµåŠ','æˆ°æ–§','é›·ç¥éš'], offhand:['æœ¨ç›¾','åœ“ç›¾','è–é¨å£«ç›¾'] };

    // --- Init ---
    window.onload = function() {
        if (typeof window.MOE_DATA_STRING !== 'undefined') {
            parseData(window.MOE_DATA_STRING);
            document.getElementById('status-text').innerText = "âœ… ç³»çµ±å°±ç·’";
        } else {
            document.getElementById('status-text').innerText = "âš ï¸ æ‰¾ä¸åˆ°è³‡æ–™æª”";
            document.getElementById('status-text').style.color = "red";
        }
    };

    function parseData(rawText) {
        const lines = rawText.trim().split('\n');
        let allAnswers = [];
        lines.forEach(line => {
            let parts = line.split('|');
            if(parts.length >= 3) allAnswers.push(parts[2].replace(/[12345]/g, m => ({'1':'','2':'ËŠ','3':'Ë‡','4':'Ë‹','5':'Ë™'}[m])));
        });
        QUESTIONS = lines.map(line => {
            let [t, q, a, oStr] = line.split('|');
            const fix = s => s.replace(/[12345]/g, m => ({'1':'','2':'ËŠ','3':'Ë‡','4':'Ë‹','5':'Ë™'}[m]));
            if(t==='2'){ a=fix(a); } else { q=fix(q); }
            let rawOpts = oStr ? oStr.split(',').map(fix) : [];
            let uniqueOpts = new Set([a, ...rawOpts.filter(o=>o&&o!==a)]);
            while(uniqueOpts.size < 4) uniqueOpts.add(allAnswers[Math.floor(Math.random() * allAnswers.length)]);
            return { t: parseInt(t), q, a, o: Array.from(uniqueOpts).sort(() => Math.random() - 0.5) };
        }).filter(x => x);
    }

    function initGameSafe() {
        if(QUESTIONS.length === 0) { alert("ç„¡é¡Œåº«"); return; }
        document.getElementById('cover-screen').style.display='none';
        document.getElementById('app-ui').style.display='flex';
        AudioEngine.init();
        loadData(); renderPrepScreen(); updateUI();
    }

    function hardReset() { localStorage.removeItem('rpg_v33_save'); location.reload(); }
    function saveData() { localStorage.setItem('rpg_v33_save', JSON.stringify({player, battle})); }
    
    function loadData() { 
        const d=JSON.parse(localStorage.getItem('rpg_v33_save')); 
        if(d && d.player){
            player = {...player, ...d.player};
            if(!player.potions) player.potions = 3;
            if(!player.shields) player.shields = 1;
            battle = d.battle;
            if(battle.active) battle.active = false; 
        }
    }

    function renderPrepScreen() {
        const table = document.getElementById('monster-rates-list');
        table.innerHTML = '';
        for (const [key, m] of Object.entries(MONSTER_TIERS)) {
            const row = document.createElement('tr');
            row.innerHTML = `<td style="color:${m.color}; font-weight:bold; width:35%;"><span style="font-size:1.2rem; margin-right:5px;">${m.icon}</span> ${m.label}</td><td><div style="font-size:0.8rem; color:#aaa;">Lv.${player.level + m.lvlMod}</div></td><td style="text-align:right;"><span style="color:#aaa; font-size:0.8rem;">${m.chance}%</span><div class="rate-bar-bg"><div class="rate-bar-fill" style="width:${m.chance}%; background:${m.color};"></div></div></td>`;
            table.appendChild(row);
        }
    }

    // --- Stats & Items ---
    function getStats() {
        let s = { atk:10, def:0, maxHp:100, crit:5, dodge:5, luck:0 };
        s.atk += player.level * 2; s.maxHp += player.level * 10; s.def += Math.floor(player.level * 0.5);
        SLOT_TYPES.forEach(slot => {
            const item = player.equipped[slot];
            if(item) {
                if(slot === 'weapon') s.atk += item.val;
                else if(slot === 'offhand') s.def += item.val;
                else if(slot === 'gloves') s.crit += Math.floor(item.val/2);
                else if(slot === 'feet') s.dodge += Math.floor(item.val/3);
                else if(slot === 'accessory') s.luck += item.val;
                else { s.def += Math.ceil(item.val*0.5); s.maxHp += item.val*2; }
            }
        });
        return s;
    }

    function createItem(luckyBonus) {
        const slot = SLOT_TYPES[Math.floor(Math.random() * SLOT_TYPES.length)];
        const roll = Math.random() + (luckyBonus * 0.005);
        let rKey = roll > 0.95 ? 'legendary' : roll > 0.80 ? 'epic' : roll > 0.60 ? 'rare' : 'common';
        const rarity = RARITY[rKey]; const config = SLOT_CONFIG[slot];
        let baseVal = config.base; if(slot==='accessory'||slot==='gloves') baseVal=4;
        const val = Math.floor(baseVal * rarity.m * (0.8 + Math.random()*0.5) + (player.level * 0.5));
        const nameList = ITEM_NAMES[slot] || ['è£å‚™'];
        return { id: Date.now()+Math.random(), slot, name: (rKey==='common'?'':rarity.n)+nameList[Math.floor(Math.random()*nameList.length)], rarity: rKey, val, icon: config.icon };
    }

    function pullGacha() {
        if(player.gems < 100) return alert("å¯¶çŸ³ä¸è¶³ (éœ€ 100)");
        player.gems -= 100;
        const item = createItem(getStats().luck);
        player.inventory.push(item);
        AudioEngine.sfx.equip(); saveData(); updateUI();
        alert(`ç²å¾—ï¼š${item.name} (${item.val})`);
    }

    function equip(id) {
        const item = player.inventory.find(x => x.id === id);
        if(!item) return;
        player.inventory = player.inventory.filter(x => x.id !== id);
        if(player.equipped[item.slot]) player.inventory.push(player.equipped[item.slot]);
        player.equipped[item.slot] = item;
        AudioEngine.sfx.equip(); saveData(); updateUI();
    }
    function unequip(slot) {
        if(player.equipped[slot]) {
            player.inventory.push(player.equipped[slot]);
            player.equipped[slot] = null;
            saveData(); updateUI();
        }
    }

    // --- Battle Logic V35 ---
    function startBattleSequence() {
        AudioEngine.init(); 
        document.getElementById('battle-prep-screen').style.display = 'none';
        document.getElementById('battle-active-screen').style.display = 'block';
        if(activeQuestionPool.length === 0) activeQuestionPool = [...QUESTIONS];
        spawnMonster();
    }

    function spawnMonster() {
        const rand = Math.random() * 100;
        let tierKey = 'minion'; let acc = 0;
        for (const [key, data] of Object.entries(MONSTER_TIERS)) {
            acc += data.chance; if (rand <= acc) { tierKey = key; break; }
        }
        const mData = MONSTER_TIERS[tierKey];
        const mLvl = player.level + mData.lvlMod;
        const mBaseHp = 25 * mLvl * mData.hpMult;
        
        const dataList = MONSTER_DATA[tierKey];
        const rMonster = dataList[Math.floor(Math.random() * dataList.length)];
        
        battle = {
            active: true, bossHp: mBaseHp, maxHp: mBaseHp,
            playerHp: battle.playerHp > 0 ? battle.playerHp : getStats().maxHp,
            monsterType: tierKey, 
            monsterName: rMonster.n,
            monsterIcon: rMonster.i,
            monsterLvl: mLvl, shieldTurns: 0
        };
        updateBattleUI(); loadQuestion();
        
        // V35: Play specific music based on tier
        AudioEngine.bgm.play(mData.music);
    }

    function fleeBattle() {
        if(!confirm("ç¢ºå®šè¦é€ƒé›¢å—ï¼Ÿ\n(å°‡æ”¾æ£„æœ¬æ¬¡æˆ°é¬¥çå‹µ)")) return;
        battle.active = false; clearInterval(timerInterval);
        AudioEngine.bgm.stop(); 
        document.getElementById('battle-active-screen').style.display = 'none';
        document.getElementById('battle-prep-screen').style.display = 'block';
    }

    function loadQuestion() {
        if(battle.bossHp <= 0 || battle.playerHp <= 0) return;
        if(activeQuestionPool.length === 0) activeQuestionPool = [...QUESTIONS];
        const idx = Math.floor(Math.random() * activeQuestionPool.length);
        const q = activeQuestionPool.splice(idx, 1)[0]; 

        let qHTML = q.q.replace(/ã€Œ(.*?)ã€/g, '<span style="color:var(--accent); border-bottom:1px solid var(--accent);">$1</span>');
        document.getElementById('quiz-area').innerHTML = `
            <div class="quiz-panel">
                <div style="display:flex; justify-content:space-between; color:#aaa; font-size:0.8rem; margin-bottom:5px;">
                    <span>${q.t===1?'æ³¨éŸ³ â¤ åœ‹å­—':'åœ‹å­— â¤ æ³¨éŸ³'}</span>
                </div>
                <div class="timer-container"><div class="timer-fill" id="timer-bar"></div></div>
                <div style="text-align:right; font-size:0.8rem; color:#aaa; margin-bottom:10px;" id="timer-text">30s</div>
                <div style="text-align:center; font-size:1.8rem; margin:10px 0; min-height:50px; display:flex; align-items:center; justify-content:center;">${qHTML}</div>
                <div>${q.o.map(o=>`<button class="opt-btn" onclick="handleAns(this,'${o}','${q.a}','${q.q}',${q.t})">${o}</button>`).join('')}</div>
            </div>`;
        startTimer(q.q, q.a, q.t);
    }

    function startTimer(qText, ans, type) {
        clearInterval(timerInterval);
        timeLeft = 30;
        const bar = document.getElementById('timer-bar'); const txt = document.getElementById('timer-text');
        timerInterval = setInterval(() => {
            timeLeft--;
            if (bar) bar.style.width = (timeLeft / 30 * 100) + "%";
            if (txt) txt.innerText = timeLeft + "s";
            if(timeLeft<=0) { clearInterval(timerInterval); handleTimeout(qText, ans, type); }
        }, 1000);
    }

    function handleTimeout(qText, ans, type) {
        document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
        AudioEngine.sfx.wrong(); showFloatText("TIME OUT!", "#e74c3c");
        monsterAttack(); updateBattleUI();
        setTimeout(()=>checkWinLoss(false, "", ans, qText, type), 800);
    }

    function handleAns(btn, c, a, qText, type) {
        clearInterval(timerInterval);
        document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
        const correct = c===a; const stats = getStats();
        if(correct) {
            btn.style.background = "#27ae60"; 
            let isCrit = Math.random()*100 < stats.crit;
            let dmg = Math.floor(stats.atk * (isCrit ? 2 : 1));
            battle.bossHp -= dmg;
            AudioEngine.sfx.win(); showFloatText(isCrit ? `CRIT ${dmg}!` : `${dmg}`, isCrit?"#f1c40f":"#fff");
        } else {
            btn.style.background = "#c23616"; monsterAttack();
        }
        if (battle.shieldTurns > 0) battle.shieldTurns--;
        updateBattleUI();
        setTimeout(()=>checkWinLoss(correct, c, a, qText, type), 500);
    }

    function monsterAttack() {
        const stats = getStats();
        if (battle.shieldTurns > 0) { showFloatText("BLOCKED!", "#3498db"); return; } 
        if (Math.random()*100 < stats.dodge) { showFloatText("DODGE!", "#9b59b6"); return; }
        let dmg = Math.max(1, (battle.monsterLvl*6) - Math.floor(stats.def/3));
        battle.playerHp -= dmg;
        AudioEngine.sfx.wrong(); showFloatText(`-${dmg}`, "#e74c3c");
    }

    // --- V35 Unified Battle End Logic ---
    function checkWinLoss(correct, c, a, qText, type) {
        // Condition: Either HP <= 0 triggers end
        if (battle.bossHp <= 0) {
            winBattle();
        } else if (battle.playerHp <= 0) {
            loseBattle();
        } else {
            showFb(correct, c, a, qText, type);
        }
    }

    function winBattle() {
        const mData = MONSTER_TIERS[battle.monsterType];
        let xpGain = mData.xpMult * 10;
        let gemGain = Math.floor(xpGain / 2);
        player.gems += gemGain;
        if(Math.random() > 0.8) { player.potions++; showFloatText("+POTION", "#2ecc71"); }
        addXp(xpGain);
        
        AudioEngine.bgm.stop();
        AudioEngine.sfx.victoryTheme(); 

        // Update Modal for Victory
        document.getElementById('result-icon').innerText = 'ğŸ†';
        document.getElementById('result-title').innerText = 'VICTORY';
        document.getElementById('result-title').style.color = '#f1c40f';
        document.getElementById('result-msg').innerText = `æ“Šæ•—äº† ${battle.monsterName}ï¼`;
        document.getElementById('loot-info').style.display = 'block';
        document.getElementById('loot-info').innerHTML = `XP +${xpGain}<br>ğŸ’ +${gemGain}`;
        document.getElementById('btn-result-continue').innerText = 'âš”ï¸ ç¹¼çºŒç‹©çµ';
        document.getElementById('btn-result-continue').className = 'start-btn';
        document.getElementById('battle-result-modal').style.display = 'flex';
    }

    function loseBattle() {
        AudioEngine.bgm.stop();
        AudioEngine.sfx.wrong(); // Play simple defeat sound or silence

        // Update Modal for Defeat
        document.getElementById('result-icon').innerText = 'ğŸ’€';
        document.getElementById('result-title').innerText = 'DEFEAT';
        document.getElementById('result-title').style.color = '#e74c3c';
        document.getElementById('result-msg').innerText = `ä½ è¢« ${battle.monsterName} æ“Šå€’äº†...`;
        document.getElementById('loot-info').style.display = 'none'; // No loot
        
        // Change Continue button to "Revive/Retry"
        document.getElementById('btn-result-continue').innerText = 'ğŸ”¥ å†æ¬¡æŒ‘æˆ° (æ»¿è¡€)';
        document.getElementById('btn-result-continue').className = 'start-btn btn-danger';
        
        document.getElementById('battle-result-modal').style.display = 'flex';
    }
    
    function continueBattle() {
        document.getElementById('battle-result-modal').style.display = 'none';
        const stats = getStats();
        
        // If coming from Defeat (HP<=0), Full Heal. If Victory, partial heal.
        if (battle.playerHp <= 0) {
            battle.playerHp = stats.maxHp;
        } else {
            battle.playerHp = Math.min(stats.maxHp, battle.playerHp + Math.floor(stats.maxHp * 0.2));
        }
        
        spawnMonster();
    }

    function exitBattle() {
        document.getElementById('battle-result-modal').style.display = 'none';
        battle.active = false;
        // Reset HP if leaving after death
        if (battle.playerHp <= 0) battle.playerHp = getStats().maxHp;
        
        document.getElementById('battle-active-screen').style.display = 'none';
        document.getElementById('battle-prep-screen').style.display = 'block';
        AudioEngine.bgm.stop();
        saveData();
    }

    function addXp(amount) {
        player.xp += amount;
        let req = player.level * 100;
        if(player.xp >= req) { player.xp -= req; player.level++; showFloatText("LEVEL UP!", "#f1c40f"); battle.playerHp = getStats().maxHp; }
        saveData(); updateUI();
    }

    function usePotion() {
        if(player.potions > 0) { player.potions--; const s=getStats(); battle.playerHp = Math.min(s.maxHp, battle.playerHp + Math.floor(s.maxHp * 0.5)); showFloatText("+HP", "#2ecc71"); AudioEngine.sfx.equip(); updateBattleUI(); updateUI(); }
    }
    function useShield() {
        if(player.shields > 0) { player.shields--; battle.shieldTurns = 2; showFloatText("SHIELD!", "#3498db"); AudioEngine.sfx.equip(); updateBattleUI(); updateUI(); }
    }

    // --- UI Update ---
    function updateBattleUI() {
        document.getElementById('boss-hp-bar').style.width = Math.max(0,(battle.bossHp/battle.maxHp)*100)+'%';
        document.getElementById('boss-hp-text').innerText = Math.ceil(battle.bossHp)+"/"+Math.ceil(battle.maxHp);
        const stats = getStats();
        document.getElementById('player-hp-bar').style.width = Math.max(0,(battle.playerHp/stats.maxHp)*100)+'%';
        document.getElementById('player-hp-text').innerText = Math.ceil(battle.playerHp)+"/"+stats.maxHp;
        
        if(battle.active) {
            const mData = MONSTER_TIERS[battle.monsterType];
            document.getElementById('boss-sprite').innerText = battle.monsterIcon;
            document.getElementById('boss-sprite').style.filter = `drop-shadow(0 0 30px ${mData.color})`;
            document.getElementById('boss-hp-bar').style.background = mData.color;
            document.getElementById('enemy-name').innerText = battle.monsterName;
            document.getElementById('enemy-name').style.color = mData.color;
            document.getElementById('enemy-level').innerText = battle.monsterLvl;
            document.getElementById('btn-potion-count').innerText = player.potions;
            document.getElementById('btn-shield-count').innerText = player.shields;
            document.getElementById('battle-status').innerText = battle.shieldTurns > 0 ? `ğŸ›¡ï¸ ç„¡æ•µ (${battle.shieldTurns})` : "";
        }
    }

    function updateUI() {
        const s = getStats();
        document.getElementById('ui-gems').innerText = player.gems;
        document.getElementById('ui-lvl').innerText = player.level;
        document.getElementById('ui-xp-bar').style.width = ((player.xp / (player.level*100))*100) + '%';
        document.getElementById('ui-xp-text').innerText = `${player.xp}/${player.level*100}`;
        document.getElementById('stat-atk').innerText = s.atk; document.getElementById('stat-def').innerText = s.def;
        document.getElementById('stat-hp').innerText = s.maxHp; document.getElementById('stat-crit').innerText = s.crit+'%';
        document.getElementById('stat-dodge').innerText = s.dodge+'%'; document.getElementById('stat-luck').innerText = s.luck+'%';
        document.getElementById('gacha-luck-val').innerText = s.luck;
        document.getElementById('inv-potion').innerText = player.potions; document.getElementById('inv-shield').innerText = player.shields;

        SLOT_TYPES.forEach(slot => {
            const el = document.getElementById(`slot-${slot}`); const item = player.equipped[slot];
            if(item) {
                el.classList.add('slot-equipped'); el.style.borderColor = RARITY[item.rarity].c;
                el.querySelector('.slot-icon').innerText = item.icon; el.querySelector('.slot-name').innerText = item.name; el.querySelector('.slot-name').style.color = RARITY[item.rarity].c;
            } else {
                el.classList.remove('slot-equipped'); el.style.borderColor = '#444';
                el.querySelector('.slot-icon').innerText = SLOT_CONFIG[slot].icon; el.querySelector('.slot-name').innerText = SLOT_CONFIG[slot].name; el.querySelector('.slot-name').style.color = '#7f8fa6';
            }
        });
        const l = document.getElementById('inventory-list'); l.innerHTML = '';
        if(player.inventory.length === 0) l.innerHTML = '<div style="color:#555; text-align:center;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>';
        player.inventory.forEach(i => {
            const d = document.createElement('div'); d.className = 'inv-item'; d.style.borderLeftColor = RARITY[i.rarity].c;
            d.innerHTML = `<div style="font-size:1.5rem; margin-right:10px;">${i.icon}</div><div style="flex:1;"><div style="color:${RARITY[i.rarity].c}; font-weight:bold;">${i.name}</div><div style="font-size:0.7rem; color:#aaa;">${SLOT_CONFIG[i.slot].name} (+${i.val})</div></div><div class="inv-actions"><button class="btn-action btn-equip" onclick="equip(${i.id})">è£å‚™</button></div>`;
            l.appendChild(d);
        });
    }

    function showFb(correct, c, a, qText, type) {
        const m=document.getElementById('feedback-modal'), t=document.getElementById('fb-title'), w=document.getElementById('fb-word'), p=document.getElementById('fb-pron');
        t.innerText = correct ? "VICTORY" : "NEXT"; t.style.color = correct ? "#2ecc71" : "#aaa";
        let search = type===1 ? a : qText.replace(/ã€Œ|ã€/g,'');
        w.innerText = search; p.innerText = type===1 ? qText : a;
        document.getElementById('fb-link').href = `https://dict.revised.moe.edu.tw/search.jsp?md=1&word=${encodeURIComponent(search)}`;
        m.style.display='flex';
    }
    
    function nextQuestion() { document.getElementById('feedback-modal').style.display='none'; loadQuestion(); }
    function switchTab(t) {
        document.querySelectorAll('.tab-page').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function showFloatText(txt,col){const el=document.createElement('div');el.className='float-txt';el.innerText=txt;el.style.color=col;document.body.appendChild(el);setTimeout(()=>el.remove(),800);}
    
    // --- V35 DYNAMIC AUDIO ENGINE ---
    const AudioEngine = {
        ctx: null, isMuted: false, intervalId: null,
        init: function() { if(!this.ctx) { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); } },
        toggle: function() { this.isMuted=!this.isMuted; document.getElementById('sound-btn').innerText=this.isMuted?'ğŸ”‡':'ğŸ”Š'; if(this.isMuted) this.bgm.stop(); else if(battle.active) { 
            const mData = MONSTER_TIERS[battle.monsterType];
            this.bgm.play(mData.music); 
        }},
        // Basic Tone
        playTone: function(freq, type, dur, vol=0.1) { 
            if(this.isMuted || !this.ctx) return; 
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); 
            osc.type = type; osc.frequency.value = freq; 
            gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur); 
            osc.connect(gain); gain.connect(this.ctx.destination); 
            osc.start(); osc.stop(this.ctx.currentTime + dur); 
        },
        // Noise (Snare/Hat)
        playNoise: function(dur, vol) { 
            if(this.isMuted || !this.ctx) return; 
            const b = this.ctx.createBuffer(1, this.ctx.sampleRate * dur, this.ctx.sampleRate); const d = b.getChannelData(0); 
            for (let i = 0; i < b.length; i++) d[i] = Math.random() * 2 - 1; 
            const src = this.ctx.createBufferSource(); src.buffer = b; 
            const gain = this.ctx.createGain(); gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur); 
            src.connect(gain); gain.connect(this.ctx.destination); src.start(); 
        },
        // Kick Drum
        playKick: function() { 
            if(this.isMuted || !this.ctx) return; 
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); 
            osc.frequency.setValueAtTime(150, this.ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5); 
            gain.gain.setValueAtTime(0.5, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5); 
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + 0.5); 
        },
        sfx: { 
            win:()=>{AudioEngine.playTone(600,'sine',0.3); AudioEngine.playTone(900,'sine',0.3,0.1,0.2);}, 
            wrong:()=>{AudioEngine.playTone(100,'sawtooth',0.4)}, 
            equip:()=>{AudioEngine.playTone(1200,'triangle',0.1)},
            victoryTheme: () => { if(AudioEngine.isMuted) return; [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => AudioEngine.playTone(f, 'square', 0.4, 0.2), i*150)); }
        },
        bgm: {
            step: 0,
            currentTheme: 'normal',
            // Theme Definitions
            themes: {
                minion: { // Fast, Simple, Light
                    bass: [110, 110, 98, 98, 110, 110, 130, 98],
                    arp: [440, 554, 659, 880],
                    speed: 100, // ms per step (Faster)
                    bassType: 'triangle'
                },
                normal: { // Epic, Driving, Minor
                    bass: [65.4, 65.4, 65.4, 65.4, 49.0, 49.0, 49.0, 49.0, 65.4, 65.4, 65.4, 65.4, 43.6, 43.6, 43.6, 43.6],
                    arp: [261, 311, 392, 523],
                    speed: 125,
                    bassType: 'sawtooth'
                },
                boss: { // Slow, Heavy, Dark
                    bass: [36.7, 36.7, 36.7, 36.7, 34.6, 34.6, 34.6, 34.6, 36.7, 36.7, 36.7, 36.7, 41.2, 41.2, 32.7, 32.7],
                    arp: [174, 207, 246, 293], // Diminished/Dissonant
                    speed: 150, // Slower (Doom metal feel)
                    bassType: 'sawtooth'
                }
            },
            play: function(themeName) {
                if(AudioEngine.isMuted) return;
                this.stop();
                this.currentTheme = themeName || 'normal';
                const theme = this.themes[this.currentTheme];
                
                AudioEngine.intervalId = setInterval(() => {
                    if(!AudioEngine.ctx) return;
                    const s = AudioEngine.bgm.step;
                    
                    // Kick: 4-on-the-floor
                    if (s % 4 === 0) AudioEngine.playKick();
                    
                    // Snare/Hat
                    if (s % 8 === 4) AudioEngine.playNoise(0.2, 0.15); // Snare
                    if (s % 2 === 0) AudioEngine.playNoise(0.05, 0.05); // Hat

                    // Bass Line
                    if (s % 2 === 0) {
                        const noteIdx = Math.floor(s / 2) % theme.bass.length;
                        // For Boss, make bass louder/heavier
                        const vol = themeName === 'boss' ? 0.3 : 0.2;
                        AudioEngine.playTone(theme.bass[noteIdx], theme.bassType, 0.2, vol);
                    }

                    // Arpeggio
                    let arpFreq = theme.arp[s % 4];
                    if (Math.floor(s/16)%2 === 1) arpFreq *= 1.5; // Pitch shift variant
                    // Minion theme uses sine for "cute/retro", others triangle
                    const leadType = themeName === 'minion' ? 'sine' : 'triangle';
                    AudioEngine.playTone(arpFreq, leadType, 0.1, 0.05);

                    AudioEngine.bgm.step++;
                }, theme.speed);
            },
            stop: function() { if(AudioEngine.intervalId) { clearInterval(AudioEngine.intervalId); AudioEngine.intervalId = null; AudioEngine.bgm.step = 0; } }
        }
    };
    function toggleMute() { AudioEngine.toggle(); }
</script>
</body>
</html>
